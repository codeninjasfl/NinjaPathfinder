<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Code Ninjas – Ninja Path Finder</title>
  <meta name="theme-color" content="#2563eb" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

    :root {
      --bg1:#0ea5e9; --bg2:#2563eb;
      --card:#ffffff; --ink:#0f172a; --muted:#334155; /* Darkened for better contrast */
      --brand:#2563eb; --border:#cbd5e1; /* Darkened for better definition */
      --highlight:#eff6ff;
      --radius:20px;
      --shadow:0 20px 40px -10px rgba(0, 0, 0, 0.2);
    }
    * { box-sizing:border-box; }
    html, body {
      margin:0; padding:0; min-height:100%;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      background-attachment:fixed;
      color:var(--ink);
      -webkit-font-smoothing: antialiased;
    }
    /* Center content vertically and horizontally */
    .wrap { min-height:100svh; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px 16px; }
    
    header { color:#fff; text-align:center; margin:0 0 24px; width: 100%; max-width: 700px; }
    header .brand { display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom: 12px; }
    header img.logo { height:42px; width:auto; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.1)); transition: transform 0.3s ease; }
    header img.logo:hover { transform: scale(1.05); }
    header h1 { margin:0; font-size:clamp(22px,4vw,30px); font-weight:800; letter-spacing: -0.02em; text-shadow: 0 2px 4px rgba(0,0,0,0.1); line-height: 1.2; }
    header p { margin:8px 0 0; font-size:15px; color:#ffffff; line-height: 1.5; font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }

    .card {
      width:100%; max-width:720px;
      background:var(--card);
      border-radius:var(--radius);
      padding:32px;
      box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,0.2);
      position: relative;
    }
    .hidden { display:none !important; }

    /* Updated to Flexbox for better wrapping */
    .prestart-grid {
      display:flex;
      flex-wrap: wrap;
      gap:12px;
      align-items:center;
      margin-top:20px;
    }
    .prestart-grid input,
    .prestart-grid select,
    .step-input {
      padding:12px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      font-size:16px; /* 16px prevents iOS zoom */
      transition: all 0.2s ease;
      background: #f8fafc;
      font-family: inherit;
      color: var(--ink);
    }
    .prestart-grid input::placeholder,
    .step-input::placeholder {
      color: #64748b;
      opacity: 1;
    }
    .prestart-grid input,
    .prestart-grid select {
      flex: 1 1 220px; /* Flex grow ensures full width if wrapped */
    }
    .prestart-grid input:focus,
    .prestart-grid select:focus,
    .step-input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px var(--highlight);
      background: #fff;
    }
    .step-input { 
      width: 100%;
      margin-top: 12px; 
    }
    
    /* Centered Start Button - constrained width */
    #startQuizBtn {
      flex: 1 1 100%;
      width: 100%;
      max-width: 320px; /* Wider but constrained */
      margin: 8px auto 0;
      display: block;
    }

    .prestart-label { font-size:15px; color:var(--ink); text-align: center; font-weight: 600; margin-bottom: 4px; }
    
    @media (max-width:600px) {
      .card { padding:24px 20px 80px; } /* Extra bottom padding for sticky actions */
      .wrap { padding: 12px; justify-content: flex-start; }
      header { margin-top: 10px; }
    }

    .topbar { display:flex; align-items:center; gap:12px; margin:0 0 24px; }
    .progress { flex:1; height:6px; background:#e2e8f0; border-radius:999px; overflow:hidden; }
    .bar { height:100%; width:0; background:var(--brand); transition:width .4s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 999px; }
    .count { font-size:13px; font-weight:700; color:var(--muted); min-width:90px; text-align:right; }

    .step { display:none; }
    .step.active { display:block; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes slideUp { from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:none;} }
    
    fieldset { border:0; margin:0; padding:0; }
    legend { font-weight:800; margin:0 0 16px; font-size:20px; color:var(--ink); line-height: 1.3; letter-spacing: -0.01em; }
    .hint { color:var(--muted); font-size:14px; margin:6px 0 0; font-weight: 500; display: block; }

    /* Updated to Flexbox for button scaling */
    .opts {
      display:flex;
      flex-wrap: wrap;
      gap:10px;
    }
    label.opt {
      flex: 1 1 200px; /* Flex grow allows buttons to stretch */
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:14px;
      border-radius:12px;
      border:2px solid transparent;
      background:#f8fafc;
      font-size:15px;
      line-height:1.4;
      cursor:pointer;
      transition: all 0.15s ease;
      color: var(--ink);
      font-weight: 500;
      position: relative;
    }
    label.opt:hover {
      background: #f1f5f9;
      transform: translateY(-1px);
      border-color: #cbd5e1;
    }
    label.opt:has(input:checked) {
      background: var(--highlight);
      border-color: #93c5fd;
      color: var(--brand);
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
    }
    label.opt input {
      margin-top:2px;
      accent-color:var(--brand);
      width:18px; height:18px;
      flex-shrink: 0;
    }
    
    .actions {
      display:flex; justify-content:space-between; gap:12px; margin-top:28px;
    }
    .actions.sticky {
      position:sticky; bottom:0;
      margin: 28px -32px -32px;
      padding: 16px 32px 24px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(8px);
      border-top: 1px solid var(--border);
      border-radius: 0 0 var(--radius) var(--radius);
      z-index: 10;
    }
    @media (max-width: 600px) {
       .actions.sticky { margin: 24px -20px -80px; padding: 16px 20px 32px; border-radius: 0 0 var(--radius) var(--radius); }
    }

    .btn {
      appearance:none; border-radius:12px; padding:12px 24px;
      font-weight:700; font-size:15px; border:none;
      background:#e2e8f0; color:#334155; cursor:pointer; min-height:46px;
      transition: all 0.2s ease;
      display: inline-flex; align-items: center; justify-content: center;
    }
    .btn:hover:not(:disabled) { background: #cbd5e1; color: var(--ink); transform: translateY(-1px); }
    .btn.primary { background:var(--brand); color:#ffffff; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25); }
    .btn.primary:hover:not(:disabled) { background: #1d4ed8; transform: translateY(-1px); box-shadow: 0 6px 16px rgba(37, 99, 235, 0.35); }
    .btn:disabled { opacity:.6; cursor:not-allowed; transform: none !important; box-shadow: none !important; }

    #result { display:none; }
    #personaTitle { text-align:center; margin:0 0 8px; font-size:24px; font-weight:800; letter-spacing: -0.02em; color: var(--brand); }
    #personaBlurb { text-align:center; color:var(--ink); margin:0 auto 20px; font-size:15px; line-height: 1.5; max-width: 600px; }
    #recTitle { text-align:center; margin:28px 0 8px; font-size:20px; font-weight:800; }
    #recBlurb { text-align:center; color:var(--muted); margin:0 auto 16px; font-size:14px; max-width: 580px; }
    
    #recPoints { 
        background: #f8fafc; 
        padding: 20px 20px 20px 40px; 
        border-radius: 16px; 
        margin: 20px 0; 
        border: 1px solid var(--border);
    }
    #recPoints li { margin-bottom:8px; font-size:15px; line-height: 1.5; color: var(--ink); }
    #recPoints li::marker { color: var(--brand); font-weight: bold; }

    #funFact { 
        margin-top:20px; padding:20px; border-radius:16px; 
        border:1px solid #86efac; background:#f0fdf4; 
        font-size:14px; line-height: 1.5; color: #14532d;
    }
    #funFact strong { display:block; margin-bottom:4px; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: #15803d; font-weight: 800; }

    #stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:10px; margin-top:20px; }
    .stat { 
        padding:14px; border-radius:12px; border:1px solid var(--border); 
        text-align:center; background: #fff; transition: transform 0.2s;
    }
    .stat:hover { transform: translateY(-2px); border-color: #93c5fd; }
    .stat h3 { margin:0; font-size:16px; font-weight:800; color:var(--brand); }
    .stat p { margin:4px 0 0; color:var(--muted); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.02em; }

    .center { text-align:center; }
    .hint.center { margin-top:20px; font-size: 14px; max-width: 500px; margin-inline: auto; line-height: 1.5; color: var(--ink); }

    /* LOADING SCREEN */
    #loading { padding: 50px 0; text-align: center; }
    #loadingTitle {
      font-size:22px;
      font-weight:800;
      margin:0 0 10px;
      color: var(--brand);
      animation:pulse 2s ease-in-out infinite;
    }
    #loadingSub {
      font-size:15px;
      color:var(--muted);
      margin:0;
      animation:loadingText 2.2s ease-in-out infinite;
    }
    .spinner {
      width:42px;
      height:42px;
      border-radius:999px;
      border:3px solid #e2e8f0;
      border-top-color:var(--brand);
      margin:28px auto 0;
      animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
    @keyframes pulse {
      0% { transform:scale(1); opacity:0.9; }
      50% { transform:scale(1.03); opacity:1; }
      100% { transform:scale(1); opacity:0.9; }
    }
    @keyframes loadingText {
      0% { opacity:0; transform:translateY(4px); }
      20% { opacity:1; transform:translateY(0); }
      80% { opacity:1; transform:translateY(0); }
      100% { opacity:0; transform:translateY(-3px); }
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <img class="logo" src="https://www.codeninjas.com/hubfs/Group%201.svg" alt="Code Ninjas" onerror="this.style.display='none'">
    </div>
    <h1>Find the Right Path for Your Ninja</h1>
    <p>Answer a few quick questions to match your child with the perfect Code Ninjas program.</p>
  </header>

  <!-- PRE-START -->
  <section id="prestart" class="card" aria-label="Parent details">
    <div class="prestart-label">Start by telling us who you are and which center you're visiting.</div>
    <div class="prestart-grid">
      <input id="parentFirst" placeholder="Parent first name" autocomplete="given-name">
      <input id="parentLast" placeholder="Parent last name" autocomplete="family-name">
      <!-- Email removed as requested -->
      <select id="location" aria-label="Location">
        <option value="">Select location</option>
        <option value="Aventura">Aventura</option>
        <option value="Cooper City">Cooper City</option>
        <option value="Weston">Weston</option>
      </select>
      <button id="startQuizBtn" class="btn primary" type="button" disabled>Start Quiz ▶</button>
    </div>
    <div class="hint" style="text-align:center; margin-top:12px;">We'll use this to share your child's personalized program match with your chosen center.</div>
  </section>

  <!-- WIZARD -->
  <section id="wizard" class="card hidden" aria-live="polite">
    <div class="topbar" aria-hidden="true">
      <div class="progress"><div id="bar" class="bar"></div></div>
      <div class="count"><span id="qnum">1</span> / <span id="qtotal">1</span> questions</div>
    </div>

    <!-- Q1: Age -->
    <div class="step" data-step-id="q1">
      <fieldset>
        <legend id="ageLegend">How old is your child?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="age" value="5-7"> 5–7</label>
          <label class="opt"><input type="radio" name="age" value="8-10"> 8–10</label>
          <label class="opt"><input type="radio" name="age" value="11-13"> 11–13</label>
          <label class="opt"><input type="radio" name="age" value="14+"> 14+</label>
        </div>
      </fieldset>
    </div>

    <!-- PATH 1: JR (5–7) -->
    <div class="step" data-step-id="q2A" data-show-if="age=5-7">
      <fieldset>
        <legend>Which of these best describe your child? <span class="hint">Choose up to 2</span></legend>
        <div class="opts">
          <label class="opt"><input type="checkbox" name="traits5" value="Curious"> Curious</label>
          <label class="opt"><input type="checkbox" name="traits5" value="Creative"> Creative</label>
          <label class="opt"><input type="checkbox" name="traits5" value="Shy"> Shy</label>
          <label class="opt"><input type="checkbox" name="traits5" value="Energetic"> Energetic</label>
          <label class="opt"><input type="checkbox" name="traits5" value="Observant"> Observant</label>
          <label class="opt"><input type="checkbox" name="traits5" value="Imaginative"> Imaginative</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q3A" data-show-if="age=5-7">
      <fieldset>
        <legend>What kind of play do they enjoy most?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="play5" value="Building"> Building (blocks, Legos, etc.)</label>
          <label class="opt"><input type="radio" name="play5" value="Imaginative"> Imaginative or pretend play</label>
          <label class="opt"><input type="radio" name="play5" value="Games"> Games on a tablet or device</label>
          <label class="opt"><input type="radio" name="play5" value="Arts"> Arts & crafts</label>
          <label class="opt"><input type="radio" name="play5" value="Outdoor"> Outdoor or active play</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q4A" data-show-if="age=5-7">
      <fieldset>
        <legend>When something doesn’t work right away, they usually…</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="grit5" value="Keeps trying"> Keep trying</label>
          <label class="opt"><input type="radio" name="grit5" value="Asks for help"> Ask for help</label>
          <label class="opt"><input type="radio" name="grit5" value="Frustrated"> Get frustrated</label>
          <label class="opt"><input type="radio" name="grit5" value="Move on"> Move on quickly</label>
        </div>
      </fieldset>
    </div>

    <!-- PATH 2: 8–10 -->
    <div class="step" data-step-id="q2B" data-show-if="age=8-10">
      <fieldset>
        <legend>Which traits best describe your child? <span class="hint">Choose up to 2</span></legend>
        <div class="opts">
          <label class="opt"><input type="checkbox" name="traits8" value="Curious"> Curious</label>
          <label class="opt"><input type="checkbox" name="traits8" value="Creative"> Creative</label>
          <label class="opt"><input type="checkbox" name="traits8" value="Competitive"> Competitive</label>
          <label class="opt"><input type="checkbox" name="traits8" value="Social"> Social</label>
          <label class="opt"><input type="checkbox" name="traits8" value="Focused"> Focused</label>
          <label class="opt"><input type="checkbox" name="traits8" value="Distracted"> Easily distracted</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q3B" data-show-if="age=8-10">
      <fieldset>
        <legend>How does your child learn best?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="learn8" value="Hands-on"> Hands-on</label>
          <label class="opt"><input type="radio" name="learn8" value="Visual"> Visual examples</label>
          <label class="opt"><input type="radio" name="learn8" value="Listening"> Listening</label>
          <label class="opt"><input type="radio" name="learn8" value="With friends"> With friends</label>
          <label class="opt"><input type="radio" name="learn8" value="Step-by-step"> Step-by-step instructions</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q4B" data-show-if="age=8-10">
      <fieldset>
        <legend>How do they feel about school and learning?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="school8" value="Loves learning"> Loves learning</label>
          <label class="opt"><input type="radio" name="school8" value="Likes when fun"> Likes it when it’s fun</label>
          <label class="opt"><input type="radio" name="school8" value="Bored"> Gets bored easily</label>
          <label class="opt"><input type="radio" name="school8" value="Struggles focus"> Struggles to stay focused</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q4B-1" data-show-if="school8=Bored,Struggles focus">
      <fieldset>
        <legend>What usually helps them re-engage?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="reengage8" value="Encouragement"> Encouragement from adults</label>
          <label class="opt"><input type="radio" name="reengage8" value="Competition"> Friendly competition</label>
          <label class="opt"><input type="radio" name="reengage8" value="Rewards"> Rewards or milestones</label>
          <label class="opt"><input type="radio" name="reengage8" value="Freedom"> Freedom to do it their way</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q5B" data-show-if="age=8-10">
      <fieldset>
        <legend>How confident are they with technology?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="tech8" value="Beginner"> Beginner</label>
          <label class="opt"><input type="radio" name="tech8" value="Comfortable"> Comfortable</label>
          <label class="opt"><input type="radio" name="tech8" value="Advanced"> Advanced</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q5B-1" data-show-if="tech8=Advanced">
      <fieldset>
        <legend>What have they tried so far?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="tried8" value="Roblox/Minecraft"> Minecraft mods or Roblox Studio</label>
          <label class="opt"><input type="radio" name="tried8" value="Scratch"> Scratch / block coding</label>
          <label class="opt"><input type="radio" name="tried8" value="Robotics"> Robotics kits</label>
          <label class="opt"><input type="radio" name="tried8" value="Interested"> Not yet, but very interested</label>
        </div>
      </fieldset>
    </div>

    <!-- PATH 3: 11–13 -->
    <div class="step" data-step-id="q2C" data-show-if="age=11-13">
      <fieldset>
        <legend>Which traits best describe your child? <span class="hint">Choose up to 2</span></legend>
        <div class="opts">
          <label class="opt"><input type="checkbox" name="traits11" value="Creative"> Creative</label>
          <label class="opt"><input type="checkbox" name="traits11" value="Analytical"> Analytical</label>
          <label class="opt"><input type="checkbox" name="traits11" value="Competitive"> Competitive</label>
          <label class="opt"><input type="checkbox" name="traits11" value="Independent"> Independent</label>
          <label class="opt"><input type="checkbox" name="traits11" value="Team-player"> Team-player</label>
          <label class="opt"><input type="checkbox" name="traits11" value="Curious"> Curious</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q3C" data-show-if="age=11-13">
      <fieldset>
        <legend>When faced with a challenge, they usually…</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="challenge11" value="Persist"> Keep trying</label>
          <label class="opt"><input type="radio" name="challenge11" value="Research"> Research / experiment</label>
          <label class="opt"><input type="radio" name="challenge11" value="Frustrated"> Get frustrated easily</label>
          <label class="opt"><input type="radio" name="challenge11" value="Avoid"> Avoid difficult tasks</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q4C" data-show-if="age=11-13">
      <fieldset>
        <legend>How do they feel about school?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="school11" value="Motivated"> Motivated and focused</label>
          <label class="opt"><input type="radio" name="school11" value="Bored"> Does fine but gets bored</label>
          <label class="opt"><input type="radio" name="school11" value="Struggles"> Struggles to stay focused</label>
          <label class="opt"><input type="radio" name="school11" value="Disengaged"> Disengaged from classes</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q4C-1" data-show-if="school11=Bored,Disengaged">
      <fieldset>
        <legend>What would help them enjoy learning more?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="enjoy11" value="Projects"> Real-world projects</label>
          <label class="opt"><input type="radio" name="enjoy11" value="Freedom"> Freedom to create</label>
          <label class="opt"><input type="radio" name="enjoy11" value="Tech/Games"> Using tech and games</label>
          <label class="opt"><input type="radio" name="enjoy11" value="Peers"> Working with peers</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q5C" data-show-if="age=11-13">
      <fieldset>
        <legend>How comfortable are they with technology?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="tech11" value="Beginner"> Beginner</label>
          <label class="opt"><input type="radio" name="tech11" value="Skilled"> Fairly skilled</label>
          <label class="opt"><input type="radio" name="tech11" value="Advanced"> Advanced (self-driven)</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q5C-1" data-show-if="tech11=Advanced">
      <fieldset>
        <legend>Would they enjoy helping others or leading projects?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="leader11" value="Yes"> Yes</label>
          <label class="opt"><input type="radio" name="leader11" value="Maybe"> Maybe</label>
          <label class="opt"><input type="radio" name="leader11" value="No"> Not right now</label>
        </div>
      </fieldset>
    </div>

    <!-- PATH 4: 14+ -->
    <div class="step" data-step-id="q2D" data-show-if="age=14+">
      <fieldset>
        <legend>What best describes what motivates your teen?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="motivate14" value="Competition"> Competition & clear goals</label>
          <label class="opt"><input type="radio" name="motivate14" value="Recognition"> Recognition & achievements</label>
          <label class="opt"><input type="radio" name="motivate14" value="Curiosity"> Curiosity & learning</label>
          <label class="opt"><input type="radio" name="motivate14" value="Careers"> Preparing for careers</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q3D" data-show-if="age=14+">
      <fieldset>
        <legend>Which areas are they most interested in? <span class="hint">Choose up to 2</span></legend>
        <div class="opts">
          <label class="opt"><input type="checkbox" name="interest14" value="Game dev"> Game development</label>
          <label class="opt"><input type="checkbox" name="interest14" value="Robotics"> Robotics / engineering</label>
          <label class="opt"><input type="checkbox" name="interest14" value="AI"> AI & automation</label>
          <label class="opt"><input type="checkbox" name="interest14" value="Content"> Content creation / design</label>
          <label class="opt"><input type="checkbox" name="interest14" value="Mentor"> Tutoring / mentoring younger students</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q4D" data-show-if="age=14+">
      <fieldset>
        <legend>How confident are they with technology?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="tech14" value="Beginner"> Beginner</label>
          <label class="opt"><input type="radio" name="tech14" value="Intermediate"> Intermediate</label>
          <label class="opt"><input type="radio" name="tech14" value="Advanced"> Advanced</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q4D-1" data-show-if="tech14=Advanced">
      <fieldset>
        <legend>Are they interested in tech certifications or careers?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="career14" value="Yes"> Yes</label>
          <label class="opt"><input type="radio" name="career14" value="Somewhat"> Somewhat</label>
          <label class="opt"><input type="radio" name="career14" value="Not yet"> Not yet</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q5D" data-show-if="age=14+">
      <fieldset>
        <legend>Which growth area is most important this year?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="growth14" value="Leadership"> Leadership</label>
          <label class="opt"><input type="radio" name="growth14" value="Time management"> Time management</label>
          <label class="opt"><input type="radio" name="growth14" value="Collaboration"> Collaboration</label>
          <label class="opt"><input type="radio" name="growth14" value="Creativity"> Creativity</label>
        </div>
      </fieldset>
    </div>

    <!-- SHARED GOALS -->
    <div class="step" data-step-id="q13">
      <fieldset>
        <legend>What are you hoping your child gains from Code Ninjas? <span class="hint">Select all that apply</span></legend>
        <div class="opts">
          <label class="opt"><input type="checkbox" name="goals" value="Confidence"> Confidence & self-belief</label>
          <label class="opt"><input type="checkbox" name="goals" value="Focus"> Focus & discipline</label>
          <label class="opt"><input type="checkbox" name="goals" value="Teamwork"> Teamwork & communication</label>
          <label class="opt"><input type="checkbox" name="goals" value="Academic"> Academic advantage</label>
          <label class="opt"><input type="checkbox" name="goals" value="Creativity"> Creativity & innovation</label>
          <label class="opt"><input type="checkbox" name="goals" value="Future skills"> Future skills (coding, AI, robotics)</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="qFuture" data-show-if="age=8-10,11-13">
      <fieldset>
        <legend>If we focused your Ninja’s time on future-ready skills, which feels most important this year?</legend>
        <div class="opts">
          <label class="opt">
            <input type="radio" name="futurefocus" value="Coding core">
            A strong foundation in coding first (consistency & mastery).
          </label>
          <label class="opt">
            <input type="radio" name="futurefocus" value="Coding + AI">
            Coding plus early exposure to AI and smart tools.
          </label>
          <label class="opt">
            <input type="radio" name="futurefocus" value="Coding + Robotics">
            Coding plus hands-on robotics & engineering challenges.
          </label>
          <label class="opt">
            <input type="radio" name="futurefocus" value="All three">
            A blend of coding, AI, and robotics throughout the year.
          </label>
          <label class="opt">
            <input type="radio" name="futurefocus" value="Not sure">
            I’m not sure yet — I mostly want them excited, confident, and moving forward.
          </label>
        </div>
      </fieldset>
    </div>

    <!-- Q15 DELETED AS REQUESTED -->

    <div class="step" data-step-id="q16">
      <fieldset>
        <legend>How important is it for kids to understand AI & emerging technology?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="ai" value="Essential"> Essential</label>
          <label class="opt"><input type="radio" name="ai" value="Very"> Very important</label>
          <label class="opt"><input type="radio" name="ai" value="Somewhat"> Somewhat important</label>
          <label class="opt"><input type="radio" name="ai" value="Not sure"> Not sure yet</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q17">
      <fieldset>
        <legend>Which traits would you most like to see grow this year? <span class="hint">Choose up to 2</span></legend>
        <div class="opts">
          <label class="opt"><input type="checkbox" name="traitsGrow" value="Confidence"> Confidence</label>
          <label class="opt"><input type="checkbox" name="traitsGrow" value="Focus"> Focus</label>
          <label class="opt"><input type="checkbox" name="traitsGrow" value="Creativity"> Creativity</label>
          <label class="opt"><input type="checkbox" name="traitsGrow" value="Leadership"> Leadership</label>
          <label class="opt"><input type="checkbox" name="traitsGrow" value="Collaboration"> Collaboration</label>
          <label class="opt"><input type="checkbox" name="traitsGrow" value="Resilience"> Resilience</label>
        </div>
      </fieldset>
    </div>

    <!-- MARKETING ATTRIBUTION SECTION -->
    <div class="step" data-step-id="q18">
      <p style="font-size:15px; margin:0 0 10px; line-height: 1.5; color: var(--ink);">
        <strong style="color: var(--brand);">You’re almost done!</strong><br>
        Thanks for sharing about your Ninja — just one last quick question before we wrap up.<br>
        As a thank-you for your time, you’ll receive a temporary code to waive the $99 enrollment fee once you submit your answers below.
      </p>
      <fieldset>
        <legend>How did you first hear about Code Ninjas?</legend>
        <div class="hint">Choose one that best fits</div>
        <div class="opts">
          <label class="opt"><input type="radio" name="hearAbout" value="Friend"> A friend or another parent told us about you</label>
          <label class="opt"><input type="radio" name="hearAbout" value="School"> Through our child’s school or teacher</label>
          <label class="opt"><input type="radio" name="hearAbout" value="Social"> On social media (Facebook, Instagram, etc.)</label>
          <label class="opt"><input type="radio" name="hearAbout" value="Search"> Google or another online search</label>
          <label class="opt"><input type="radio" name="hearAbout" value="Event"> At a local event or community fair</label>
          <label class="opt"><input type="radio" name="hearAbout" value="Returning"> We’ve been here before (returning family)</label>
          <label class="opt"><input type="radio" name="hearAbout" value="Other"> Other (not listed here)</label>
        </div>
      </fieldset>
    </div>

    <!-- Friend / another parent follow-up -->
    <div class="step" data-step-id="q18A" data-show-if="hearAbout=Friend">
      <fieldset>
        <legend>What did they share that made you want to check us out?</legend>
        <div class="opts">
          <label class="opt"><input type="checkbox" name="hearFriendShare" value="Their child loved coming here"> Their child loved coming here</label>
          <label class="opt"><input type="checkbox" name="hearFriendShare" value="They mentioned better focus and confidence"> They mentioned better focus and confidence</label>
          <label class="opt"><input type="checkbox" name="hearFriendShare" value="They said their child was doing better in school after joining"> They said their child was doing better in school after joining</label>
          <label class="opt"><input type="checkbox" name="hearFriendShare" value="They showed something their child built"> They showed something their child built</label>
        </div>
        <input type="text" id="friendName" name="friendName" placeholder="Name of friend/parent (Optional)" class="step-input">
      </fieldset>
    </div>

    <!-- School / teacher follow-up -->
    <div class="step" data-step-id="q18B" data-show-if="hearAbout=School">
      <fieldset>
        <legend>How did the school share Code Ninjas?</legend>
        <div class="opts">
          <label class="opt"><input type="checkbox" name="schoolShare" value="Flyer or email"> Flyer or email</label>
          <label class="opt"><input type="checkbox" name="schoolShare" value="School newsletter"> School newsletter</label>
          <label class="opt"><input type="checkbox" name="schoolShare" value="In-school visit or demo"> In-school visit or demo</label>
          <label class="opt"><input type="checkbox" name="schoolShare" value="Teacher recommendation"> Teacher recommendation</label>
        </div>
        <input type="text" id="schoolNameInput" name="schoolNameInput" placeholder="School Name" class="step-input">
        <input type="text" id="teacherNameInput" name="teacherNameInput" placeholder="Teacher Name" class="step-input hidden">
      </fieldset>
    </div>

    <!-- Social media follow-up -->
    <div class="step" data-step-id="q18C" data-show-if="hearAbout=Social">
      <fieldset>
        <legend>Which platform?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="socialPlatform" value="Facebook"> Facebook</label>
          <label class="opt"><input type="radio" name="socialPlatform" value="Instagram"> Instagram</label>
          <label class="opt"><input type="radio" name="socialPlatform" value="TikTok"> TikTok</label>
          <label class="opt"><input type="radio" name="socialPlatform" value="Not sure"> Not sure</label>
        </div>
      </fieldset>
    </div>

    <!-- Google / online search follow-up -->
    <div class="step" data-step-id="q18D" data-show-if="hearAbout=Search">
      <fieldset>
        <legend>What were you searching for when you found us?</legend>
        <div class="opts">
          <label class="opt"><input type="checkbox" name="searchTopics" value="Coding classes"> Coding classes</label>
          <label class="opt"><input type="checkbox" name="searchTopics" value="Robotics classes"> Robotics classes</label>
          <label class="opt"><input type="checkbox" name="searchTopics" value="AI programs"> AI programs</label>
          <label class="opt"><input type="checkbox" name="searchTopics" value="STEM classes or camps"> STEM classes or camps</label>
          <label class="opt"><input type="checkbox" name="searchTopics" value="After-school programs"> After-school programs</label>
          <label class="opt"><input type="checkbox" name="searchTopics" value="Summer camps"> Summer camps</label>
          <label class="opt"><input type="checkbox" name="searchTopics" value="Other / something else"> Other / something else</label>
        </div>
      </fieldset>

      <fieldset style="margin-top:12px;">
        <legend>What made you click on Code Ninjas?</legend>
        <div class="opts">
          <label class="opt"><input type="checkbox" name="searchClickWhy" value="The program description or curriculum"> The program description or curriculum</label>
          <label class="opt"><input type="checkbox" name="searchClickWhy" value="Positive reviews from other parents"> Positive reviews from other parents</label>
          <label class="opt"><input type="checkbox" name="searchClickWhy" value="The convenient location"> The convenient location</label>
          <label class="opt"><input type="checkbox" name="searchClickWhy" value="The special offer or free session"> The special offer or free session</label>
          <label class="opt"><input type="checkbox" name="searchClickWhy" value="The visuals (photos, videos, or ad design)"> The visuals (photos, videos, or ad design)</label>
          <label class="opt"><input type="checkbox" name="searchClickWhy" value="Other / something else"> Other / something else</label>
        </div>
      </fieldset>
    </div>

    <!-- No extra follow-up for Event/Other -->

    <div class="actions sticky">
      <button class="btn" id="backBtn" type="button">◀ Back</button>
      <button class="btn primary" id="nextBtn" type="button">Next ▶</button>
    </div>
  </section>

  <!-- LOADING / WAITING SCREEN -->
  <section id="loading" class="card hidden" aria-live="polite">
    <h2 id="loadingTitle">Analyzing results…</h2>
    <p id="loadingSub">Finding the best program for your Ninja…</p>
    <div class="spinner" aria-hidden="true"></div>
  </section>

  <!-- RESULT VIEW -->
  <section id="result" class="card" aria-live="polite">
    <h2 id="personaTitle"></h2>
    <p id="personaBlurb"></p>
    <h2 id="recTitle"></h2>
    <p id="recBlurb"></p>
    <ul id="recPoints"></ul>

    <div id="funFact" class="hidden">
      <strong>Fun Fact for Your Ninja!</strong>
      <div id="funFactText"></div>
    </div>

    <h3 class="center" style="margin:24px 0 12px; color: var(--brand);">At-a-glance match</h3>
    <div id="stats"></div>

    <div class="actions center" style="justify-content:center; margin-top:32px;">
      <button class="btn" id="retakeBtn" type="button">Retake Quiz</button>
    </div>
    <p class="hint center" id="centerNote"></p>
  </section>
</div>

<!-- Web3Forms form (hidden; includes required fields) -->
<!-- Target a hidden iframe to avoid redirection/reload on file:// -->
<iframe name="hidden_iframe" style="display:none;"></iframe>
<form id="web3Form" class="hidden" action="https://api.web3forms.com/submit" method="POST" target="hidden_iframe">
  <input type="hidden" name="access_key" value="fa23863b-372c-4f44-b8e4-dd8f0ec3b087">
  <input type="hidden" name="name" id="wf_name" required>
  <!-- Email removed as requested -->
  <textarea name="message" id="wf_message" style="display:none;" required></textarea>
  <input type="hidden" name="subject" id="wf_subject" value="New Ninja Path Finder Lead">
  <input type="hidden" name="from_name" value="Code Ninjas Program Finder">
</form>

<script>
(function(){
  const $  = (s,root=document) => root.querySelector(s);
  const $$ = (s,root=document) => Array.from(root.querySelectorAll(s));
  window.API_Access = true; // set to false to skip Web3Forms submit

  // ---------- PRESTART ----------
  const prestart = $('#prestart');
  const startBtn = $('#startQuizBtn');
  const inputsPre = {
    parentFirst: $('#parentFirst'),
    parentLast:  $('#parentLast'),
    // Email input removed
    location:    $('#location')
  };
  let parentFirst = '', parentLast = '', centerLocation = '';

  // ---------- GEMINI CONFIG (Pathfinder) ----------
  const GEMINI_API_KEY = "AIzaSyBsLtykpP5kAuEE4LVJiTx-HwxwQtg7GFA";
  const GEMINI_MODEL_CANDIDATES = [
    "gemini-2.5-flash"
  ];

  async function callGemini(promptText){
    if(!GEMINI_API_KEY){
      console.warn("Gemini API key is missing.");
      return null;
    }

    for(const model of GEMINI_MODEL_CANDIDATES){
      try {
        const res = await fetch(
          "https://generativelanguage.googleapis.com/v1beta/models/" + model + ":generateContent",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-goog-api-key": GEMINI_API_KEY
            },
            body: JSON.stringify({
              contents: [
                {
                  role: "user",
                  parts: [{ text: promptText }]
                }
              ]
            })
          }
        );

        if(!res.ok){
          const errJson = await res.json().catch(() => null);
          console.warn("Gemini error for model", model, errJson || res.status);
          continue;
        }

        const data = await res.json();
        const parts = data?.candidates?.[0]?.content?.parts || [];
        const text = parts.map(p => p.text || "").join("").trim();
        if(text){
          return text;
        }
      } catch(e){
        console.warn("Gemini request failed for model", model, e);
      }
    }
    return null;
  }

  // Parse EMAIL + 3 SMS options from Gemini
  function extractSection(text, label){
    const re = new RegExp(`---${label}---([\\s\\S]*?)(?=---[A-Z0-9]+---|$)`, 'i');
    const m = text.match(re);
    return m ? m[1].trim() : '';
  }

  async function generateAiComms(options){
    const {
      programDisplay,
      apiProgramName,
      personaLabel,
      funFact,
      bundleType,
      marketingSource,
      marketingSubsource,
      qaSummaryLines
    } = options;

    const greetingName = parentFirst || "there";
    const centerName = centerLocation || "your local center";

    const prompt =
`You are an enrollment advisor at Code Ninjas. A parent just completed an in-center Pathfinder survey.

You must produce a SHORT email (friendly recap) and THREE SMS options.

Audience:
- Parent or guardian of a child who just visited Code Ninjas ${centerName} and completed the program finder questionnaire.

VISIT CONTEXT (CRITICAL FOR EMOTIONAL CONNECTION):
- If the recommended program involves "JR" (ages 5-7), the child participated in "hands-on activities" or "JR activities".
- If the recommended program involves "CREATE" or "Academy" (ages 8+), the child participated in a "free game-building session".
- YOU MUST CONNECT the parent's described traits (e.g., competitive, social, creative) to what was observed during this specific session.
- Avoid blunt statements like "You shared that...". Use a smoother bridge.
- GOOD (Pathos - Game Building): "On our questionnaire, you mentioned [Child Name] is competitive and social, and we could really see that in action as they were building their game in the dojo today. [Then emphasize their enthusiasm]."
- GOOD (Pathos - JR): "On our questionnaire, you mentioned [Child Name] is curious, and we could really see that in action while they worked on the hands-on activities. [Then emphasize]."
- IMPORTANT: If the program is CREATE or Academy, use the phrase "building their game" or "game-building session" when describing their engagement.

EMAIL GOALS AND ORDER:
1) Open warmly and talk about their child first. Use the "Visit Context" rule above to link their traits to the specific session type (game-building vs activities).
2) Then briefly explain why the recommended path "${programDisplay}" is a strong fit, in clear, parent-friendly language.
3) Then invite them to take simple next steps.
4) Finally, include the enrollment link + code line as described below.

TONE:
- Warm, human, encouraging, conversational.
- Sound like a real person, not a corporate marketing email.
- Use natural, everyday language and contractions (we're, they're, you'll, etc.).
- No emojis. No markdown. No bullet points in the email.
- 3 short paragraphs max, plus a closing line.
- 160 words or fewer total.

EMAIL REQUIREMENTS:
- Start with: "Dear ${greetingName},"
- Talk clearly about the child and what matters to this family before describing the program.
- Must clearly mention the recommended path as: "${programDisplay}".
- MUST include this exact sentence somewhere in the body (use the placeholder as written):
"As a thank-you for taking the time to complete this questionnaire, you can enroll using this link: [ENROLLMENT_LINK]. Use code C9J5 at checkout to waive the enrollment fee if you enroll in the next few days."
- In that sentence, keep the placeholder [ENROLLMENT_LINK] exactly as written (do not replace it with a URL).
- End with a warm, conversational signoff and center name, for example:
"Warmly,
[Center Director Name]
Code Ninjas ${centerName}"

SMS REQUIREMENTS:
- Provide THREE distinct SMS options.
- Context: These texts will be sent the NEXT DAY to follow up.
- Each SMS: conversational and warm, 2–3 short sentences, up to about 280 characters.
- Each SMS must:
  - Feel personal and relational.
  - Briefly reference their child’s excitement, interests, or goals before mentioning logistics.
  - Mention "Code Ninjas ${centerName}".
  - Mention "${programDisplay}".
  - Include the phrase "code C9J5".
  - Refer to the enrollment link using the placeholder [ENROLLMENT_LINK] exactly as written (do not invent a real URL).
  - Clearly say they can enroll using [ENROLLMENT_LINK] and that code C9J5 waives the enrollment fee if they enroll within the next few days.
- You may gently invite them to reply with questions or to talk more, but keep it friendly and low-pressure.
- No greetings like "Hi, this is...". Just the message body.
- No markdown or numbering inside the SMS messages themselves.

CONTEXT ABOUT THIS FAMILY:
- Persona label for the child: ${personaLabel}
- Recommended path / program: ${programDisplay}
- Program family: ${apiProgramName} (bundle type: ${bundleType || "n/a"})
- Main marketing source: ${marketingSource || "N/A"}
- Extra marketing notes:
${marketingSubsource || "N/A"}

Fun fact we shared during the visit:
${funFact || "None provided."}

Summary of their answers (each bullet is "question → answer"):
${(qaSummaryLines || []).map(l => "• " + l).join("\n")}

OUTPUT FORMAT (VERY IMPORTANT):
Write your answer in this exact structure, with these markers on their own lines:

---EMAIL---
[short email body]
---SMS1---
[sms option 1]
---SMS2---
[sms option 2]
---SMS3---
[sms option 3]`;

    const raw = await callGemini(prompt);
    if(!raw) return null;

    const email = extractSection(raw, 'EMAIL');
    const sms1  = extractSection(raw, 'SMS1');
    const sms2  = extractSection(raw, 'SMS2');
    const sms3  = extractSection(raw, 'SMS3');
    const sms = [sms1, sms2, sms3].filter(Boolean).map(s => s.replace(/\s+/g,' ').trim());

    if(!email || sms.length === 0) return null;

    return { email: email.trim(), sms };
  }

  // Fallback if Gemini fails
  function buildFallbackComms(programDisplay){
    const greetingName = parentFirst || 'there';
    const centerName = centerLocation || 'your local center';

    const email =
`Dear ${greetingName},

It was truly a pleasure meeting you and your child today. Hearing about your family and seeing your Ninja’s excitement in the dojo made it clear they’re a great fit for a creative, engaging learning environment.

From our conversation and the Pathfinder results, ${programDisplay} lines up with what you want — a balance of structure, hands-on challenge, and a fun way to build real-world coding and problem-solving skills.

As a thank-you for taking the time to complete this questionnaire, you can enroll using this link: [ENROLLMENT_LINK]. Use code C9J5 at checkout to waive the enrollment fee if you enroll in the next few days.

Warmly,
[Center Director Name]
Code Ninjas ${centerName}`;

    const sms = [
      `Code Ninjas ${centerName}: It was great meeting you and your Ninja yesterday. From what you shared, ${programDisplay} gives them a fun way to build confidence, focus, and real tech skills. If you decide to get started, you can enroll at [ENROLLMENT_LINK] and use code C9J5 to waive the enrollment fee if you enroll within the next few days. We’re happy to answer any questions.`,
      `Thanks again for stopping by Code Ninjas ${centerName}. Your Ninja’s interests and energy really matched what we do, and ${programDisplay} is a natural next step for their growth. If and when it feels right, you can enroll using [ENROLLMENT_LINK] — just enter code C9J5 at checkout to waive the enrollment fee if you enroll within the next few days.`,
      `We loved having you and your Ninja at Code Ninjas ${centerName}. ${programDisplay} is a great fit for the mix of creativity and structure you’re looking for. If you’d like to keep that momentum going, you can enroll at [ENROLLMENT_LINK] and use code C9J5 at checkout to waive the enrollment fee when you enroll within the next few days. No pressure at all — we’re here if you want to talk more.`
    ];

    return { email, sms };
  }

  function syncStartState(){
    parentFirst    = (inputsPre.parentFirst.value || '').trim();
    parentLast     = (inputsPre.parentLast.value  || '').trim();
    centerLocation = (inputsPre.location.value    || '').trim();
    startBtn.disabled = !(parentFirst && parentLast && centerLocation);
  }
  Object.values(inputsPre).forEach(el => {
    el.addEventListener('input', syncStartState);
    el.addEventListener('change', syncStartState);
  });

  // ---------- TEACHER INPUT TOGGLE ----------
  function initTeacherToggle(){
    const teacherInput = $('#teacherNameInput');
    const schoolShareChecks = $$('input[name="schoolShare"]');
    if(!teacherInput) return;
    
    const checkHandler = () => {
      const isTeacher = schoolShareChecks.some(c => c.checked && c.value === "Teacher recommendation");
      if(isTeacher) teacherInput.classList.remove('hidden');
      else teacherInput.classList.add('hidden');
    };

    schoolShareChecks.forEach(cb => cb.addEventListener('change', checkHandler));
  }
  initTeacherToggle();

  // ---------- WIZARD STATE ----------
  const wizard = $('#wizard');
  const bar = $('#bar');
  const qnum = $('#qnum');
  const qtotalSpan = $('#qtotal');
  const backBtn = $('#backBtn');
  const nextBtn = $('#nextBtn');
  const result = $('#result');
  const loadingSection = $('#loading');
  const loadingTitle = $('#loadingTitle');
  const loadingSub = $('#loadingSub');
  const allSteps = $$('.step');
  let visibleSteps = [];
  let idx = 0;
  let isSubmitting = false;
  let loadingIntervalId = null;
  const loadingPhrases = [
    'Finding the best program for your Ninja…',
    'Matching your Ninja’s strengths and goals…',
    'Reviewing your answers with our AI assistant…',
    'Preparing your personalized recommendation…'
  ];

  function startLoading(){
    wizard.classList.add('hidden');
    result.style.display = 'none';
    loadingSection.classList.remove('hidden');
    loadingTitle.textContent = 'Analyzing results…';
    loadingSub.textContent = loadingPhrases[0];
    let i = 0;
    if(loadingIntervalId) clearInterval(loadingIntervalId);
    loadingIntervalId = setInterval(() => {
      i = (i + 1) % loadingPhrases.length;
      loadingSub.textContent = loadingPhrases[i];
    }, 2200);
    window.scrollTo({ top:0, behavior:'smooth' });
  }

  function stopLoading(){
    if(loadingIntervalId){
      clearInterval(loadingIntervalId);
      loadingIntervalId = null;
    }
    loadingSection.classList.add('hidden');
  }

  function parseCondition(cond){
    if(!cond) return null;
    const [name, values] = cond.split('=');
    if(!name || !values) return null;
    const allowed = values.split(',').map(v => v.trim());
    return { name: name.trim(), values: allowed };
  }

  function getValue(name){
    const radios = $$('input[type=radio][name="'+name+'"]');
    if(radios.length){
      const checked = radios.find(r => r.checked);
      return checked ? checked.value : '';
    }
    const checks = $$('input[type=checkbox][name="'+name+'"]:checked');
    if(checks.length){
      return checks.map(c => c.value);
    }
    return '';
  }

  function conditionMatches(cond){
    const c = parseCondition(cond);
    if(!c) return true;
    const val = getValue(c.name);
    if(Array.isArray(val)){
      return val.some(v => c.values.includes(v));
    }
    return c.values.includes(val);
  }

  function recomputeVisibleSteps(){
    visibleSteps = allSteps.filter(step => {
      const cond = step.getAttribute('data-show-if');
      if(!cond) return true;
      return conditionMatches(cond);
    });
    visibleSteps.forEach(s => s.classList.remove('active'));
    if(idx >= visibleSteps.length) idx = visibleSteps.length - 1;
    if(idx < 0) idx = 0;
    updateUI();
  }

  function updateUI(){
    visibleSteps.forEach((s,i) => s.classList.toggle('active', i === idx));
    const total = visibleSteps.length || 1;
    qtotalSpan.textContent = total;
    qnum.textContent = idx + 1;
    bar.style.width = (idx / Math.max(total - 1, 1)) * 100 + '%';
    backBtn.disabled = idx === 0;

    const active = visibleSteps[idx];
    let disableNext = false;

    if(active){
      // Require at least one radio per group on this step
      const radios = $$('input[type=radio]', active);
      if(radios.length){
        const names = [...new Set(radios.map(r => r.name))];
        names.forEach(name => {
          const group = $$('input[type=radio][name="'+name+'"]', active);
          if(group.length && !group.some(r => r.checked)){
            disableNext = true;
          }
        });
      }

      // NEW: Require at least one checkbox checked on any step that has checkboxes
      const checkboxes = $$('input[type=checkbox]', active);
      if(checkboxes.length){
        const anyChecked = checkboxes.some(c => c.checked);
        if(!anyChecked){
          disableNext = true;
        }
      }
    }

    nextBtn.textContent = (idx === visibleSteps.length - 1) ? 'See Results ▶' : 'Next ▶';
    nextBtn.disabled = disableNext;
  }

  wizard.addEventListener('change', recomputeVisibleSteps);
  visibleSteps = allSteps; updateUI();

  // ---------- START QUIZ ----------
  startBtn.addEventListener('click', () => {
    syncStartState();
    if(!(parentFirst && parentLast && centerLocation)) return;
    prestart.classList.add('hidden');
    wizard.classList.remove('hidden');
    idx = 0;
    recomputeVisibleSteps();
    const ageLegend = $('#ageLegend');
    if(ageLegend){
      ageLegend.textContent = `Hi ${parentFirst}! How old is your child?`;
    }
  });

  // ---------- NAV ----------
  backBtn.addEventListener('click', () => {
    if(isSubmitting) return;
    if(idx>0){ idx--; updateUI(); }
  });

  nextBtn.addEventListener('click', async () => {
    if(isSubmitting) return;

    if(idx < visibleSteps.length - 1){
      idx++;
      updateUI();
    } else {
      isSubmitting = true;
      startLoading();
      try {
        await computeResultsAndSubmit();
      } finally {
        isSubmitting = false;
      }
    }
  });

  // ---------- LABEL HELPERS ----------
  function radioLabel(name){
    const el = document.querySelector('input[name="'+name+'"]:checked');
    if(!el) return '';
    const lab = el.closest('label');
    return lab ? lab.textContent.trim() : el.value;
  }
  function checkboxLabels(name){
    return Array.from(document.querySelectorAll('input[name="'+name+'"]:checked')).map(el => {
      const lab = el.closest('label');
      return lab ? lab.textContent.trim() : el.value;
    });
  }
  function textValue(name){
    const input = document.querySelector('[name="'+name+'"]');
    if(!input) return '';
    return (input.value || '').trim();
  }
  function getLegendForInputName(name){
    const input = document.querySelector('[name="'+name+'"]');
    if(!input) return '';
    const fs = input.closest('fieldset');
    if(!fs) return '';
    const legend = fs.querySelector('legend');
    if(!legend) return '';
    const clone = legend.cloneNode(true);
    clone.querySelectorAll('span').forEach(s => s.remove());
    return clone.textContent.trim();
  }

  // ---------- PROGRAM SELECTION ----------
  function baseProgramKey(age){
    if(age === '5-7') return 'JR';
    if(age === '8-10' || age === '11-13') return 'CREATE';
    if(age === '14+') return 'ACADEMY';
    return 'CREATE';
  }

  function chooseCreateBundle(){
    const future = getValue('futurefocus');
    const goals = checkboxLabels('goals');
    const tech8 = getValue('tech8');
    const tech11 = getValue('tech11');

    if(future === 'All three'){
      return { label:'1+1+1 Bundle', type:'1+1+1' };
    }
    if(future === 'Coding + AI'){
      return { label:'1+1 Bundle (CREATE + AI Academy)', type:'1+1_AI' };
    }
    if(future === 'Coding + Robotics'){
      return { label:'1+1 Bundle (CREATE + Robotics Academy)', type:'1+1_Robotics' };
    }
    if(future === 'Coding core'){
      return { label:'2x/Week', type:'2x' };
    }
    if(future === 'Not sure'){
      if(goals.includes('Future skills') || tech8 === 'Advanced' || tech11 === 'Advanced'){
        return { label:'1+1 Bundle (CREATE + AI Academy)', type:'1+1_AI' };
      }
      return { label:'2x/Week', type:'2x' };
    }
    if(goals.includes('Future skills') || tech8 === 'Advanced' || tech11 === 'Advanced'){
      return { label:'1+1 Bundle (CREATE + AI Academy)', type:'1+1_AI' };
    }
    return { label:'2x/Week', type:'2x' };
  }

  function personaBlurbByBundle(ageKey, bundleType){
    if(ageKey === 'JR'){
      return "Your Ninja thrives when learning feels like play. In Code Ninjas JR we channel big imagination into bite-sized wins—story-driven activities, hands-on tinkering, and gentle challenges that grow confidence without overwhelm. As they build patterns, sequences, and early problem-solving habits, mentors cheer them on so trying again feels natural and fun. It’s the perfect launchpad for curiosity to become capability.";
    }
    if(ageKey === 'ACADEMY'){
      return "Your Ninja is hungry for real challenges and real outcomes. In Academy, they’ll take on portfolio-ready projects, explore AI and modern development tools, and learn to plan, iterate, and ship—just like pros do. With mentors who coach mindsets as much as mechanics, they’ll build independence, leadership, and the kind of confidence that shows up in school, interviews, and beyond. It’s serious growth without losing the joy.";
    }
    if(bundleType === '2x'){
      return "Your Ninja is ready to lock in focused momentum. With CREATE 2x, we double down on coding only—steady weekly rhythm, clear milestones, and mentor feedback that compounds. This path builds real fluency: reading code, fixing bugs, and finishing games that actually work. The consistency keeps motivation high while the belt system turns progress into something they can see and be proud of.";
    }
    if(bundleType === '1+1_AI'){
      return "Your Ninja loves building—and they’re curious about the smart tools shaping the world. The CREATE 1+1 (CREATE + AI Academy) bundle blends solid coding foundations with age-appropriate AI concepts, from problem-solving with intelligent helpers to designing projects that feel a little bit magical. Mentors keep it safe, understandable, and exciting, so curiosity becomes capability and big ideas feel within reach.";
    }
    if(bundleType === '1+1_Robotics'){
      return "Your Ninja wants to see code come to life. The CREATE 1+1 (CREATE + Robotics Academy) bundle pairs core coding progress with hands-on engineering—sensors, motion, and builds they can hold. They’ll learn to plan, test, and iterate while celebrating every wobbly prototype that gets a little better. It’s a confidence-boosting mix of logic and making that turns tinkering into real skills.";
    }
    if(bundleType === '1+1+1'){
      return "Your Ninja thrives on variety and momentum. The CREATE 1+1+1 bundle layers coding with rotating academy and club experiences, so each week feels fresh while skills stack up. They’ll deepen fundamentals, sample AI and robotics, and plug into a community that celebrates progress. It’s the all-around path for kids who want to explore widely, grow steadily, and stay excited all year long.";
    }
    return "Your Ninja likes to build, tinker, and see progress fast. In CREATE, mentors guide them through projects that make coding feel rewarding, not intimidating—so they keep going even when challenges pop up. They’ll level up through our belt system, learn to debug with confidence, and finish creations they’re proud to share. It’s structured, fun, and designed for real growth.";
  }

  function buildProgramUI(age){
    const key = baseProgramKey(age);

    if(key === 'JR'){
      return {
        uiTitle: 'Recommended Program: Code Ninjas JR',
        uiBlurb: 'Playful, story-driven sessions where young Ninjas (5–7) explore early coding, logic, and creativity with tons of encouragement.',
        bullets: [
          'Gentle, game-based introduction to core concepts',
          'Hands-on projects that feel like play, not like school',
          'Builds early confidence, focus, and curiosity'
        ],
        stats: [
          ['5–7', 'Ideal ages'],
          ['Play-based', 'Learning style'],
          ['2–3 hrs / week', 'Recommended time'],
          ['Small groups', 'Mentor support'],
          ['Early logic', 'Patterns & sequencing'],
          ['Fun & safe', 'Dojo environment']
        ],
        apiProgram: 'Code Ninjas JR',
        bundleType: null
      };
    }

    if(key === 'ACADEMY'){
      return {
        uiTitle: 'Recommended Program: Code Ninjas Academy',
        uiBlurb: 'A deeper track for motivated teens ready for real-world coding, AI, and engineering projects that look great on future applications.',
        bullets: [
          'Project-based learning in coding, AI, and tech',
          'Portfolio-style outcomes for schools & careers',
          'A community of like-minded, driven Ninjas'
        ],
        stats: [
          ['14+', 'Typical ages'],
          ['Advanced', 'Challenge level'],
          ['2–3 hrs / week', 'Recommended time'],
          ['Real projects', 'Portfolio-ready'],
          ['Mentorship', 'Guided growth'],
          ['Future-focused', 'College & career skills']
        ],
        apiProgram: 'Code Ninjas Academy',
        bundleType: null
      };
    }

    // CREATE with bundles
    const bundle = chooseCreateBundle();

    let stats = [
      ['8–13', 'Ideal ages'],
      ['Belt system', 'Built-in motivation'],
      ['3–4 hrs / week', 'Recommended time'],
      ['Game creation', 'High engagement'],
      ['Future skills', 'Coding & logic'],
      ['Mentor support', 'Guided progress']
    ];

    let variantLine = '';
    let bulletsExtra = [];

    if(bundle.type === '2x'){
      variantLine = ' Code Ninjas CREATE (2x/Week)';
      stats[2] = ['3–4 hrs / week', 'Recommended time'];
      bulletsExtra = [
        'Two focused CREATE sessions each week for consistent progress',
        'Locked in on coding fundamentals—no additional academies or clubs',
        'Perfect when you want depth and mastery in one powerful track'
      ];
    } else if(bundle.type === '1+1_AI'){
      variantLine = ' Code Ninjas CREATE (1+1 Bundle: CREATE + AI Academy)';
      stats[2] = ['2–3 hrs / week', 'Recommended time'];
      bulletsExtra = [
        'One CREATE session + one AI Academy session each week',
        'Blend core coding with age-appropriate AI concepts and tools',
        'Great for future-facing Ninjas curious about smart technology'
      ];
    } else if(bundle.type === '1+1_Robotics'){
      variantLine = ' Code Ninjas CREATE (1+1 Bundle: CREATE + Robotics Academy)';
      stats[2] = ['2–3 hrs / week', 'Recommended time'];
      bulletsExtra = [
        'One CREATE session + one Robotics Academy session each week',
        'Turn code into motion with engineering challenges and builds',
        'Ideal for hands-on builders who love to see things move'
      ];
    } else if(bundle.type === '1+1+1'){
      variantLine = ' Code Ninjas CREATE (1+1+1 Bundle: Coding + Academies + Clubs)';
      stats[2] = ['3–4 hrs / week', 'Recommended time'];
      const baseThree = [
        'Structured path from block coding into real languages',
        'Mentor-led dojo that feels fun, not like more school',
        'Builds confidence, focus, and perseverance through challenges'
      ];
      const extraForTriple = [
        'Coding',
        'Rotating AI and Robotics Academy experiences across the year',
        'Clubs/community add variety and momentum for hungry learners'
      ];
      return {
        uiTitle: 'Recommended Program:' + variantLine,
        uiBlurb: 'Your Ninja is ready for our CREATE Dojo—where they build real games, sharpen problem-solving, and level up through our belt system in a space that feels like home.',
        bullets: [...baseThree, ...extraForTriple],
        stats,
        apiProgram: 'Code Ninjas CREATE',
        bundleType: bundle.type
      };
    }

    return {
      uiTitle: 'Recommended Program:' + variantLine,
      uiBlurb: 'Your Ninja is ready for our CREATE Dojo—where they build real games, sharpen problem-solving, and level up through our belt system in a space that feels like home.',
      bullets: [
        'Structured path from block coding into real languages',
        'Mentor-led dojo that feels fun, not like more school',
        'Builds confidence, focus, and perseverance through challenges',
        ...bulletsExtra
      ],
      stats,
      apiProgram: 'Code Ninjas CREATE',
      bundleType: bundle.type
    };
  }

  // ---------- FUN FACT ----------
  function funFactText(programKey, signals, bundleType){
    // Prioritize bundle type for fun fact consistency
    if(bundleType === '1+1_AI'){
      return 'Students who engage early with coding and AI concepts gain confidence navigating technologies that are shaping the fastest-growing careers.';
    }
    if(bundleType === '1+1_Robotics'){
      return 'Building and programming robots helps kids connect coding to the real world, which research links to higher engagement in STEM over time.';
    }

    const txt = signals.join(' ').toLowerCase();
    if(/game|roblox|minecraft/.test(txt)){
      return 'Designing and coding their own games strengthens logic, creativity, and persistence—the same problem-solving muscles used by professional developers.';
    }
    if(/robot/.test(txt)){
      return 'Building and programming robots helps kids connect coding to the real world, which research links to higher engagement in STEM over time.';
    }
    if(programKey === 'ACADEMY' || /ai\b/.test(txt)){
      return 'Students who engage early with coding and AI concepts gain confidence navigating technologies that are shaping the fastest-growing careers.';
    }
    return 'Learning to code builds problem-solving, creativity, and resilience—skills that support success in math, science, writing, and beyond.';
  }

  // ---------- Q&A SUMMARY ----------
  function buildQASummary(){
    const fields = [
      ['age','radio'],
      ['traits5','checkbox'],['play5','radio'],['grit5','radio'],
      ['traits8','checkbox'],['learn8','radio'],['school8','radio'],['reengage8','radio'],['tech8','radio'],['tried8','radio'],
      ['traits11','checkbox'],['challenge11','radio'],['school11','radio'],['enjoy11','radio'],['tech11','radio'],['leader11','radio'],
      ['motivate14','radio'],['interest14','checkbox'],['tech14','radio'],['career14','radio'],['growth14','radio'],
      ['goals','checkbox'],['futurefocus','radio'],['ai','radio'],['traitsGrow','checkbox'],
      ['hearAbout','radio'],
      ['hearFriendShare','checkbox'],
      ['friendName','text'],
      ['schoolShare','checkbox'],
      ['schoolNameInput','text'],
      ['teacherNameInput','text'],
      ['socialPlatform','radio'],
      ['searchTopics','checkbox'],
      ['searchClickWhy','checkbox']
    ];
    const lines = [];
    fields.forEach(([name,type]) => {
      // Special handling for text inputs without legends, or custom label display
      if(type === 'text'){
        const val = textValue(name);
        if(val) {
           // Map ID to readable label
           let label = name;
           if(name === 'friendName') label = 'Friend/Parent Name';
           else if(name === 'schoolNameInput') label = 'School Name';
           else if(name === 'teacherNameInput') label = 'Teacher Name';
           lines.push(`${label} → ${val}`);
        }
        return;
      }

      const legend = getLegendForInputName(name);
      if(!legend) return;
      let ans = '';
      if(type === 'radio'){
        ans = radioLabel(name);
      } else if(type === 'checkbox'){
        ans = checkboxLabels(name).join(', ');
      }
      if(ans) lines.push(legend + ' → ' + ans);
    });
    return lines;
  }

  // ---------- API SUBMIT ----------
  function submitToWeb3Forms(message){
    if(window.API_Access === false){ console.log('API submission skipped'); return; }
    
    const form = $('#web3Form');
    const msgField = $('#wf_message');
    const subjField = $('#wf_subject');
    const nameField = $('#wf_name');
    // wf_email is set in HTML with a dummy value since user removed input

    if(!form || !msgField || !subjField || !nameField) return;

    subjField.value = `New Ninja Path Finder Lead - ${centerLocation}`;
    nameField.value = `${parentFirst} ${parentLast}`.trim();
    msgField.value = message;

    // Submit via standard form POST to hidden iframe to bypass CORS on file://
    form.submit();
    console.log('Web3Forms submission triggered via hidden frame');
  }

  // ---------- MAIN RESULTS ----------
  async function computeResultsAndSubmit(){
    const ageVal = getValue('age') || '';
    const baseKey = baseProgramKey(ageVal);
    const programUI = buildProgramUI(ageVal);

    const goals = checkboxLabels('goals');
    const allTraits = []
      .concat(checkboxLabels('traits5'))
      .concat(checkboxLabels('traits8'))
      .concat(checkboxLabels('traits11'))
      .concat(checkboxLabels('interest14'));
    let persona = 'The Curious Creator Ninja';
    if(goals.includes('Confidence')) persona = 'The Confidence-Boosting Ninja';
    else if(goals.includes('Future skills')) persona = 'The Future-Ready Ninja';
    else if(allTraits.some(t => /Game/i.test(t))) persona = 'The Game Maker Ninja';
    else if(allTraits.some(t => /Robotics|Engineering/i.test(t))) persona = 'The Builder Ninja';

    const bundleType = programUI.bundleType || (baseKey === 'CREATE' ? (chooseCreateBundle().type) : null);
    const personaBlurb = personaBlurbByBundle(baseKey, bundleType);

    // Marketing attribution
    const hearCode = getValue('hearAbout');
    let marketingSource = '';
    let marketingSubsource = '';
    const hearLabel = radioLabel('hearAbout');

    if(hearCode){
      switch(hearCode){
        case 'Friend': {
          marketingSource = 'Friend / Parent Referral';
          const fName = textValue('friendName');
          marketingSubsource = [
            `Primary source: ${hearLabel}`,
            fName ? `Referred by: ${fName}` : ''
          ].filter(Boolean).join('\n');
          break;
        }
        case 'School': {
          marketingSource = 'School / Teacher';
          const schoolShare = checkboxLabels('schoolShare');
          const sName = textValue('schoolNameInput');
          const tName = textValue('teacherNameInput');
          marketingSubsource = [
            `Primary source: ${hearLabel}`,
            sName ? `School: ${sName}` : '',
            tName ? `Teacher: ${tName}` : '',
            schoolShare.length ? `How school shared: ${schoolShare.join(', ')}` : ''
          ].filter(Boolean).join('\n');
          break;
        }
        case 'Social': {
          marketingSource = 'Social Media';
          const socialPlatform = radioLabel('socialPlatform');
          marketingSubsource = [
            `Primary source: ${hearLabel}`,
            socialPlatform ? `Platform: ${socialPlatform}` : ''
          ].filter(Boolean).join('\n');
          break;
        }
        case 'Search': {
          marketingSource = 'Google / Online Search';
          const searchTopics = checkboxLabels('searchTopics');
          const clickReasons = checkboxLabels('searchClickWhy');
          marketingSubsource = [
            `Primary source: ${hearLabel}`,
            searchTopics.length ? `What they were searching for: ${searchTopics.join(', ')}` : '',
            clickReasons.length ? `What made them click: ${clickReasons.join(', ')}` : ''
          ].filter(Boolean).join('\n');
          break;
        }
        case 'Event': {
          marketingSource = 'Event / Fair / Camp';
          marketingSubsource = `Primary source: ${hearLabel}`;
          break;
        }
        case 'Returning': {
          marketingSource = 'Returning Family';
          marketingSubsource = `Primary source: ${hearLabel}`;
          break;
        }
        case 'Other': {
          marketingSource = 'Other';
          marketingSubsource = `Primary source: ${hearLabel}`;
          break;
        }
      }
    }

    // UI
    $('#personaTitle').textContent = `Your Ninja Profile: ${persona}`;
    $('#personaBlurb').textContent = personaBlurb;

    $('#recTitle').textContent = programUI.uiTitle;
    $('#recBlurb').textContent = programUI.uiBlurb;
    $('#recPoints').innerHTML = programUI.bullets.map(b => `<li>${b}</li>`).join('');

    $('#stats').innerHTML = programUI.stats.map(([v,l]) => `<div class="stat"><h3>${v}</h3><p>${l}</p></div>`).join('');

    // Fun fact (only for on-screen)
    const signals = [].concat(allTraits, goals, [
      radioLabel('play5'), radioLabel('tried8'), radioLabel('futurefocus'), radioLabel('ai')
    ].filter(Boolean));
    const funFact = funFactText(baseKey, signals, bundleType); 

    if(funFact){
      $('#funFactText').textContent = funFact;
      $('#funFact').classList.remove('hidden');
    } else {
      $('#funFact').classList.add('hidden');
    }

    // Center note
    $('#centerNote').textContent =
      `Before you head out today, stop by the front desk at Code Ninjas ${centerLocation} so we can walk you through this path and help you enroll. A summary of your results has been shared with the center.`;

    // Bundle-aware program display
    const apiProgramName = programUI.apiProgram;
    let programDisplay = apiProgramName;
    if(apiProgramName === 'Code Ninjas CREATE'){
      if(bundleType === '1+1_AI') programDisplay += ' (1+1 Bundle: CREATE + AI Academy)';
      else if(bundleType === '1+1_Robotics') programDisplay += ' (1+1 Bundle: CREATE + Robotics Academy)';
      else if(bundleType === '1+1+1') programDisplay += ' (1+1+1 Bundle: Coding + Academies + Clubs)';
      else if(bundleType === '2x') programDisplay += ' (2x/Week)';
    }

    // Build Q&A summary once
    const qaSummary = buildQASummary();

    // Prepare AI-generated email + SMS (short, child-first)
    let emailBody = '';
    let smsOptions = [];
    try {
      const comms = await generateAiComms({
        programDisplay,
        apiProgramName,
        personaLabel: persona,
        funFact,
        bundleType,
        marketingSource,
        marketingSubsource,
        qaSummaryLines: qaSummary
      });
      if(comms){
        emailBody = comms.email;
        smsOptions = comms.sms;
      }
    } catch(e) {
      console.warn("Error while generating AI comms:", e);
    }

    // Fallback if Gemini fails
    if(!emailBody || smsOptions.length === 0){
      const fallback = buildFallbackComms(programDisplay);
      emailBody = fallback.email;
      smsOptions = fallback.sms;
    }

    const timestamp = new Date().toLocaleString();

    const message =
`Location: Code Ninjas ${centerLocation}
Submitted: ${timestamp}

--------------------
Internal Notes:
Persona Label: ${persona}
Recommended Program: ${programDisplay}
Marketing Source: ${marketingSource || 'N/A'}
${marketingSubsource || 'N/A'}

--------------------
Q&A Summary (question → answer):
${qaSummary.map(l => '• ' + l).join('\n')}

--------------------
AI-Generated Parent Email:
${emailBody}

--------------------
AI-Generated SMS Options (choose one to text the parent):
1) ${smsOptions[0] || ''}

2) ${smsOptions[1] || ''}

3) ${smsOptions[2] || ''}`;

    submitToWeb3Forms(message);

    // Show result to parent after Gemini & submit complete
    stopLoading();
    wizard.classList.add('hidden');
    result.style.display = 'block';
    window.scrollTo({ top:0, behavior:'smooth' });
  }

  // ---------- RETAKE ----------
  $('#retakeBtn').addEventListener('click', () => { window.location.reload(); });
})();
</script>
</body>
</html>
