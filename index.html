<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Code Ninjas â€“ Ninja Path Finder</title>
  <meta name="theme-color" content="#2563eb" />

  <!-- --- PWA SETUP START --- -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <!-- --- PWA SETUP END --- -->

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

    :root {
      --bg1:#0ea5e9; --bg2:#2563eb;
      --card:#ffffff; --ink:#0f172a; --muted:#334155; /* Darkened for better contrast */
      --brand:#2563eb; --border:#cbd5e1; /* Darkened for better definition */
      --highlight:#eff6ff;
      --radius:20px;
      --shadow:0 20px 40px -10px rgba(0, 0, 0, 0.2);
    }
    * { box-sizing:border-box; }
    html, body {
      margin:0; padding:0; min-height:100%;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      background-attachment:fixed;
      color:var(--ink);
      -webkit-font-smoothing: antialiased;
    }
    /* Center content vertically and horizontally */
    .wrap { min-height:100svh; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px 16px; }
    
    header { color:#fff; text-align:center; margin:0 0 24px; width: 100%; max-width: 700px; }
    header .brand { display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom: 12px; }
    header img.logo { height:42px; width:auto; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.1)); transition: transform 0.3s ease; }
    header img.logo:hover { transform: scale(1.05); }
    header h1 { margin:0; font-size:clamp(22px,4vw,30px); font-weight:800; letter-spacing: -0.02em; text-shadow: 0 2px 4px rgba(0,0,0,0.1); line-height: 1.2; }
    header p { margin:8px 0 0; font-size:15px; color:#ffffff; line-height: 1.5; font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }

    .card {
      width:100%; max-width:720px;
      background:var(--card);
      border-radius:var(--radius);
      padding:32px;
      box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,0.2);
      position: relative;
    }
    .hidden { display:none !important; }

    /* Updated to Flexbox for better wrapping */
    .prestart-grid {
      display:flex;
      flex-wrap: wrap;
      gap:12px;
      align-items:center;
      margin-top:20px;
    }
    .prestart-grid input,
    .prestart-grid select,
    .step-input {
      padding:12px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      font-size:16px; /* 16px prevents iOS zoom */
      transition: all 0.2s ease;
      background: #f8fafc;
      font-family: inherit;
      color: var(--ink);
    }
    .prestart-grid input::placeholder,
    .step-input::placeholder {
      color: #64748b;
      opacity: 1;
    }
    .prestart-grid input,
    .prestart-grid select {
      flex: 1 1 220px; /* Flex grow ensures full width if wrapped */
    }
    .prestart-grid input:focus,
    .prestart-grid select:focus,
    .step-input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px var(--highlight);
      background: #fff;
    }
    .step-input { 
      width: 100%;
      margin-top: 12px; 
    }
    
    /* Centered Start Button - constrained width */
    #startQuizBtn, #confirmChildrenBtn {
      flex: 1 1 100%;
      width: 100%;
      max-width: 320px; /* Wider but constrained */
      margin: 8px auto 0;
      display: block;
    }
    #startChildQuizBtn, #nextChildBtn {
       flex: 1 1 100%;
      width: 100%;
      max-width: 320px; /* Wider but constrained */
      margin: 8px auto 0;
      display: block;
    }

    .prestart-label { font-size:15px; color:var(--ink); text-align: center; font-weight: 600; margin-bottom: 4px; }
    
    @media (max-width:600px) {
      .card { padding:24px 20px 80px; } /* Extra bottom padding for sticky actions */
      .wrap { padding: 12px; justify-content: flex-start; }
      header { margin-top: 10px; }
      .current-child-banner { margin: -24px -20px 24px; border-radius: 20px 20px 0 0; }
    }

    .topbar { display:flex; align-items:center; gap:12px; margin:0 0 24px; }
    .progress { flex:1; height:6px; background:#e2e8f0; border-radius:999px; overflow:hidden; }
    .bar { height:100%; width:0; background:var(--brand); transition:width .4s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 999px; }
    .count { font-size:13px; font-weight:700; color:var(--muted); min-width:90px; text-align:right; }
    .current-child-banner {
      position: sticky;
      top: 0;
      z-index: 20;
      background: #eff6ff;
      color: var(--brand);
      padding: 12px 16px;
      font-weight: 800;
      text-align: center;
      margin: -32px -32px 24px; /* Flush with card edges */
      border-bottom: 1px solid #bfdbfe;
      border-radius: 20px 20px 0 0; /* Match card radius */
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
      font-size: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .current-child-banner::before {
      content: 'ðŸ‘¤'; /* Simple icon */
      font-size: 18px;
    }

    .step { display:none; }
    .step.active { display:block; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes slideUp { from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:none;} }
    
    fieldset { border:0; margin:0; padding:0; }
    legend { font-weight:800; margin:0 0 16px; font-size:20px; color:var(--ink); line-height: 1.3; letter-spacing: -0.01em; }
    .hint { color:var(--muted); font-size:14px; margin:6px 0 0; font-weight: 500; display: block; }

    /* Updated to Grid for 4-option questions (2x2 grid) or flex for others */
    .opts {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    /* Specifically target sets with exactly 4 options to be a 2x2 grid on larger screens */
    /* This makes them look like even squares/boxes */
    .opts.grid-4 {
      display: grid;
      grid-template-columns: 1fr 1fr;
    }
    
    label.opt {
      flex: 1 1 200px; /* Default flex behavior */
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:14px;
      border-radius:12px;
      border:2px solid transparent;
      background:#f8fafc;
      font-size:15px;
      line-height:1.4;
      cursor:pointer;
      transition: all 0.15s ease;
      color: var(--ink);
      font-weight: 500;
      position: relative;
      height: 100%; /* Fill height in grid */
    }
    label.opt:hover {
      background: #f1f5f9;
      transform: translateY(-1px);
      border-color: #cbd5e1;
    }
    label.opt:has(input:checked) {
      background: var(--highlight);
      border-color: #93c5fd;
      color: var(--brand);
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
    }
    label.opt input {
      margin-top:2px;
      accent-color:var(--brand);
      width:18px; height:18px;
      flex-shrink: 0;
    }
    
    .actions {
      display:flex; justify-content:space-between; gap:12px; margin-top:28px;
    }
    .actions.sticky {
      position:sticky; bottom:0;
      margin: 28px -32px -32px;
      padding: 16px 32px 24px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(8px);
      border-top: 1px solid var(--border);
      border-radius: 0 0 var(--radius) var(--radius);
      z-index: 10;
    }
    @media (max-width: 600px) {
       .actions.sticky { margin: 24px -20px -80px; padding: 16px 20px 32px; border-radius: 0 0 var(--radius) var(--radius); }
       /* On mobile, maybe stack them or keep 2x2 if space permits. Let's keep 2x2 for grid-4 if possible, otherwise stack */
       .opts.grid-4 {
          grid-template-columns: 1fr 1fr; 
       }
    }
    @media (max-width: 400px) {
       .opts.grid-4 {
          grid-template-columns: 1fr; /* Stack on very small screens */
       }
    }


    .btn {
      appearance:none; border-radius:12px; padding:12px 24px;
      font-weight:700; font-size:15px; border:none;
      background:#e2e8f0; color:#334155; cursor:pointer; min-height:46px;
      transition: all 0.2s ease;
      display: inline-flex; align-items: center; justify-content: center;
    }
    .btn:hover:not(:disabled) { background: #cbd5e1; color: var(--ink); transform: translateY(-1px); }
    .btn.primary { background:var(--brand); color:#ffffff; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25); }
    .btn.primary:hover:not(:disabled) { background: #1d4ed8; transform: translateY(-1px); box-shadow: 0 6px 16px rgba(37, 99, 235, 0.35); }
    .btn:disabled { opacity:.6; cursor:not-allowed; transform: none !important; box-shadow: none !important; }

    #result { display:none; }
    #personaTitle { text-align:center; margin:0 0 8px; font-size:24px; font-weight:800; letter-spacing: -0.02em; color: var(--brand); }
    #personaBlurb { text-align:center; color:var(--ink); margin:0 auto 20px; font-size:15px; line-height: 1.5; max-width: 600px; }
    #recTitle { text-align:center; margin:28px 0 8px; font-size:20px; font-weight:800; }
    #recBlurb { text-align:center; color:var(--muted); margin:0 auto 16px; font-size:14px; max-width: 580px; }
    
    #recPoints { 
        background: #f8fafc; 
        padding: 20px 20px 20px 40px; 
        border-radius: 16px; 
        margin: 20px 0; 
        border: 1px solid var(--border);
    }
    #recPoints li { margin-bottom:8px; font-size:15px; line-height: 1.5; color: var(--ink); }
    #recPoints li::marker { color: var(--brand); font-weight: bold; }

    #funFact { 
        margin-top:20px; padding:20px; border-radius:16px; 
        border:1px solid #86efac; background:#f0fdf4; 
        font-size:14px; line-height: 1.5; color: #14532d;
    }
    #funFact strong { display:block; margin-bottom:4px; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: #15803d; font-weight: 800; }

    #stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:10px; margin-top:20px; }
    .stat { 
        padding:14px; border-radius:12px; border:1px solid var(--border); 
        text-align:center; background: #fff; transition: transform 0.2s;
    }
    .stat:hover { transform: translateY(-2px); border-color: #93c5fd; }
    .stat h3 { margin:0; font-size:16px; font-weight:800; color:var(--brand); }
    .stat p { margin:4px 0 0; color:var(--muted); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.02em; }

    .center { text-align:center; }
    .hint.center { margin-top:20px; font-size: 14px; max-width: 500px; margin-inline: auto; line-height: 1.5; color: var(--ink); }

    /* LOADING SCREEN */
    #loading { padding: 50px 0; text-align: center; }
    #loadingTitle {
      font-size:22px;
      font-weight:800;
      margin:0 0 10px;
      color: var(--brand);
      animation:pulse 2s ease-in-out infinite;
    }
    #loadingSub {
      font-size:15px;
      color:var(--muted);
      margin:0;
      animation:loadingText 2.2s ease-in-out infinite;
    }
    .spinner {
      width:42px;
      height:42px;
      border-radius:999px;
      border:3px solid #e2e8f0;
      border-top-color:var(--brand);
      margin:28px auto 0;
      animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
    @keyframes pulse {
      0% { transform:scale(1); opacity:0.9; }
      50% { transform:scale(1.03); opacity:1; }
      100% { transform:scale(1); opacity:0.9; }
    }
    @keyframes loadingText {
      0% { opacity:0; transform:translateY(4px); }
      20% { opacity:1; transform:translateY(0); }
      80% { opacity:1; transform:translateY(0); }
      100% { opacity:0; transform:translateY(-3px); }
    }
    
    /* Child Info Group Styling */
    .child-info-group {
        background: #f8fafc;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
        width: 100%;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
    }
    .child-info-group h4 {
        flex: 0 0 100%;
        margin: 0 0 8px;
        font-size: 15px;
        color: var(--brand);
        font-weight: 700;
    }
    .child-info-group input, .child-info-group select {
        flex: 1 1 150px;
    }
  </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <img class="logo" src="https://www.codeninjas.com/hubfs/Group%201.svg" alt="Code Ninjas" onerror="this.style.display='none'">
    </div>
    <h1>Find the Right Path for Your Ninja</h1>
    <p>Answer a few quick questions to match your child with the perfect Code Ninjas program.</p>
  </header>

  <!-- PRE-START -->
  <section id="prestart" class="card" aria-label="Parent details">
    <div class="prestart-label">Start by telling us who you are and which center you're visiting.</div>
    <div class="prestart-grid">
      <input id="parentFirst" placeholder="Parent first name" autocomplete="given-name">
      <input id="parentLast" placeholder="Parent last name" autocomplete="family-name">
      <select id="location" aria-label="Location">
        <option value="">Select location</option>
        <option value="Aventura">Aventura</option>
        <option value="Cooper City">Cooper City</option>
        <option value="Weston">Weston</option>
      </select>
      <button id="startQuizBtn" class="btn primary" type="button" disabled>Start Quiz â–¶</button>
    </div>
    <div class="hint" style="text-align:center; margin-top:12px;">We'll use this to share your child's personalized program match with your chosen center.</div>
  </section>

  <!-- CHILD SETUP (NEW) -->
  <section id="child-setup" class="card hidden" aria-live="polite">
    <h2 class="center" style="color:var(--brand); margin:0 0 20px; font-size: 20px;">Just one more thing...</h2>
    <fieldset>
      <legend style="text-align:center; margin-bottom:20px;">How many children are joining us today?</legend>
      <div class="opts grid-4">
        <label class="opt"><input type="radio" name="numChildrenChoice" value="1" checked> 1 Child</label>
        <label class="opt"><input type="radio" name="numChildrenChoice" value="2"> 2 Children</label>
        <label class="opt"><input type="radio" name="numChildrenChoice" value="3"> 3 Children</label>
        <label class="opt"><input type="radio" name="numChildrenChoice" value="4"> 4 Children</label>
      </div>
    </fieldset>

    <div id="child-names-area" class="hidden" style="margin-top:24px;">
       <p class="hint" style="text-align:center; margin-bottom:12px;">Please provide details for each child:</p>
       <div id="child-names-inputs" style="display:flex; flex-direction:column; gap:16px;">
          <!-- Inputs generated here -->
       </div>
    </div>

    <div class="actions center" style="margin-top:32px; justify-content:center;">
       <button id="confirmChildrenBtn" class="btn primary" type="button" style="width:100%; max-width:320px;">Begin Questionnaire â–¶</button>
    </div>
  </section>


  <!-- WIZARD -->
  <section id="wizard" class="card hidden" aria-live="polite">
    <!-- Banner for multi-child context -->
    <div id="childContextBanner" class="current-child-banner hidden"></div>

    <div class="topbar" aria-hidden="true">
      <div class="progress"><div id="bar" class="bar"></div></div>
      <div class="count"><span id="qnum">1</span> / <span id="qtotal">1</span> questions</div>
    </div>
    
    <!-- Q0: Gender (NEW) -->
    <div class="step" data-step-id="q0">
      <fieldset>
        <legend id="genderLegend">My child is a...</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="gender" value="Boy"> Boy</label>
          <label class="opt"><input type="radio" name="gender" value="Girl"> Girl</label>
        </div>
      </fieldset>
    </div>
    
    <!-- NOTE: Age step removed from wizard flow because it is now captured in setup -->
    <!-- The active age value is stored in currentChildAge variable in JS -->

    <!-- PATH 1: JR (5â€“7) -->
    <div class="step" data-step-id="q2A" data-show-if="age=5-7">
      <fieldset>
        <legend>Which of these best describe your child? <span class="hint">Choose up to 2</span></legend>
        <div class="opts">
          <label class="opt"><input type="checkbox" name="traits5" value="Curious"> Curious</label>
          <label class="opt"><input type="checkbox" name="traits5" value="Creative"> Creative</label>
          <label class="opt"><input type="checkbox" name="traits5" value="Shy"> Shy</label>
          <label class="opt"><input type="checkbox" name="traits5" value="Energetic"> Energetic</label>
          <label class="opt"><input type="checkbox" name="traits5" value="Observant"> Observant</label>
          <label class="opt"><input type="checkbox" name="traits5" value="Imaginative"> Imaginative</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q3A" data-show-if="age=5-7">
      <fieldset>
        <legend>What kind of play do they enjoy most? <span class="hint">Select all that apply</span></legend>
        <div class="opts">
          <label class="opt"><input type="checkbox" name="play5" value="Building"> Building (blocks, Legos, etc.)</label>
          <label class="opt"><input type="checkbox" name="play5" value="Imaginative"> Imaginative or pretend play</label>
          <label class="opt"><input type="checkbox" name="play5" value="Games"> Games on a tablet or device</label>
          <label class="opt"><input type="checkbox" name="play5" value="Arts"> Arts & crafts</label>
          <label class="opt"><input type="checkbox" name="play5" value="Outdoor"> Outdoor or active play</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q4A" data-show-if="age=5-7">
      <fieldset>
        <legend>When something doesnâ€™t work right away, they usuallyâ€¦</legend>
        <div class="opts grid-4">
          <label class="opt"><input type="radio" name="grit5" value="Keeps trying"> Keep trying</label>
          <label class="opt"><input type="radio" name="grit5" value="Asks for help"> Ask for help</label>
          <label class="opt"><input type="radio" name="grit5" value="Frustrated"> Get frustrated</label>
          <label class="opt"><input type="radio" name="grit5" value="Move on"> Move on quickly</label>
        </div>
      </fieldset>
    </div>

    <!-- PATH 2: 8â€“10 -->
    <div class="step" data-step-id="q2B" data-show-if="age=8-10">
      <fieldset>
        <legend>Which traits best describe your child? <span class="hint">Choose up to 2</span></legend>
        <div class="opts">
          <label class="opt"><input type="checkbox" name="traits8" value="Curious"> Curious</label>
          <label class="opt"><input type="checkbox" name="traits8" value="Creative"> Creative</label>
          <label class="opt"><input type="checkbox" name="traits8" value="Competitive"> Competitive</label>
          <label class="opt"><input type="checkbox" name="traits8" value="Social"> Social</label>
          <label class="opt"><input type="checkbox" name="traits8" value="Focused"> Focused</label>
          <label class="opt"><input type="checkbox" name="traits8" value="Distracted"> Easily distracted</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q3B" data-show-if="age=8-10">
      <fieldset>
        <legend>How does your child learn best? <span class="hint">Select all that apply</span></legend>
        <div class="opts">
          <label class="opt"><input type="checkbox" name="learn8" value="Hands-on"> Hands-on</label>
          <label class="opt"><input type="checkbox" name="learn8" value="Visual"> Visual examples</label>
          <label class="opt"><input type="checkbox" name="learn8" value="Listening"> Listening</label>
          <label class="opt"><input type="checkbox" name="learn8" value="With friends"> With friends</label>
          <label class="opt"><input type="checkbox" name="learn8" value="Step-by-step"> Step-by-step instructions</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q4B" data-show-if="age=8-10">
      <fieldset>
        <legend>How do they feel about school and learning? <span class="hint">Select all that apply</span></legend>
        <div class="opts grid-4">
          <label class="opt"><input type="checkbox" name="school8" value="Loves learning"> Loves learning</label>
          <label class="opt"><input type="checkbox" name="school8" value="Likes when fun"> Likes it when itâ€™s fun</label>
          <label class="opt"><input type="checkbox" name="school8" value="Bored"> Gets bored easily</label>
          <label class="opt"><input type="checkbox" name="school8" value="Struggles focus"> Struggles to stay focused</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q4B-1" data-show-if="school8=Bored,Struggles focus">
      <fieldset>
        <legend>What usually helps them re-engage?</legend>
        <div class="opts grid-4">
          <label class="opt"><input type="radio" name="reengage8" value="Encouragement"> Encouragement from adults</label>
          <label class="opt"><input type="radio" name="reengage8" value="Competition"> Friendly competition</label>
          <label class="opt"><input type="radio" name="reengage8" value="Rewards"> Rewards or milestones</label>
          <label class="opt"><input type="radio" name="reengage8" value="Freedom"> Freedom to do it their way</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q5B" data-show-if="age=8-10">
      <fieldset>
        <legend>How confident are they with technology?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="tech8" value="Beginner"> Beginner</label>
          <label class="opt"><input type="radio" name="tech8" value="Comfortable"> Comfortable</label>
          <label class="opt"><input type="radio" name="tech8" value="Advanced"> Advanced</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q5B-1" data-show-if="tech8=Advanced">
      <fieldset>
        <legend>What have they tried so far? <span class="hint">Select all that apply</span></legend>
        <div class="opts grid-4">
          <label class="opt"><input type="checkbox" name="tried8" value="Roblox/Minecraft"> Minecraft mods or Roblox Studio</label>
          <label class="opt"><input type="checkbox" name="tried8" value="Scratch"> Scratch / block coding</label>
          <label class="opt"><input type="checkbox" name="tried8" value="Robotics"> Robotics kits</label>
          <label class="opt"><input type="checkbox" name="tried8" value="Interested"> Not yet, but very interested</label>
        </div>
      </fieldset>
    </div>

    <!-- PATH 3: 11â€“13 -->
    <div class="step" data-step-id="q2C" data-show-if="age=11-13">
      <fieldset>
        <legend>Which traits best describe your child? <span class="hint">Choose up to 2</span></legend>
        <div class="opts">
          <label class="opt"><input type="checkbox" name="traits11" value="Creative"> Creative</label>
          <label class="opt"><input type="checkbox" name="traits11" value="Analytical"> Analytical</label>
          <label class="opt"><input type="checkbox" name="traits11" value="Competitive"> Competitive</label>
          <label class="opt"><input type="checkbox" name="traits11" value="Independent"> Independent</label>
          <label class="opt"><input type="checkbox" name="traits11" value="Team-player"> Team-player</label>
          <label class="opt"><input type="checkbox" name="traits11" value="Curious"> Curious</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q3C" data-show-if="age=11-13">
      <fieldset>
        <legend>When faced with a challenge, they usuallyâ€¦</legend>
        <div class="opts grid-4">
          <label class="opt"><input type="radio" name="challenge11" value="Persist"> Keep trying</label>
          <label class="opt"><input type="radio" name="challenge11" value="Research"> Research / experiment</label>
          <label class="opt"><input type="radio" name="challenge11" value="Frustrated"> Get frustrated easily</label>
          <label class="opt"><input type="radio" name="challenge11" value="Avoid"> Avoid difficult tasks</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q4C" data-show-if="age=11-13">
      <fieldset>
        <legend>How do they feel about school? <span class="hint">Select all that apply</span></legend>
        <div class="opts grid-4">
          <label class="opt"><input type="checkbox" name="school11" value="Motivated"> Motivated and focused</label>
          <label class="opt"><input type="checkbox" name="school11" value="Bored"> Does fine but gets bored</label>
          <label class="opt"><input type="checkbox" name="school11" value="Struggles"> Struggles to stay focused</label>
          <label class="opt"><input type="checkbox" name="school11" value="Disengaged"> Disengaged from classes</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q4C-1" data-show-if="school11=Bored,Disengaged,Struggles">
      <fieldset>
        <legend>What would help them enjoy learning more? <span class="hint">Select all that apply</span></legend>
        <div class="opts grid-4">
          <label class="opt"><input type="checkbox" name="enjoy11" value="Projects"> Real-world projects</label>
          <label class="opt"><input type="checkbox" name="enjoy11" value="Freedom"> Freedom to create</label>
          <label class="opt"><input type="checkbox" name="enjoy11" value="Tech/Games"> Using tech and games</label>
          <label class="opt"><input type="checkbox" name="enjoy11" value="Peers"> Working with peers</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q5C" data-show-if="age=11-13">
      <fieldset>
        <legend>How comfortable are they with technology?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="tech11" value="Beginner"> Beginner</label>
          <label class="opt"><input type="radio" name="tech11" value="Skilled"> Fairly skilled</label>
          <label class="opt"><input type="radio" name="tech11" value="Advanced"> Advanced (self-driven)</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q5C-1" data-show-if="tech11=Advanced">
      <fieldset>
        <legend>Would they enjoy helping others or leading projects?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="leader11" value="Yes"> Yes</label>
          <label class="opt"><input type="radio" name="leader11" value="Maybe"> Maybe</label>
          <label class="opt"><input type="radio" name="leader11" value="No"> Not right now</label>
        </div>
      </fieldset>
    </div>

    <!-- PATH 4: 14+ -->
    <div class="step" data-step-id="q2D" data-show-if="age=14+">
      <fieldset>
        <legend>What best describes what motivates your teen?</legend>
        <div class="opts grid-4">
          <label class="opt"><input type="radio" name="motivate14" value="Competition"> Competition & clear goals</label>
          <label class="opt"><input type="radio" name="motivate14" value="Recognition"> Recognition & achievements</label>
          <label class="opt"><input type="radio" name="motivate14" value="Curiosity"> Curiosity & learning</label>
          <label class="opt"><input type="radio" name="motivate14" value="Careers"> Preparing for careers</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q3D" data-show-if="age=14+,tech8=Advanced,tech11=Advanced">
      <fieldset>
        <legend>Which areas are they most interested in? <span class="hint">Choose up to 2</span></legend>
        <div class="opts">
          <label class="opt"><input type="checkbox" name="interest14" value="Game dev"> Game development</label>
          <label class="opt"><input type="checkbox" name="interest14" value="Robotics"> Robotics / engineering</label>
          <label class="opt"><input type="checkbox" name="interest14" value="AI"> AI & automation</label>
          <label class="opt"><input type="checkbox" name="interest14" value="Content"> Content creation / design</label>
          <label class="opt"><input type="checkbox" name="interest14" value="Mentor"> Tutoring / mentoring younger students</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q4D" data-show-if="age=14+">
      <fieldset>
        <legend>How confident are they with technology?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="tech14" value="Beginner"> Beginner</label>
          <label class="opt"><input type="radio" name="tech14" value="Intermediate"> Intermediate</label>
          <label class="opt"><input type="radio" name="tech14" value="Advanced"> Advanced</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q4D-1" data-show-if="tech14=Advanced,tech8=Advanced,tech11=Advanced">
      <fieldset>
        <legend>Are they interested in tech certifications or careers?</legend>
        <div class="opts">
          <label class="opt"><input type="radio" name="career14" value="Yes"> Yes</label>
          <label class="opt"><input type="radio" name="career14" value="Somewhat"> Somewhat</label>
          <label class="opt"><input type="radio" name="career14" value="Not yet"> Not yet</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="q5D" data-show-if="age=14+">
      <fieldset>
        <legend>Which growth area is most important this year?</legend>
        <div class="opts grid-4">
          <label class="opt"><input type="radio" name="growth14" value="Leadership"> Leadership</label>
          <label class="opt"><input type="radio" name="growth14" value="Time management"> Time management</label>
          <label class="opt"><input type="radio" name="growth14" value="Collaboration"> Collaboration</label>
          <label class="opt"><input type="radio" name="growth14" value="Creativity"> Creativity</label>
        </div>
      </fieldset>
    </div>

    <!-- SHARED GOALS -->
    <div class="step" data-step-id="q13">
      <fieldset>
        <legend>What are you hoping your child gains from Code Ninjas? <span class="hint">Select all that apply</span></legend>
        <div class="opts">
          <label class="opt"><input type="checkbox" name="goals" value="Confidence"> Confidence & self-belief</label>
          <label class="opt"><input type="checkbox" name="goals" value="Focus"> Focus & discipline</label>
          <label class="opt"><input type="checkbox" name="goals" value="Teamwork"> Teamwork & communication</label>
          <label class="opt"><input type="checkbox" name="goals" value="Academic"> Academic advantage</label>
          <label class="opt"><input type="checkbox" name="goals" value="Creativity"> Creativity & innovation</label>
          <label class="opt"><input type="checkbox" name="goals" value="Future skills"> Future skills (coding, AI, robotics)</label>
        </div>
      </fieldset>
    </div>

    <div class="step" data-step-id="qFuture" data-show-if="age=8-10,11-13">
      <fieldset>
        <legend>What future skill matters most to you for your child right now?</legend>
        <div class="opts">
          <label class="opt">
            <input type="radio" name="futurefocus" value="Coding core">
            A strong foundation in coding
          </label>
          <label class="opt">
            <input type="radio" name="futurefocus" value="Coding + AI">
            Coding plus early exposure to AI.
          </label>
          <label class="opt">
            <input type="radio" name="futurefocus" value="Coding + Robotics">
            Coding plus hands-on robotics
          </label>
          <label class="opt">
            <input type="radio" name="futurefocus" value="All three">
            Coding, AI, and robotics
          </label>
        </div>
      </fieldset>
    </div>

    <!-- Q15 DELETED AS REQUESTED -->

    <div class="step" data-step-id="q16">
      <fieldset>
        <legend>How important is it for kids to understand AI & emerging technology?</legend>
        <div class="opts grid-4">
          <label class="opt"><input type="radio" name="ai" value="Essential"> Essential</label>
          <label class="opt"><input type="radio" name="ai" value="Very"> Very important</label>
          <label class="opt"><input type="radio" name="ai" value="Somewhat"> Somewhat important</label>
          <label class="opt"><input type="radio" name="ai" value="Not sure"> Not sure yet</label>
        </div>
      </fieldset>
    </div>
    
    <!-- Q17 REMOVED AS REQUESTED -->

    <!-- MARKETING ATTRIBUTION SECTION - Tagged as 'marketing-step' to be skipped for subsequent children -->
    <div class="step marketing-step" data-step-id="q18">
      <p style="font-size:15px; margin:0 0 10px; line-height: 1.5; color: var(--ink);">
        <strong style="color: var(--brand);">Youâ€™re almost done!</strong><br>
        Thanks for sharing about your Ninja â€” just one last quick question before we wrap up.<br>
        As a thank-you for your time, youâ€™ll receive a temporary code to waive the $99 enrollment fee once you submit your answers below.
      </p>
      <fieldset>
        <legend>How did you first hear about Code Ninjas?</legend>
        <div class="hint">Choose one that best fits</div>
        <div class="opts">
          <label class="opt"><input type="radio" name="hearAbout" value="Friend"> Friend</label>
          <label class="opt"><input type="radio" name="hearAbout" value="School"> School</label>
          <label class="opt"><input type="radio" name="hearAbout" value="Social"> Social media</label>
          <label class="opt"><input type="radio" name="hearAbout" value="Search"> Google</label>
          <label class="opt"><input type="radio" name="hearAbout" value="Event"> Local event</label>
          <label class="opt"><input type="radio" name="hearAbout" value="Returning"> Returning family</label>
          <label class="opt"><input type="radio" name="hearAbout" value="Other"> Other (please specify)</label>
        </div>
      </fieldset>
    </div>

    <!-- Friend / another parent follow-up -->
    <div class="step marketing-step" data-step-id="q18A" data-show-if="hearAbout=Friend">
      <fieldset>
        <legend>What did they share that made you want to check us out?</legend>
        <div class="opts grid-4">
          <label class="opt"><input type="checkbox" name="hearFriendShare" value="Their child loved us"> Their child loved us</label>
          <label class="opt"><input type="checkbox" name="hearFriendShare" value="Improved focus and confidence"> Improved focus and confidence</label>
          <label class="opt"><input type="checkbox" name="hearFriendShare" value="Better performance in school"> Better performance in school</label>
          <label class="opt"><input type="checkbox" name="hearFriendShare" value="Something their child built"> Something their child built</label>
        </div>
      </fieldset>
    </div>

    <!-- School / teacher follow-up -->
    <div class="step marketing-step" data-step-id="q18B" data-show-if="hearAbout=School">
      <fieldset>
        <legend>How did the school share Code Ninjas?</legend>
        <div class="prestart-grid" style="margin-bottom:10px; display:block;">
            <input type="text" id="schoolNameInput" name="schoolNameInput" placeholder="School Name" class="step-input">
        </div>
        <div class="opts">
          <label class="opt"><input type="checkbox" name="schoolShare" value="Printed Flyer"> Printed Flyer</label>
          <label class="opt"><input type="checkbox" name="schoolShare" value="School newsletter/email"> School newsletter/email</label>
          <label class="opt"><input type="checkbox" name="schoolShare" value="In-school visit"> In-school visit</label>
          <label class="opt"><input type="checkbox" name="schoolShare" value="Teacher recommendation"> Teacher recommendation</label>
        </div>
      </fieldset>
    </div>

    <!-- Social media follow-up -->
    <div class="step marketing-step" data-step-id="q18C" data-show-if="hearAbout=Social">
      <fieldset>
        <legend>Which platform?</legend>
        <div class="opts grid-4">
          <label class="opt"><input type="radio" name="socialPlatform" value="Facebook"> Facebook</label>
          <label class="opt"><input type="radio" name="socialPlatform" value="Instagram"> Instagram</label>
          <label class="opt"><input type="radio" name="socialPlatform" value="TikTok"> TikTok</label>
          <label class="opt"><input type="radio" name="socialPlatform" value="Not sure"> Not sure</label>
        </div>
      </fieldset>
    </div>

    <!-- Google / online search follow-up -->
    <div class="step marketing-step" data-step-id="q18D" data-show-if="hearAbout=Search">
      <fieldset>
        <legend>What were you searching for when you found us?</legend>
        <div class="opts">
          <label class="opt"><input type="checkbox" name="searchTopics" value="Coding classes"> Coding classes</label>
          <label class="opt"><input type="checkbox" name="searchTopics" value="Robotics classes"> Robotics classes</label>
          <label class="opt"><input type="checkbox" name="searchTopics" value="AI programs"> AI programs</label>
          <label class="opt"><input type="checkbox" name="searchTopics" value="STEM classes or camps"> STEM classes or camps</label>
          <label class="opt"><input type="checkbox" name="searchTopics" value="After-school programs"> After-school programs</label>
          <label class="opt"><input type="checkbox" name="searchTopics" value="Summer camps"> Summer camps</label>
          <label class="opt"><input type="checkbox" name="searchTopics" value="Other"> Other</label>
        </div>
        <input type="text" name="searchOtherDetails" placeholder="If Other, please specify" class="step-input" style="margin-top:8px;">
      </fieldset>

      <fieldset style="margin-top:12px;">
        <legend>What made you click on Code Ninjas?</legend>
        <div class="opts">
          <label class="opt"><input type="checkbox" name="searchClickWhy" value="Program description"> Program description</label>
          <label class="opt"><input type="checkbox" name="searchClickWhy" value="Positive reviews"> Positive reviews</label>
          <label class="opt"><input type="checkbox" name="searchClickWhy" value="Convenient location"> Convenient location</label>
          <label class="opt"><input type="checkbox" name="searchClickWhy" value="Special offer"> Special offer</label>
          <label class="opt"><input type="checkbox" name="searchClickWhy" value="Free session"> Free session</label>
          <label class="opt"><input type="checkbox" name="searchClickWhy" value="Other"> Other</label>
        </div>
        <input type="text" name="clickOtherDetails" placeholder="If Other, please specify" class="step-input" style="margin-top:8px;">
      </fieldset>
    </div>

    <!-- Event follow-up -->
    <div class="step marketing-step" data-step-id="q18E" data-show-if="hearAbout=Event">
      <fieldset>
        <legend>Which event or location?</legend>
        <input type="text" name="eventDetails" placeholder="Event or Location Name" class="step-input">
      </fieldset>
    </div>

    <!-- Other follow-up -->
    <div class="step marketing-step" data-step-id="q18F" data-show-if="hearAbout=Other">
      <fieldset>
        <legend>Please tell us how you heard about us:</legend>
        <input type="text" name="otherDetails" placeholder="Details" class="step-input">
      </fieldset>
    </div>

    <div class="actions sticky">
      <button class="btn" id="backBtn" type="button">â—€ Back</button>
      <button class="btn primary" id="nextBtn" type="button">Next â–¶</button>
    </div>
  </section>

  <!-- LOADING / WAITING SCREEN -->
  <section id="loading" class="card hidden" aria-live="polite">
    <h2 id="loadingTitle">Analyzing resultsâ€¦</h2>
    <p id="loadingSub">Finding the best program for your Ninjaâ€¦</p>
    <div class="spinner" aria-hidden="true"></div>
  </section>

  <!-- RESULT VIEW -->
  <section id="result" class="card" aria-live="polite">
    <h2 id="personaTitle"></h2>
    <p id="personaBlurb"></p>
    <h2 id="recTitle"></h2>
    <p id="recBlurb"></p>
    <ul id="recPoints"></ul>

    <div id="funFact" class="hidden">
      <strong>Fun Fact for Your Ninja!</strong>
      <div id="funFactText"></div>
    </div>

    <h3 class="center" style="margin:24px 0 12px; color: var(--brand);">At-a-glance match</h3>
    <div id="stats"></div>

    <p class="center" id="centerNote" style="font-weight:bold; margin-bottom:24px;"></p>
    <div class="actions center" style="justify-content:center; margin-top:32px; flex-wrap:wrap;">
       <!-- If multi-child, this button will say "Next Child" -->
      <button class="btn primary" id="nextChildBtn" type="button" style="display:none; margin-bottom:12px;">Start Next Child â–¶</button>
      <button class="btn" id="retakeBtn" type="button">Back To Home</button>
    </div>
  </section>
</div>

<!-- Web3Forms form (hidden; includes required fields) -->
<!-- Target a hidden iframe to avoid redirection/reload on file:// -->
<iframe name="hidden_iframe" style="display:none;"></iframe>
<form id="web3Form" class="hidden" action="https://api.web3forms.com/submit" method="POST" target="hidden_iframe">
  <input type="hidden" name="access_key" value="fa23863b-372c-4f44-b8e4-dd8f0ec3b087">
  <input type="hidden" name="name" id="wf_name" required>
  <!-- Email removed as requested -->
  <textarea name="message" id="wf_message" style="display:none;" required></textarea>
  <input type="hidden" name="subject" id="wf_subject" value="New Ninja Path Finder Lead">
  <input type="hidden" name="from_name" value="Code Ninjas Program Finder">
</form>

<script>
(function(){
  const $  = (s,root=document) => root.querySelector(s);
  const $$ = (s,root=document) => Array.from(root.querySelectorAll(s));
  window.API_Access = true; // set to false to skip Web3Forms submit

  // ---------- PRESTART ----------
  const prestart = $('#prestart');
  const startBtn = $('#startQuizBtn');
  const childSetup = $('#child-setup');
  const confirmChildrenBtn = $('#confirmChildrenBtn');
  const childNamesArea = $('#child-names-area');
  const childNamesContainer = $('#child-names-inputs');
  
  const inputsPre = {
    parentFirst: $('#parentFirst'),
    parentLast:  $('#parentLast'),
    location:    $('#location')
  };
  
  let parentFirst = '', parentLast = '', centerLocation = '';
  let numChildren = 1;
  let childNames = []; // Array of {name, age} objects
  let currentChildIndex = 0; // 0-based index for flow
  let currentChildAge = ''; // Store current age for logic

  // ---------- CHILD SETUP LOGIC ----------
  // Listen for radio changes
  const childRadios = $$('input[name="numChildrenChoice"]', childSetup);
  childRadios.forEach(r => {
     r.addEventListener('change', updateChildInputs);
  });
  
  function updateChildInputs() {
    const selected = $('input[name="numChildrenChoice"]:checked', childSetup);
    const n = parseInt(selected ? selected.value : 1, 10);
    numChildren = n;
    
    childNamesContainer.innerHTML = '';
    
    if(n > 1) {
      childNamesArea.classList.remove('hidden');
    } else {
      // Even for 1 child, show input now to capture age and name
      childNamesArea.classList.remove('hidden'); 
    }
    
    for(let i=0; i<n; i++) {
      const group = document.createElement('div');
      group.className = 'child-info-group';
      
      const label = document.createElement('h4');
      label.textContent = `Child ${i+1}`;
      group.appendChild(label);
      
      const nameInp = document.createElement('input');
      nameInp.placeholder = `Name`;
      nameInp.className = 'step-input';
      nameInp.dataset.type = 'name';
      nameInp.dataset.index = i;
      nameInp.style.margin = '0'; // override step-input margin
      nameInp.addEventListener('input', validateChildSetup);
      group.appendChild(nameInp);
      
      const ageSelect = document.createElement('select');
      ageSelect.className = 'step-input';
      ageSelect.dataset.type = 'age';
      ageSelect.dataset.index = i;
      ageSelect.style.margin = '0';
      ageSelect.innerHTML = `
        <option value="">Select Age</option>
        <option value="5-7">5-7</option>
        <option value="8-10">8-10</option>
        <option value="11-13">11-13</option>
        <option value="14+">14+</option>
      `;
      ageSelect.addEventListener('change', validateChildSetup);
      group.appendChild(ageSelect);
      
      childNamesContainer.appendChild(group);
    }
    
    validateChildSetup();
  }

  function validateChildSetup(){
      const nameInputs = $$('input[data-type="name"]', childNamesContainer);
      const ageSelects = $$('select[data-type="age"]', childNamesContainer);
      
      const allFilled = nameInputs.every(i => i.value.trim().length > 0) && 
                        ageSelects.every(s => s.value !== "");
      
      confirmChildrenBtn.disabled = !allFilled;
      
      if(allFilled){
          childNames = nameInputs.map((inp, i) => ({
              name: inp.value.trim(),
              age: ageSelects[i].value
          }));
      }
  }

  function syncStartState(){
    parentFirst    = (inputsPre.parentFirst.value || '').trim();
    parentLast     = (inputsPre.parentLast.value  || '').trim();
    centerLocation = (inputsPre.location.value    || '').trim();
    startBtn.disabled = !(parentFirst && parentLast && centerLocation);
  }
  
  Object.values(inputsPre).forEach(el => {
    el.addEventListener('input', syncStartState);
    el.addEventListener('change', syncStartState);
  });

  // Auto-advance from first name to last name on space
  inputsPre.parentFirst.addEventListener('keydown', (e) => {
    if(e.key === ' ' || e.keyCode === 32) {
      e.preventDefault(); // Prevent space from being added
      inputsPre.parentLast.focus(); // Move focus to last name
    }
  });

  // ---------- GEMINI CONFIG (Pathfinder) ----------
  const GEMINI_API_KEY = "AIzaSyBsLtykpP5kAuEE4LVJiTx-HwxwQtg7GFA";
  const GEMINI_MODEL_CANDIDATES = [
    "gemini-2.5-flash-lite",
    "gemini-2.5-flash", 
    "gemini-3.0-pro-preview"
  ];

  // ---------- MONDAY.COM CONFIG ----------
  const MONDAY_API_KEY = "eyJhbGciOiJIUzI1NiJ9.eyJ0aWQiOjU4OTAyOTQzOSwiYWFpIjoxMSwidWlkIjo3NTMwMjU1MiwiaWFkIjoiMjAyNS0xMS0yMFQyMToxMjozNy41ODNaIiwicGVyIjoibWU6d3JpdGUiLCJhY3RpZCI6NDUyNzc2MiwicmduIjoidXNlMSJ9.a2Red9Ww-10aTnajvTYSY3L_wam9QXjymTnDPQilVvU";
  const MONDAY_BOARD_ID = "18386836956";
  const MONDAY_ENABLED = true;
  
  // Column ID mapping from Monday.com board
  const MONDAY_COLUMN_MAP = {
    "Location": "text_mkxwt53n",
    "Submitted Date": "date_mkxwqv92",
    "Number of Children": "numeric_mkxw3mg8",
    "Recommended Program": "text_mkxwqhx7",
    "Persona": "text_mkxwqt3c",
    "Persona Description": "long_text_mkxwrjmw",
    "Child Age Group": "text_mkxw4cpe",
    "Child Gender": "text_mkxw20nb",
    "Traits (5-7)": "long_text_mkxwdttr",
    "Play Preferences (5-7)": "long_text_mkxwa2pn",
    "Persistence (5-7)": "text_mkxwext4",
    "Traits (8-10)": "long_text_mkxwef2r",
    "Learning Style (8-10)": "text_mkxwf41x",
    "School Attitude (8-10)": "text_mkxwtjbj",
    "Re-engagement Method (8-10)": "text_mkxwwe8d",
    "Tech Confidence (8-10)": "text_mkxwg9ne",
    "Tech Experience (8-10)": "long_text_mkxwss9r",
    "Traits (11-13)": "long_text_mkxwd119",
    "Challenge Response (11-13)": "text_mkxwhsx0",
    "School Attitude (11-13)": "text_mkxwj8gy",
    "Enjoyment Factors (11-13)": "long_text_mkxwk6f7",
    "Tech Confidence (11-13)": "text_mkxwkkh4",
    "Leadership Interest (11-13)": "text_mkxwv77q",
    "Motivation (14+)": "text_mkxwwy4v",
    "Interests (14+)": "long_text_mkxwj3h3",
    "Tech Confidence (14+)": "text_mkxwajd",
    "Career Interest (14+)": "text_mkxw8m0e",
    "Growth Area (14+)": "text_mkxwdw5w",
    "Parent Goals": "long_text_mkxwxw14",
    "Future Focus": "text_mkxw5aqv",
    "AI Interest": "text_mkxwx5jj",
    "Marketing Source": "text_mkxwqcte",
    "Marketing Details": "long_text_mkxwztj1",
    "AI Email": "long_text_mkxwvzvf",
    "SMS Option 1": "long_text_mkxw2k76",
    "SMS Option 2": "long_text_mkxwmp0h",
    "Full Q&A Summary": "long_text_mkxwk1d6"
  };

  async function callGemini(promptText){
    if(!GEMINI_API_KEY){
      console.warn("Gemini API key is missing.");
      return null;
    }

    for(const model of GEMINI_MODEL_CANDIDATES){
      try {
        const res = await fetch(
          "https://generativelanguage.googleapis.com/v1beta/models/" + model + ":generateContent",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-goog-api-key": GEMINI_API_KEY
            },
            body: JSON.stringify({
              contents: [
                {
                  role: "user",
                  parts: [{ text: promptText }]
                }
              ]
            })
          }
        );

        if(!res.ok){
          // silently continue to next model
          continue;
        }

        const data = await res.json();
        const parts = data?.candidates?.[0]?.content?.parts || [];
        const text = parts.map(p => p.text || "").join("").trim();
        if(text){
          return text;
        }
      } catch(e){
        console.warn("Gemini request failed for model", model, e);
      }
    }
    return null;
  }

  // Parse EMAIL + 3 SMS options from Gemini
  function extractSection(text, label){
    const re = new RegExp(`---${label}---([\\s\\S]*?)(?=---[A-Z0-9]+---|$)`, 'i');
    const m = text.match(re);
    return m ? m[1].trim() : '';
  }

  async function generateAiComms(options){
    const {
      programDisplay,
      apiProgramName,
      personaLabel,
      funFact,
      bundleType,
      academyBundleType, // AI or Robotics for Academy paths
      marketingSource,
      marketingSubsource,
      qaSummaryLines,
      currentChildName // Added context
    } = options;
    
    // Get Gender from Q0
    const gender = options.gender || '';

    let bundleInstruction = "";
    if(bundleType === '1+1_AI'){
       bundleInstruction = `
ðŸ”¥ SPECIAL BUNDLE INSTRUCTION:
The recommended program is the "CREATE 1+1 Bundle".
You must refer to it specifically as "CREATE 1+1 Bundle" in both the Email and SMS.
This bundle combines "Code Ninjas CREATE" (their core belt progression) with "AI Academy" (their specific interest).
When explaining the fit, mention that this bundle gives them the best of both worlds: steady coding progress + exciting AI skills.
`;
    }

    const greetingName = parentFirst || "there";
    const centerName = centerLocation || "your local center";
    // Incorporate specific child name if multi-child
    const childRef = currentChildName ? currentChildName : "your child";
    
    // Construct pronoun hint based on gender
    let pronounHint = "";
    if(gender === 'Boy') pronounHint = `IMPORTANT: The child is a Boy. Use he/him/his pronouns when referring to ${childRef}.`;
    else if(gender === 'Girl') pronounHint = `IMPORTANT: The child is a Girl. Use she/her/her pronouns when referring to ${childRef}.`;
    else pronounHint = `Use they/them pronouns or the child's name when referring to ${childRef}.`;

    // BUNDLE / ACADEMY INSTRUCTIONS
    // Force AI to recommend either a Bundle or CREATE, never *just* Academy
    let programInstruction = "";
    
    // Determine the specific bundle type for Academy paths
    let specificBundleType = academyBundleType || '';
    if(!specificBundleType){
        if(bundleType === '1+1_Robotics') specificBundleType = 'Robotics';
        else if(bundleType === '1+1_AI') specificBundleType = 'AI';
        else if(apiProgramName === 'Code Ninjas Academy') specificBundleType = 'AI'; // Default
    }

    if(apiProgramName === 'Code Ninjas Academy') {
        // Even if they hit the Academy logic, we sell it as a 1+1 Bundle
        programInstruction = `
ðŸ”¥ PROGRAM INSTRUCTION:
The system recommended "CREATE 1+1 (${specificBundleType}) Bundle" (because they are Academy-ready).
You must refer to it specifically as "CREATE 1+1 (${specificBundleType}) Bundle" in both the Email and SMS.
This bundle combines "Code Ninjas CREATE" (their core belt progression) with "${specificBundleType} Academy" (their specific interest).
When explaining the fit, mention that this bundle gives them the best of both worlds: steady coding progress + ${specificBundleType === 'AI' ? 'exciting AI skills' : 'hands-on engineering skills'}.
Do NOT offer Academy as a standalone option. It is a bundle.
`;
    } else if(bundleType === '1+1_AI'){
       programInstruction = `
ðŸ”¥ SPECIAL BUNDLE INSTRUCTION:
The recommended program is the "CREATE 1+1 (AI) Bundle".
You must refer to it specifically as "CREATE 1+1 (AI) Bundle" in both the Email and SMS.
This bundle combines "Code Ninjas CREATE" (their core belt progression) with "AI Academy" (their specific interest).
When explaining the fit, mention that this bundle gives them the best of both worlds: steady coding progress + exciting AI skills.
`;
    } else if(bundleType === '1+1_Robotics'){
       programInstruction = `
ðŸ”¥ SPECIAL BUNDLE INSTRUCTION:
The recommended program is the "CREATE 1+1 (Robotics) Bundle".
You must refer to it specifically as "CREATE 1+1 (Robotics) Bundle" in both the Email and SMS.
This bundle combines "Code Ninjas CREATE" (their core belt progression) with "Robotics Academy" (their specific interest).
When explaining the fit, mention that this bundle gives them the best of both worlds: steady coding progress + hands-on engineering skills.
`;
    } else if(bundleType === '1+1+1'){
       programInstruction = `
ðŸ”¥ SPECIAL BUNDLE INSTRUCTION:
The recommended program is the "CREATE 1+1+1 Bundle".
You must refer to it specifically as "CREATE 1+1+1 Bundle" in both the Email and SMS.
This bundle combines "Code Ninjas CREATE", "Academy", and "Clubs".
When explaining the fit, mention that this bundle gives them the ultimate experience: coding, advanced skills (AI/Robotics), and social clubs.
`;
    }


    const prompt =
`YOU ARE AN ENROLLMENT ADVISOR AT CODE NINJAS

Your job is to convert families who visited for an in-center tour and filled out the Pathfinder questionnaire.

You generate:

A short, natural enrollment email (sent same evening)

A next-day SMS (sent at 4pm)

A 3-day SMS with 48-hour expiry urgency

Your job:

Use insights from the questionnaire WITHOUT EVER REFERENCING THE QUESTIONNAIRE

And convert them into emotionally persuasive, human messaging that feels like a real Enrollment Advisor who truly understood the child.

You must sound:

Warm, confident, future-focused, conversational, high-conversion, never pushy, never robotic.

${pronounHint}

${programInstruction}

ðŸ”¥ SECTION 1 â€” TRAIT INTERPRETATION ENGINE

Parents MUST feel like you saw their child.

You may never repeat traits literally

("curious," "competitive," "shy," "creative," "intellectual," etc.).

Instead, you must use translated observations based on traits:

Curious â†’ "They asked thoughtful questions once they got into the activity."

Creative â†’ "They put their own spin on things right away."

Competitive â†’ "Once they saw the challenge, they leaned in and wanted to get it working."

Shy â†’ "They opened up nicely once they felt comfortable with the tools."

Energetic â†’ "They were happiest when they could move between steps and keep momentum."

Easily distracted â†’ "They stayed engaged once they had something hands-on to work with."

Gets bored â†’ "They lit up when learning felt fast-paced and interactive."

Analytical â†’ "They liked understanding how things worked before moving on."

Intellectual â†’ "They think deeply about things and enjoy making sense of how things connect."

Use one or two translated observations in each message â€” no more.

NEVER say:

"based on your answers,"

"you selected,"

"you shared,"

"the questionnaire said."

ðŸ”¥ SECTION 2 â€” SESSION CONTEXT PHRASES (MANDATORY)

The email + SMS must reference THEIR specific session.

Use only the appropriate lines based on program:

JR (Ages 5â€“7)

Use phrases like:

"hands-on STEM activities"

"little engineering challenges"

"creative building time"

"their building activity today"

CREATE (Ages 8â€“13)

Use:

"their game-building session"

"experimenting with game logic"

"designing their first playable element"

"getting something on the screen to move or react"

ACADEMY (Ages 14+)

Use:

"their advanced game-building/tech session"

"approaching the tools with real maturity"

"diving into more advanced concepts"

You may also use believable micro-observations:

"They really locked in once they realized they could make something move."

"They were proud when they got that first piece working."

ðŸ”¥ SECTION 3 â€” PROGRAM-SPECIFIC PERSUASION

Use ONLY the persuasion style matching the recommended program:

JR (Ages 5â€“7)

Focus on:

confidence

early problem-solving

hands-on discovery

structure without pressure

independence at their pace

Language you may use:

"JR gives them the perfect blend of structure and playful exploration."

"Kids grow fast when learning feels like building, creating, and discovering."

CREATE (Ages 8â€“13)

Focus on:

engagement

small wins

creativity + logic

belt progression

consistency leading to mastery

Language you may use:

"CREATE keeps kids engaged because they get to build REAL games with instant results."

"The belt system gives both structure and challenge â€” perfect for kids who thrive when they can see progress."

ACADEMY (14+)

Focus on:

future skills

project ownership

responsibility

portfolio building

leadership

AI, robotics, or advanced coding

Language you may use:

"ACADEMY gives teens real-world experience that actually matters â€” in high school, on resumes, and beyond."

"It channels their interests into meaningful projects they can feel proud of."

ðŸ”¥ SECTION 4 â€” TONE MATRIX

Choose the best tone automatically:

Soft / Nurturing Tone

Use when:

child is shy, anxious, young, easily frustrated

parent prioritizes confidence or comfort

Use phrases:

"at their own pace"

"feel comfortable and supported"

"build confidence gently"

High-Conversion / Confident Tone (DEFAULT)

Use when:

parent wants future skills

child is advanced

academic advantage

AI importance

robotics/coding interest

Use:

"This is the ideal next step."

"They're ready for something more challenging."

"This path will move them forward quickly."

ðŸ”¥ SECTION 5 â€” "SKILLS OVER JOBS" LOGIC

Only include this theme when BOTH are true:

Parent selected Future skills (coding, AI, robotics)

AND

Parent selected AI importance = Essential or Very important

You may write lines like:

"The world is changing quickly, and the kids who learn how technology works will have an advantage in anything they pursue."

"We focus on skills that never expire â€” problem-solving, creativity, and computational thinking."

Never mention "skills over jobs" unless BOTH triggers are present.

ðŸ”¥ SECTION 6 â€” EDUCATIONAL INSIGHT LIBRARY

When needed, you may insert ONE insight from this library.

Confidence & Focus

"Debugging builds persistence â€” kids learn to push through challenges."

"Structured wins build real confidence."

Creativity

"Kids learn 2Ã— more when they create, not just consume."

Future Skills / AI

"By 2030, most careers will use skills not taught in traditional classrooms."

"AI doesn't replace creativity â€” it multiplies it."

Analytical / Intellectual

"Kids who enjoy understanding how things work naturally thrive with coding."

"Structured challenges strengthen critical thinking and memory."

Use only one insight per message.

ðŸ”¥ SECTION 7 â€” EMAIL REQUIREMENTS

Format:

Start with:

"Dear ${greetingName},"

Email must contain:

Warm observation about child (translated, never literal)

Reference to their session type (JR/CREATE/ACADEMY)

Why the recommended program fits

Enrollment invitation

Include EXACT sentence:

"As a thank-you for taking the time to complete this questionnaire, you can enroll using this link: [ENROLLMENT_LINK]. Use code C9J5 at checkout to waive the enrollment fee if you enroll in the next few days."

Close with:

Warmly,

[Center Director Name]

Code Ninjas ${centerName}

Length:

â‰¤ 3 short paragraphs

â‰¤ 160 words

No emojis

No corporate tone

ðŸ”¥ SECTION 8 â€” SMS RULES

SMS #1 â€” Next Day at 4pm

1â€“2 sentences

Use one translated observation

Tie to parent goal

Mention hands-on activity

Include [ENROLLMENT_LINK]

Say offer expires "in the next few days" (never say 48 hours)

SMS #2 â€” 3 Days Later

1â€“2 sentences

Use one positive observation

Mention code C9J5

Say it expires in 48 hours

Include [ENROLLMENT_LINK]

ðŸ”¥ SECTION 9 â€” PRIMARY & BACKUP CLOSING SCRIPTS (AI MUST USE THIS LOGIC INTERNALLY)

PRIMARY SCRIPT (value only â€” NO discount)

Short, confident, tied to traits, program, and goals.

Examples the AI may use internally:

"Kids grow quickly when they can build real things â€” this program fits them perfectly."

"They were ready for something more structured and challenging."

"This is exactly the right place for them to build the skills you care about."

BACKUP SCRIPT (value + discount)

Only triggered after hesitation.

Short. Human. Non-pushy.

Examples:

"He's in a great spot to build on what he started today. If it helps, I can waive the $99 enrollment fee today."

"Given how well she connected with the activity, I'd love to make this easier â€” I can waive the $99 fee."

The AI never mentions these scripts to the parent â€” only uses them to craft email & SMS tone.

ðŸ”¥ SECTION 10 â€” OBJECTION HANDLING (4 TYPES)

These shape tone, not literal content.

1. Talk to Spouse

Respectful

Mention the email will include everything

No pressure

2. Schedule

"We operate like a gym â€” drop in anytime we're open."

3. Engagement Concern

Use the long-form philosophy internally for tone:

Coding is challenging

Growth happens through frustration

Mentors guide without giving answers

Breakthrough moments spark confidence

Parents & dojo work together

This is an investment, not an extracurricular

Microsoft-based curriculum

Kids advance at their own pace

4. Financial

Keep soft

Focus on value and long-term skills

Do NOT offer additional discounts beyond the code C9J5

ðŸ”¥ SECTION 11 â€” DISCOUNT LOGIC

Never mentioned in primary script

Only appears in email sentence + SMS1/SMS2

SMS1: "expires in the next few days"

SMS2: "expires in 48 hours"

ðŸ”¥ SECTION 12 â€” FOLLOW-UP TIMING RULES

AI must assume:

Same-day email (4â€“8pm)

SMS #1 â†’ next day at 4pm

SMS #2 â†’ 3 days later

Do not reference time in messages.

ðŸ”¥ SECTION 13 â€” MARKETING SOURCE LOGIC

Use the insight subtly:

Friend â†’ emphasize community

Google â†’ clarity + trust

School â†’ academic alignment

Social Media â†’ curiosity + excitement

Never mention the questionnaire.

ðŸ”¥ SECTION 14 â€” OUTPUT FORMAT

Return exactly:

---EMAIL---

<email content>

 

---SMS1---

<text>

 

---SMS2---

<text>

No additional text. No commentary.

DATA CONTEXT:
- Parent Name: ${greetingName}
- Child Name: ${childRef}
- Child Gender: ${gender}
- Center Location: ${centerName}
- Recommended Program: ${programDisplay}
- Program Family: ${apiProgramName}
- Bundle Type: ${bundleType || "Standard"}
- Marketing Source: ${marketingSource || "N/A"}
- Survey Answers (use for insights, never reference directly):
${(qaSummaryLines || []).map(l => "  - " + l).join("\n")}`;

    const raw = await callGemini(prompt);
    if(!raw) return null;

    const email = extractSection(raw, 'EMAIL');
    const sms1  = extractSection(raw, 'SMS1');
    const sms2  = extractSection(raw, 'SMS2');
    // SMS3 removed from prompt
    const sms = [sms1, sms2].filter(Boolean).map(s => s.replace(/\s+/g,' ').trim());

    if(!email || sms.length === 0) return null;

    return { email: email.trim(), sms };
  }

  // Fallback if Gemini fails
  function buildFallbackComms(programDisplay, childName){
    const greetingName = parentFirst || 'there';
    const centerName = centerLocation || 'your local center';
    const childRef = childName || 'your child';

    const email =
`Dear ${greetingName},

It was truly a pleasure meeting you and ${childRef} today. Hearing about your family and seeing your Ninjaâ€™s excitement in the dojo made it clear theyâ€™re a great fit for a creative, engaging learning environment.

From our conversation and the Pathfinder results, ${programDisplay} lines up with what you want â€” a balance of structure, hands-on challenge, and a fun way to build real-world coding and problem-solving skills.

As a thank-you for taking the time to complete this questionnaire, you can enroll using this link: [ENROLLMENT_LINK]. Use code C9J5 at checkout to waive the enrollment fee if you enroll in the next few days.

Warmly,
[Center Director Name]
Code Ninjas ${centerName}`;

    const sms = [
      `Code Ninjas ${centerName}: It was great meeting you and ${childRef} yesterday. From what you shared, ${programDisplay} gives them a fun way to build confidence, focus, and real tech skills. Sign up here: [ENROLLMENT_LINK] (offer ends in a few days).`,
      `We loved having you and ${childRef} at Code Ninjas ${centerName}. ${programDisplay} is a great fit for the mix of creativity and structure youâ€™re looking for. You can enroll at [ENROLLMENT_LINK] and use code C9J5 at checkout to waive the enrollment fee within 48 hours.`
    ];

    return { email, sms };
  }

  // ---------- WIZARD STATE ----------
  const wizard = $('#wizard');
  const bar = $('#bar');
  const qnum = $('#qnum');
  const qtotalSpan = $('#qtotal');
  const backBtn = $('#backBtn');
  const nextBtn = $('#nextBtn');
  const result = $('#result');
  const loadingSection = $('#loading');
  const loadingTitle = $('#loadingTitle');
  const loadingSub = $('#loadingSub');
  const allSteps = $$('.step');
  const childContextBanner = $('#childContextBanner');
  const nextChildBtn = $('#nextChildBtn');
  const retakeBtn = $('#retakeBtn'); // Now "Back To Home"

  let visibleSteps = [];
  let idx = 0;
  let isSubmitting = false;
  let loadingIntervalId = null;
  const loadingPhrases = [
    'Finding the best program for your Ninjaâ€¦',
    'Matching your Ninjaâ€™s strengths and goalsâ€¦',
    'Reviewing your answers with our AI assistantâ€¦',
    'Preparing your personalized recommendationâ€¦'
  ];

  function startLoading(){
    wizard.classList.add('hidden');
    result.style.display = 'none';
    loadingSection.classList.remove('hidden');
    loadingTitle.textContent = 'Analyzing resultsâ€¦';
    loadingSub.textContent = loadingPhrases[0];
    let i = 0;
    if(loadingIntervalId) clearInterval(loadingIntervalId);
    loadingIntervalId = setInterval(() => {
      i = (i + 1) % loadingPhrases.length;
      loadingSub.textContent = loadingPhrases[i];
    }, 2200);
    window.scrollTo({ top:0, behavior:'smooth' });
  }

  function stopLoading(){
    if(loadingIntervalId){
      clearInterval(loadingIntervalId);
      loadingIntervalId = null;
    }
    loadingSection.classList.add('hidden');
  }

  function parseCondition(cond){
    if(!cond) return null;
    const [name, values] = cond.split('=');
    if(!name || !values) return null;
    const allowed = values.split(',').map(v => v.trim());
    return { name: name.trim(), values: allowed };
  }

  function getValue(name){
    if (name === 'age') return currentChildAge; // Use dynamic age

    const radios = $$('input[type=radio][name="'+name+'"]');
    if(radios.length){
      const checked = radios.find(r => r.checked);
      return checked ? checked.value : '';
    }
    const checks = $$('input[type=checkbox][name="'+name+'"]:checked');
    if(checks.length){
      return checks.map(c => c.value);
    }
    return '';
  }
  
  // Helper to clear values for next child
  function clearFormValues() {
     // Select inputs inside wizard only
     const allInputs = $$('input, textarea, select', wizard);
     allInputs.forEach(inp => {
        // SKIP marketing inputs so we persist attribution across children
        if(inp.closest('.marketing-step')) return;

        if(inp.type === 'radio' || inp.type === 'checkbox') inp.checked = false;
        else inp.value = '';
     });
  }

  function conditionMatches(cond){
    const c = parseCondition(cond);
    if(!c) return true;
    const val = getValue(c.name);
    if(Array.isArray(val)){
      return val.some(v => c.values.includes(v));
    }
    return c.values.includes(val);
  }

  function recomputeVisibleSteps(){
    visibleSteps = allSteps.filter(step => {
      // Skip Q1 (Age) as it's pre-selected now
      if(step.dataset.stepId === 'q1') return false;

      // Logic to hide marketing questions for 2nd+ child
      if(currentChildIndex > 0 && step.classList.contains('marketing-step')) return false;

      const cond = step.getAttribute('data-show-if');
      if(!cond) return true;
      
      // Advanced logic override: If child is 8-13 but Advanced...
      const t8 = getValue('tech8');
      const t11 = getValue('tech11');
      const isAdvancedChild = (t8 === 'Advanced' || t11 === 'Advanced');
      const isActually14Plus = (currentChildAge === '14+');

      // 1. HIDE standard path questions if they are now on the Advanced track
      // These are questions specific to 8-10 or 11-13 that come AFTER the tech confidence question
      // standard questions: q5B-1 (tried8), q5C-1 (leader11)
      // note: q5B and q5C are where they select 'Advanced', so we must keep those visible.
      if (isAdvancedChild && !isActually14Plus) {
         if (['q5B-1', 'q5C-1'].includes(step.dataset.stepId)) return false;
      }

      // 2. For Advanced 8-13 year olds, ONLY show age-appropriate Academy questions
      // Skip questions that say "teen" or are redundant
      if (isAdvancedChild && !isActually14Plus) {
         // q2D says "motivates your teen" - SKIP for younger kids
         if (step.dataset.stepId === 'q2D') return false;
         // q4D asks tech confidence again - SKIP (redundant, they already answered)
         if (step.dataset.stepId === 'q4D') return false;
         // q5D (growth area) - could work but let's skip to keep it simple
         if (step.dataset.stepId === 'q5D') return false;
         // q3D (interests) and q4D-1 (certifications) - SHOW these (age-appropriate)
         if (['q3D', 'q4D-1'].includes(step.dataset.stepId)) {
             return true;
         }
      }

      return conditionMatches(cond);
    });
    allSteps.forEach(s => s.classList.remove('active'));
    if(idx >= visibleSteps.length) idx = visibleSteps.length - 1;
    if(idx < 0) idx = 0;
    updateUI();
  }

  function updateUI(){
    visibleSteps.forEach((s,i) => s.classList.toggle('active', i === idx));
    const total = visibleSteps.length || 1;
    qtotalSpan.textContent = total;
    qnum.textContent = idx + 1;
    bar.style.width = (idx / Math.max(total - 1, 1)) * 100 + '%';
    backBtn.disabled = idx === 0;

    const active = visibleSteps[idx];
    let disableNext = false;

    if(active){
      // Require at least one radio per group on this step
      const radios = $$('input[type=radio]', active);
      if(radios.length){
        const names = [...new Set(radios.map(r => r.name))];
        names.forEach(name => {
          const group = $$('input[type=radio][name="'+name+'"]', active);
          if(group.length && !group.some(r => r.checked)){
            disableNext = true;
          }
        });
      }

      // NEW: Require at least one checkbox checked on any step that has checkboxes
      const checkboxes = $$('input[type=checkbox]', active);
      if(checkboxes.length){
        const anyChecked = checkboxes.some(c => c.checked);
        if(!anyChecked){
          disableNext = true;
        }
      }
    }

    const currentName = (numChildren > 1 && childNames[currentChildIndex]) ? childNames[currentChildIndex].name : '';
    if (idx === visibleSteps.length - 1) {
       nextBtn.textContent = currentName ? `See Results for ${currentName} â–¶` : 'See Results â–¶';
    } else {
       nextBtn.textContent = 'Next â–¶';
    }
    
    nextBtn.disabled = disableNext;
  }

  wizard.addEventListener('change', recomputeVisibleSteps);
  visibleSteps = allSteps; updateUI();

  // ---------- START QUIZ ----------
  startBtn.addEventListener('click', () => {
    syncStartState();
    if(!(parentFirst && parentLast && centerLocation)) return;
    
    prestart.classList.add('hidden');
    childSetup.classList.remove('hidden'); // Show child setup first
    // Force update incase default radio is checked
    updateChildInputs();
  });
  
  confirmChildrenBtn.addEventListener('click', () => {
     // This is the real start of the wizard
     childSetup.classList.add('hidden');
     wizard.classList.remove('hidden');
     
     currentChildIndex = 0;
     startChildQuiz();
  });

  function startChildQuiz() {
     idx = 0;
     clearFormValues();
     
     // Set current child data context
     const activeChild = childNames[currentChildIndex];
     currentChildAge = activeChild.age;
     
     // Show context banner if multi-child
     if(numChildren > 1) {
        childContextBanner.textContent = `Questionnaire for ${activeChild.name}`;
        childContextBanner.classList.remove('hidden');
        $('#genderLegend').textContent = `${activeChild.name} is a...`;
     } else {
        childContextBanner.classList.add('hidden');
        $('#genderLegend').textContent = `My child is a...`;
     }
     
     recomputeVisibleSteps();
     updateUI();
  }

  // ---------- NAV ----------
  backBtn.addEventListener('click', () => {
    if(isSubmitting) return;
    if(idx>0){ idx--; updateUI(); }
  });

  nextBtn.addEventListener('click', async () => {
    if(isSubmitting) return;

    if(idx < visibleSteps.length - 1){
      idx++;
      updateUI();
    } else {
      isSubmitting = true;
      startLoading();
      try {
        await computeResultsAndSubmit();
      } finally {
        isSubmitting = false;
      }
    }
  });

  // ---------- MULTI-CHILD LOGIC ----------
  nextChildBtn.addEventListener('click', () => {
     // Go to next child
     currentChildIndex++;
     if(currentChildIndex < numChildren) {
        result.style.display = 'none';
        wizard.classList.remove('hidden');
        startChildQuiz();
     }
  });

  // ---------- LABEL HELPERS ----------
  function radioLabel(name){
    const el = document.querySelector('input[name="'+name+'"]:checked');
    if(!el) return '';
    const lab = el.closest('label');
    return lab ? lab.textContent.trim() : el.value;
  }
  function checkboxLabels(name){
    return Array.from(document.querySelectorAll('input[name="'+name+'"]:checked')).map(el => {
      const lab = el.closest('label');
      return lab ? lab.textContent.trim() : el.value;
    });
  }
  function textValue(name){
    const input = document.querySelector('[name="'+name+'"]');
    if(!input) return '';
    return (input.value || '').trim();
  }
  function getLegendForInputName(name){
    const input = document.querySelector('[name="'+name+'"]');
    if(!input) return '';
    const fs = input.closest('fieldset');
    if(!fs) return '';
    const legend = fs.querySelector('legend');
    if(!legend) return '';
    const clone = legend.cloneNode(true);
    clone.querySelectorAll('span').forEach(s => s.remove());
    return clone.textContent.trim();
  }

  // ---------- PROGRAM SELECTION ----------
  function baseProgramKey(age){
    // NEW: Check for advanced status to recommend ACADEMY even for 8-13
    const tech8 = getValue('tech8');
    const tech11 = getValue('tech11');

    if(age === '5-7') return 'JR';
    if(age === '14+') return 'ACADEMY';
    
    // If 8-13 but Advanced, push to ACADEMY logic (which may offer bundles or academy track)
    if((age === '8-10' && tech8 === 'Advanced') || (age === '11-13' && tech11 === 'Advanced')){
        return 'ACADEMY';
    }

    if(age === '8-10' || age === '11-13') return 'CREATE';
    return 'CREATE';
  }

  function chooseCreateBundle(){
    const future = getValue('futurefocus');
    const goals = checkboxLabels('goals');
    const tech8 = getValue('tech8');
    const tech11 = getValue('tech11');

    if(future === 'All three'){
      return { label:'1+1+1 Bundle', type:'1+1+1' };
    }
    if(future === 'Coding + AI'){
      return { label:'1+1 Bundle (CREATE + AI Academy)', type:'1+1_AI' };
    }
    if(future === 'Coding + Robotics'){
      return { label:'1+1 Bundle (CREATE + Robotics Academy)', type:'1+1_Robotics' };
    }
    if(future === 'Coding core'){
      return { label:'2x/Week', type:'2x' };
    }
    if(future === 'Not sure'){
      if(goals.includes('Future skills') || tech8 === 'Advanced' || tech11 === 'Advanced'){
        return { label:'1+1 Bundle (CREATE + AI Academy)', type:'1+1_AI' };
      }
      return { label:'2x/Week', type:'2x' };
    }
    if(goals.includes('Future skills') || tech8 === 'Advanced' || tech11 === 'Advanced'){
      return { label:'1+1 Bundle (CREATE + AI Academy)', type:'1+1_AI' };
    }
    return { label:'2x/Week', type:'2x' };
  }

  // Persona determination logic based on updated requirements
  function determinePersona() {
    const age = getValue('age');
    const tech8 = getValue('tech8');
    const tech11 = getValue('tech11');
    const tech14 = getValue('tech14');
    const learn8 = getValue('learn8');
    const school11 = getValue('school11');
    const interest14 = checkboxLabels('interest14');
    const traits8 = checkboxLabels('traits8');
    const traits11 = checkboxLabels('traits11');
    const traits5 = checkboxLabels('traits5');
    const play5 = checkboxLabels('play5'); // Changed to checkboxes in prev step
    const grit5 = getValue('grit5');
    const challenge11 = getValue('challenge11');
    const tried8 = checkboxLabels('tried8'); // Changed to checkboxes
    const goals = checkboxLabels('goals');
    const interestMentor = interest14.includes('Mentor');
    
    const matches = [];

    // 1. Digital Explorer
    if (tech8 === 'Advanced' || tech11 === 'Advanced' || tech14 === 'Advanced') {
      // Add logic to show 14+ questions if they haven't been seen yet
      // NOTE: The UI logic (recomputeVisibleSteps) handles showing the questions.
      // This logic is just for Persona selection.
      
      matches.push({
        title: "The Digital Explorer",
        blurb: "Your child is self-driven and needs accelerated, complex content. The CREATE belt system allows them to progress at their pace, and our Academies offer the advanced topics (like AI and real code) they crave."
      });
    }

    // 2. Structured Learner
    if (learn8.includes('Step-by-step') || school11.includes('Motivated')) {
      matches.push({
        title: "The Structured Learner",
        blurb: "They excel with clear goals and defined milestones. The CREATE belt system, with its clear curriculum path and defined Belts, perfectly matches their need for order and measurable progress."
      });
    }

    // 3. Hands-On Engineer
    if (interest14.includes('Robotics') || traits11.includes('Analytical') || (age === '8-10' && learn8.includes('Hands-on'))) {
      matches.push({
        title: "The Hands-On Engineer",
        blurb: "This child connects best with physical outcomes. They're an excellent candidate for the Robotics Academy bundle, blending coding logic with tangible engineering projects."
      });
    }

    // 4. Game Designer
    if (interest14.includes('Game dev') || tried8.includes('Roblox/Minecraft')) {
      matches.push({
        title: "The Game Designer",
        blurb: "Their passion is creation through play. The CREATE belt system, which is fundamentally structured around building and publishing video games, harnesses this core interest immediately."
      });
    }

    // 5. Debugging Master
    if (grit5 === 'Keeps trying' || challenge11 === 'Persist' || challenge11 === 'Research') {
      matches.push({
        title: "The Debugging Master",
        blurb: "This child has the grit and resilience necessary to overcome complex coding challenges. They will thrive in the self-paced CREATE dojo, where errors are viewed as learning opportunities."
      });
    }

    // 6. Collaborative Coder
    if (traits8.includes('Social') || traits11.includes('Team-player') || interestMentor) {
      matches.push({
        title: "The Collaborative Coder",
        blurb: "They're motivated by peer interaction. The open dojo setting and group collaboration opportunities (Clubs, ACADEMY) fuel their desire to work with others while learning to code."
      });
    }

    // 7. Digital Innovator
    if (goals.includes('Future skills') || tech8 === 'Advanced' || tech11 === 'Advanced' || tech14 === 'Advanced') {
      matches.push({
        title: "The Digital Innovator",
        blurb: "This profile is seeking cutting-edge knowledge. They are a prime fit for CREATE Bundles (AI Academy) or the ACADEMY track, focusing on modern tools and career readiness."
      });
    }

    // 8. The Storyteller
    if (age === '5-7' && play5.includes('Imaginative')) {
      matches.push({
        title: "The Storyteller",
        blurb: "This child responds best to narrative learning. The JR program uses story-driven, hands-on activities to introduce the logic and sequencing required for early coding concepts."
      });
    }

    // 9. Hands-On Architect
    if (age === '5-7' && play5.includes('Building')) {
      matches.push({
        title: "The Hands-On Architect",
        blurb: "This child understands physical structure and assembly. The JR program uses tactile, hands-on materials to build sequences, leveraging their existing strength in 3D construction to teach abstract logic."
      });
    }

    // 10. Curious Novice
    if (age === '5-7' || tech8 === 'Beginner' || tech11 === 'Beginner' || tech14 === 'Beginner') {
      matches.push({
        title: "The Curious Novice",
        blurb: "This profile needs a gentle, low-pressure introduction to technology. The program must prioritize confidence-building and foundational concepts over complex skills initially."
      });
    }

    if (matches.length > 0) {
      return matches[0]; // Return the first match found (priority order)
    }

    // Defaults (Randomized if no match)
    const defaults = [
      {
        title: "The Code Ninja in Training",
        blurb: "Your child shows a balanced mix of curiosity and potential. Our program adapts to their pace, helping them discover their specific passionsâ€”whether thatâ€™s building games, controlling robots, or writing code."
      },
      {
        title: "The Future Tech Leader",
        blurb: "With a solid foundation and the right guidance, your child is ready to step into the world of technology. We focus on building not just coding skills, but the confidence and logic they need for the future."
      },
      {
        title: "The Creative Thinker",
        blurb: "Your child approaches problems with a unique perspective. Our creative curriculum allows them to express that imagination through digital building, turning their ideas into playable reality."
      }
    ];
    
    return defaults[Math.floor(Math.random() * defaults.length)];
  }

  function buildProgramUI(age){
    const key = baseProgramKey(age);

    if(key === 'JR'){
      return {
        uiTitle: 'Recommended Program: Code Ninjas JR',
        uiBlurb: 'Playful, story-driven sessions where young Ninjas (5â€“7) explore early coding, logic, and creativity with tons of encouragement.',
        bullets: [
          'Gentle, game-based introduction to core concepts',
          'Hands-on projects that feel like play, not like school',
          'Builds early confidence, focus, and curiosity'
        ],
        stats: [
          ['5â€“7', 'Ideal ages'],
          ['Play-based', 'Learning style'],
          ['2â€“3 hrs / week', 'Recommended time'],
          ['Small groups', 'Mentor support'],
          ['Early logic', 'Patterns & sequencing'],
          ['Fun & safe', 'Dojo environment']
        ],
        apiProgram: 'Code Ninjas JR',
        bundleType: null
      };
    }

    if(key === 'ACADEMY'){
      return {
        uiTitle: 'Recommended Program: CREATE 1+1 Bundle',
        uiBlurb: 'A deeper track for motivated ninjas ready for real-world coding + AI or Engineering projects. Combines Code Ninjas CREATE (core coding) with an Academy of their choice.',
        bullets: [
          'Project-based learning in coding, AI, or robotics',
          'Core belt progression + specialized Academy track',
          'A community of like-minded, driven Ninjas'
        ],
        stats: [
          ['Advanced', 'Challenge level'],
          ['2â€“3 hrs / week', 'Recommended time'],
          ['Real projects', 'Portfolio-ready'],
          ['Mentorship', 'Guided growth'],
          ['Future-focused', 'College & career skills']
        ],
        apiProgram: 'Code Ninjas Academy',
        bundleType: '1+1_Academy' // Mark as generic bundle for AI prompt
      };
    }

    // CREATE with bundles
    const bundle = chooseCreateBundle();

    let stats = [
      ['8â€“13', 'Ideal ages'],
      ['Belt system', 'Built-in motivation'],
      ['3â€“4 hrs / week', 'Recommended time'],
      ['Game creation', 'High engagement'],
      ['Future skills', 'Coding & logic'],
      ['Mentor support', 'Guided progress']
    ];

    let variantLine = '';
    let bulletsExtra = [];

    if(bundle.type === '2x'){
      variantLine = ' Code Ninjas CREATE (2x/Week)';
      stats[2] = ['3â€“4 hrs / week', 'Recommended time'];
      bulletsExtra = [
        'Two focused CREATE sessions each week for consistent progress',
        'Locked in on coding fundamentalsâ€”no additional academies or clubs',
        'Perfect when you want depth and mastery in one powerful track'
      ];
    } else if(bundle.type === '1+1_AI'){
      variantLine = ' CREATE 1+1 Bundle';
      stats[2] = ['2â€“3 hrs / week', 'Recommended time'];
      bulletsExtra = [
        'One CREATE session + one AI Academy session each week',
        'Blend core coding with age-appropriate AI concepts and tools',
        'Great for future-facing Ninjas curious about smart technology'
      ];
    } else if(bundle.type === '1+1_Robotics'){
      variantLine = ' Code Ninjas CREATE (1+1 Bundle: CREATE + Robotics Academy)';
      stats[2] = ['2â€“3 hrs / week', 'Recommended time'];
      bulletsExtra = [
        'One CREATE session + one Robotics Academy session each week',
        'Turn code into motion with engineering challenges and builds',
        'Ideal for hands-on builders who love to see things move'
      ];
    } else if(bundle.type === '1+1+1'){
      variantLine = ' Code Ninjas CREATE (1+1+1 Bundle: Coding + Academies + Clubs)';
      stats[2] = ['3â€“4 hrs / week', 'Recommended time'];
      const baseThree = [
        'Structured path from block coding into real languages',
        'Mentor-led dojo that feels fun, not like more school',
        'Builds confidence, focus, and perseverance through challenges'
      ];
      const extraForTriple = [
        'Coding',
        'Rotating AI and Robotics Academy experiences across the year',
        'Clubs/community add variety and momentum for hungry learners'
      ];
      return {
        uiTitle: 'Recommended Program:' + variantLine,
        uiBlurb: 'Your Ninja is ready for our CREATE Dojoâ€”where they build real games, sharpen problem-solving, and level up through our belt system in a space that feels like home.',
        bullets: [...baseThree, ...extraForTriple],
        stats,
        apiProgram: 'Code Ninjas CREATE',
        bundleType: bundle.type
      };
    }

    return {
      uiTitle: 'Recommended Program:' + variantLine,
      uiBlurb: 'Your Ninja is ready for our CREATE Dojoâ€”where they build real games, sharpen problem-solving, and level up through our belt system in a space that feels like home.',
      bullets: [
        'Structured path from block coding into real languages',
        'Mentor-led dojo that feels fun, not like more school',
        'Builds confidence, focus, and perseverance through challenges',
        ...bulletsExtra
      ],
      stats,
      apiProgram: 'Code Ninjas CREATE',
      bundleType: bundle.type
    };
  }

  // ---------- FUN FACT ----------
  function funFactText(programKey, signals, bundleType){
    // Prioritize bundle type for fun fact consistency
    if(bundleType === '1+1_AI'){
      return 'Students who engage early with coding and AI concepts gain confidence navigating technologies that are shaping the fastest-growing careers.';
    }
    if(bundleType === '1+1_Robotics'){
      return 'Building and programming robots helps kids connect coding to the real world, which research links to higher engagement in STEM over time.';
    }

    const txt = signals.join(' ').toLowerCase();
    if(/game|roblox|minecraft/.test(txt)){
      return 'Designing and coding their own games strengthens logic, creativity, and persistenceâ€”the same problem-solving muscles used by professional developers.';
    }
    if(/robot/.test(txt)){
      return 'Building and programming robots helps kids connect coding to the real world, which research links to higher engagement in STEM over time.';
    }
    if(programKey === 'ACADEMY' || /ai\b/.test(txt)){
      return 'Students who engage early with coding and AI concepts gain confidence navigating technologies that are shaping the fastest-growing careers.';
    }
    return 'Learning to code builds problem-solving, creativity, and resilienceâ€”skills that support success in math, science, writing, and beyond.';
  }

  // ---------- Q&A SUMMARY ----------
  function buildQASummary(){
    const fields = [
      ['gender', 'radio'], // Add Gender to summary
      ['age','radio'], // This will now fetch pre-set age
      ['traits5','checkbox'],['play5','checkbox'],['grit5','radio'],
      ['traits8','checkbox'],['learn8','checkbox'],['school8','checkbox'],['reengage8','radio'],['tech8','radio'],['tried8','checkbox'],
      ['traits11','checkbox'],['challenge11','radio'],['school11','checkbox'],['enjoy11','checkbox'],['tech11','radio'],['leader11','radio'],
      ['motivate14','radio'],['interest14','checkbox'],['tech14','radio'],['career14','radio'],['growth14','radio'],
      ['goals','checkbox'],['futurefocus','radio'],['ai','radio'],
      ['hearAbout','radio'],
      ['hearFriendShare','checkbox'],
      ['friendName','text'],
      ['schoolShare','checkbox'],
      ['schoolNameInput','text'],
      ['teacherNameInput','text'],
      ['socialPlatform','radio'],
      ['searchTopics','checkbox'],
      ['searchClickWhy','checkbox'],
      ['searchOtherDetails','text'],
      ['clickOtherDetails','text'],
      ['eventDetails','text'],
      ['otherDetails','text']
    ];
    const lines = [];
    fields.forEach(([name,type]) => {
      // Special handling for text inputs without legends, or custom label display
      if(type === 'text'){
        const val = textValue(name);
        if(val) {
           // Map ID to readable label
           let label = name;
           if(name === 'friendName') label = 'Friend/Parent Name';
           else if(name === 'schoolNameInput') label = 'School Name';
           else if(name === 'teacherNameInput') label = 'Teacher Name';
           else if(name === 'eventDetails') label = 'Event/Location';
           else if(name === 'otherDetails') label = 'Other Details';
           else if(name === 'searchOtherDetails') label = 'Search Other Details';
           else if(name === 'clickOtherDetails') label = 'Click Reason Other Details';
           lines.push(`${label} â†’ ${val}`);
        }
        return;
      }
      
      // AGE SPECIAL HANDLING: If age question was skipped in wizard, we still need to log it
      if(name === 'age'){
         if(currentChildAge){
            lines.push(`Age Group â†’ ${currentChildAge}`);
         }
         return;
      }

      const legend = getLegendForInputName(name);
      if(!legend) return;
      let ans = '';
      if(type === 'radio'){
        ans = radioLabel(name);
      } else if(type === 'checkbox'){
        ans = checkboxLabels(name).join(', ');
      }
      if(ans) lines.push(legend + ' â†’ ' + ans);
    });
    return lines;
  }

  // ---------- API SUBMIT ----------
  function submitToWeb3Forms(message){
    if(window.API_Access === false){ console.log('API submission skipped'); return; }
    
    const form = $('#web3Form');
    const msgField = $('#wf_message');
    const subjField = $('#wf_subject');
    const nameField = $('#wf_name');
    // wf_email is set in HTML with a dummy value since user removed input

    if(!form || !msgField || !subjField || !nameField) return;

    subjField.value = `New Ninja Path Finder Lead - ${centerLocation}`;
    nameField.value = `${parentFirst} ${parentLast}`.trim();
    msgField.value = message;

    // Submit via standard form POST to hidden iframe to bypass CORS on file://
    form.submit();
    console.log('Web3Forms submission triggered via hidden frame');
  }

  // ---------- MONDAY.COM SUBMIT (No Names) ----------
  async function submitToMonday(data){
    if(!MONDAY_ENABLED || window.API_Access === false){ 
      console.log('Monday.com submission skipped'); 
      return; 
    }
    
    if(!MONDAY_API_KEY || !MONDAY_BOARD_ID){
      console.warn('Monday.com credentials not configured');
      return;
    }
    
    try {
      // Parse Q&A summary to extract individual answers
      const parseQA = (qaSummary) => {
        const parsed = {};
        qaSummary.forEach(line => {
          const parts = line.split(' â†’ ');
          if(parts.length >= 2){
            const question = parts[0].trim();
            const answer = parts.slice(1).join(' â†’ ').trim();
            parsed[question] = answer;
          }
        });
        return parsed;
      };
      
      const qaData = parseQA(data.qaSummary);
      
      // Build column values object for Monday.com
      const columnValues = {};
      
      // Basic Info
      columnValues[MONDAY_COLUMN_MAP['Location']] = data.centerLocation || '';
      
      // Date format for Monday.com: JSON object { date: "YYYY-MM-DD" }
      const dateValue = new Date().toISOString().split('T')[0];
      columnValues[MONDAY_COLUMN_MAP['Submitted Date']] = { date: dateValue };

      // FIXED: Numeric columns in Monday.com expect a simple string value, NOT an object
      columnValues[MONDAY_COLUMN_MAP['Number of Children']] = String(data.numChildren || 1);
      
      // Program & Persona
      columnValues[MONDAY_COLUMN_MAP['Recommended Program']] = data.programDisplay || '';
      columnValues[MONDAY_COLUMN_MAP['Persona']] = data.persona || '';
      columnValues[MONDAY_COLUMN_MAP['Persona Description']] = data.personaBlurb || '';
      
      // Child Demographics (no names)
      columnValues[MONDAY_COLUMN_MAP['Child Age Group']] = qaData['Age Group'] || '';
      columnValues[MONDAY_COLUMN_MAP['Child Gender']] = qaData['My child is a...'] || '';
      
      // Age-specific answers (5-7)
      columnValues[MONDAY_COLUMN_MAP['Traits (5-7)']] = qaData['Which of these best describe your child?'] || '';
      columnValues[MONDAY_COLUMN_MAP['Play Preferences (5-7)']] = qaData['What kind of play do they enjoy most?'] || '';
      columnValues[MONDAY_COLUMN_MAP['Persistence (5-7)']] = qaData['When something doesn\'t work right away, they usuallyâ€¦'] || '';
      
      // Age-specific answers (8-10)
      columnValues[MONDAY_COLUMN_MAP['Traits (8-10)']] = qaData['Which traits best describe your child?'] || '';
      columnValues[MONDAY_COLUMN_MAP['Learning Style (8-10)']] = qaData['How does your child learn best?'] || '';
      columnValues[MONDAY_COLUMN_MAP['School Attitude (8-10)']] = qaData['How do they feel about school and learning?'] || '';
      columnValues[MONDAY_COLUMN_MAP['Re-engagement Method (8-10)']] = qaData['What usually helps them re-engage?'] || '';
      columnValues[MONDAY_COLUMN_MAP['Tech Confidence (8-10)']] = qaData['How confident are they with technology?'] || '';
      columnValues[MONDAY_COLUMN_MAP['Tech Experience (8-10)']] = qaData['What have they tried so far?'] || '';
      
      // Age-specific answers (11-13)
      columnValues[MONDAY_COLUMN_MAP['Traits (11-13)']] = qaData['Which traits best describe your child?'] || '';
      columnValues[MONDAY_COLUMN_MAP['Challenge Response (11-13)']] = qaData['When faced with a challenge, they usuallyâ€¦'] || '';
      columnValues[MONDAY_COLUMN_MAP['School Attitude (11-13)']] = qaData['How do they feel about school?'] || '';
      columnValues[MONDAY_COLUMN_MAP['Enjoyment Factors (11-13)']] = qaData['What would help them enjoy learning more?'] || '';
      columnValues[MONDAY_COLUMN_MAP['Tech Confidence (11-13)']] = qaData['How comfortable are they with technology?'] || '';
      columnValues[MONDAY_COLUMN_MAP['Leadership Interest (11-13)']] = qaData['Would they enjoy helping others or leading projects?'] || '';
      
      // Age-specific answers (14+)
      columnValues[MONDAY_COLUMN_MAP['Motivation (14+)']] = qaData['What best describes what motivates your teen?'] || '';
      columnValues[MONDAY_COLUMN_MAP['Interests (14+)']] = qaData['Which areas are they most interested in?'] || '';
      columnValues[MONDAY_COLUMN_MAP['Tech Confidence (14+)']] = qaData['How confident are they with technology?'] || '';
      columnValues[MONDAY_COLUMN_MAP['Career Interest (14+)']] = qaData['Are they interested in tech certifications or careers?'] || '';
      columnValues[MONDAY_COLUMN_MAP['Growth Area (14+)']] = qaData['Which growth area is most important this year?'] || '';
      
      // Goals & Future
      columnValues[MONDAY_COLUMN_MAP['Parent Goals']] = qaData['What are you hoping your child gains from Code Ninjas?'] || '';
      columnValues[MONDAY_COLUMN_MAP['Future Focus']] = qaData['What future skill matters most to you for your child right now?'] || '';
      columnValues[MONDAY_COLUMN_MAP['AI Interest']] = qaData['AI Interest'] || '';
      
      // Marketing
      columnValues[MONDAY_COLUMN_MAP['Marketing Source']] = data.marketingSource || 'N/A';
      columnValues[MONDAY_COLUMN_MAP['Marketing Details']] = data.marketingSubsource || '';
      
      // Full Summary (email and SMS columns removed as requested)
      columnValues[MONDAY_COLUMN_MAP['Full Q&A Summary']] = data.qaSummary.join('\n') || '';
      
      // Convert to Monday.com format
      const columnValuesString = JSON.stringify(columnValues);
      
      // Create item with anonymous identifier (no names)
      const itemName = `Lead - ${data.centerLocation} - ${new Date().toLocaleDateString()}`;
      
      // Build mutation - escape properly for GraphQL string
      const escapedItemName = itemName.replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/\n/g, '\\n');
      const escapedColumnValues = columnValuesString.replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/\n/g, '\\n');
      
      const mutation = `mutation {
        create_item(
          board_id: ${MONDAY_BOARD_ID},
          item_name: "${escapedItemName}",
          column_values: "${escapedColumnValues}"
        ) {
          id
        }
      }`;
      
      const response = await fetch('https://api.monday.com/v2', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': MONDAY_API_KEY
        },
        body: JSON.stringify({ query: mutation })
      });
      
      const result = await response.json();
      
      if(result.errors){
        console.error('âŒ Monday.com API errors:', result.errors);
        result.errors.forEach((error, idx) => {
          console.error(`Error ${idx + 1}:`, error.message || error);
        });
      } else if(result.data && result.data.create_item) {
        console.log('âœ… Monday.com submission successful!');
      } else {
        console.warn('âš ï¸ Unexpected Monday.com response:', JSON.stringify(result, null, 2));
      }
    } catch(e) {
      console.error('Monday.com submission error:', e);
    }
  }

  // Helper to determine Academy bundle type (AI vs Robotics) based on interests
  function determineAcademyBundleType(){
    const interest14 = checkboxLabels('interest14');
    const future = getValue('futurefocus');
    
    // Check explicit interests
    if(interest14.includes('Robotics')) return 'Robotics';
    if(interest14.includes('AI')) return 'AI';
    
    // Check future focus preference
    if(future === 'Coding + Robotics') return 'Robotics';
    if(future === 'Coding + AI') return 'AI';
    
    // Default to AI if no clear preference
    return 'AI';
  }

  // ---------- MAIN RESULTS ----------
  async function computeResultsAndSubmit(){
    const ageVal = getValue('age') || '';
    const gender = getValue('gender') || '';
    const baseKey = baseProgramKey(ageVal);
    const programUI = buildProgramUI(ageVal);
    let bundleType = programUI.bundleType || (baseKey === 'CREATE' ? (chooseCreateBundle().type) : null);
    
    // If Academy path, determine if it should be AI or Robotics bundle
    let academyBundleType = null;
    if(baseKey === 'ACADEMY'){
      if(bundleType === '1+1_Academy' || !bundleType){
        // Determine specific type (AI or Robotics) based on interests
        academyBundleType = determineAcademyBundleType();
        bundleType = academyBundleType === 'Robotics' ? '1+1_Robotics' : '1+1_AI';
      } else if(bundleType === '1+1_AI'){
        academyBundleType = 'AI';
      } else if(bundleType === '1+1_Robotics'){
        academyBundleType = 'Robotics';
      }
    }
    
    // Use new Persona Logic
    const personaData = determinePersona();
    const persona = personaData.title;
    const personaBlurb = personaData.blurb;

    const allTraits = []
      .concat(checkboxLabels('traits5'))
      .concat(checkboxLabels('traits8'))
      .concat(checkboxLabels('traits11'))
      .concat(checkboxLabels('interest14'));
      
    const goals = checkboxLabels('goals');

    // Marketing attribution
    const hearCode = getValue('hearAbout');
    let marketingSource = '';
    let marketingSubsource = '';
    const hearLabel = radioLabel('hearAbout');

    if(hearCode){
      switch(hearCode){
        case 'Friend': {
          marketingSource = 'Friend / Parent Referral';
          const fName = textValue('friendName');
          marketingSubsource = [
            `Primary source: ${hearLabel}`,
            fName ? `Referred by: ${fName}` : ''
          ].filter(Boolean).join('\n');
          break;
        }
        case 'School': {
          marketingSource = 'School / Teacher';
          const schoolShare = checkboxLabels('schoolShare');
          const sName = textValue('schoolNameInput');
          const tName = textValue('teacherNameInput');
          marketingSubsource = [
            `Primary source: ${hearLabel}`,
            sName ? `School: ${sName}` : '',
            tName ? `Teacher: ${tName}` : '',
            schoolShare.length ? `How school shared: ${schoolShare.join(', ')}` : ''
          ].filter(Boolean).join('\n');
          break;
        }
        case 'Social': {
          marketingSource = 'Social Media';
          const socialPlatform = radioLabel('socialPlatform');
          marketingSubsource = [
            `Primary source: ${hearLabel}`,
            socialPlatform ? `Platform: ${socialPlatform}` : ''
          ].filter(Boolean).join('\n');
          break;
        }
        case 'Search': {
          marketingSource = 'Google / Online Search';
          const searchTopics = checkboxLabels('searchTopics');
          const clickReasons = checkboxLabels('searchClickWhy');
          const searchOther = textValue('searchOtherDetails');
          const clickOther = textValue('clickOtherDetails');
          
          marketingSubsource = [
            `Primary source: ${hearLabel}`,
            searchTopics.length ? `What they were searching for: ${searchTopics.join(', ')}` : '',
            searchOther ? `Search Other: ${searchOther}` : '',
            clickReasons.length ? `What made them click: ${clickReasons.join(', ')}` : '',
            clickOther ? `Click Other: ${clickOther}` : ''
          ].filter(Boolean).join('\n');
          break;
        }
        case 'Event': {
          marketingSource = 'Event / Fair / Camp';
          const evt = textValue('eventDetails');
          marketingSubsource = [
            `Primary source: ${hearLabel}`,
            evt ? `Event/Loc: ${evt}` : ''
          ].filter(Boolean).join('\n');
          break;
        }
        case 'Returning': {
          marketingSource = 'Returning Family';
          marketingSubsource = `Primary source: ${hearLabel}`;
          break;
        }
        case 'Other': {
          marketingSource = 'Other';
          const oth = textValue('otherDetails');
          marketingSubsource = [
            `Primary source: ${hearLabel}`,
            oth ? `Details: ${oth}` : ''
          ].filter(Boolean).join('\n');
          break;
        }
      }
    }

    // UI
    const currentChildName = (numChildren > 1 && childNames[currentChildIndex]) 
         ? childNames[currentChildIndex].name
         : "Your Child"; // Used for UI display, not for prompt

    $('#personaTitle').textContent = `${currentChildName}'s Profile: ${persona}`;
    $('#personaBlurb').textContent = personaBlurb;

    // Bundle-aware program display - determine types first
    const apiProgramName = programUI.apiProgram;
    let finalAcademyType = academyBundleType;
    if(apiProgramName === 'Code Ninjas Academy'){
        // Use the determined type, or default to AI
        finalAcademyType = academyBundleType || 'AI';
    } else if(apiProgramName === 'Code Ninjas CREATE'){
      if(bundleType === '1+1_AI') {
        finalAcademyType = 'AI';
      } else if(bundleType === '1+1_Robotics') {
        finalAcademyType = 'Robotics';
      }
    }

    // Update program title to include bundle type if applicable
    let displayTitle = programUI.uiTitle;
    if(apiProgramName === 'Code Ninjas Academy'){
        displayTitle = finalAcademyType === 'Robotics' ? 'Recommended Program: CREATE 1+1 Bundle (Robotics)' : 'Recommended Program: CREATE 1+1 Bundle (AI)';
    } else if(apiProgramName === 'Code Ninjas CREATE' && (bundleType === '1+1_AI' || bundleType === '1+1_Robotics')){
        displayTitle = bundleType === '1+1_Robotics' ? 'Recommended Program: CREATE 1+1 Bundle (Robotics)' : 'Recommended Program: CREATE 1+1 Bundle (AI)';
    }
    
    $('#recTitle').textContent = displayTitle;
    $('#recBlurb').textContent = programUI.uiBlurb;
    $('#recPoints').innerHTML = programUI.bullets.map(b => `<li>${b}</li>`).join('');

    $('#stats').innerHTML = programUI.stats.map(([v,l]) => `<div class="stat"><h3>${v}</h3><p>${l}</p></div>`).join('');

    // Fun fact (only for on-screen)
    const signals = [].concat(allTraits, goals, [
      checkboxLabels('play5').join(' '), checkboxLabels('tried8').join(' '), radioLabel('futurefocus'), radioLabel('ai')
    ].filter(Boolean));
    const funFact = funFactText(baseKey, signals, bundleType); 
    
    if(funFact){
      $('#funFactText').textContent = funFact;
      $('#funFact').classList.remove('hidden');
    } else {
      $('#funFact').classList.add('hidden');
    }

    // Center note - updated text and styling
    $('#centerNote').textContent = 'Before you head out today, stop by the front desk so we can walk you through this path and help you enroll.';
    $('#centerNote').style.fontWeight = 'bold';
    $('#centerNote').classList.remove('hint'); // Remove hint styling

    // Bundle-aware program display for email/SMS
    let programDisplay = apiProgramName;
    if(apiProgramName === 'Code Ninjas Academy'){
        programDisplay = finalAcademyType === 'Robotics' ? 'CREATE 1+1 (Robotics) Bundle' : 'CREATE 1+1 (AI) Bundle';
    } else if(apiProgramName === 'Code Ninjas CREATE'){
      if(bundleType === '1+1_AI') {
        programDisplay = 'CREATE 1+1 (AI) Bundle';
      } else if(bundleType === '1+1_Robotics') {
        programDisplay = 'CREATE 1+1 (Robotics) Bundle';
      } else if(bundleType === '1+1+1') programDisplay += ' (1+1+1 Bundle: Coding + Academies + Clubs)';
      else if(bundleType === '2x') programDisplay += ' (2x/Week)';
    }

    // Build Q&A summary once
    const qaSummary = buildQASummary();

    // Prepare AI-generated email + SMS (short, child-first)
    let emailBody = '';
    let smsOptions = [];
    try {
      const comms = await generateAiComms({
        programDisplay,
        apiProgramName,
        personaLabel: persona,
        funFact,
        bundleType,
        academyBundleType: finalAcademyType, // Pass the specific type (AI or Robotics)
        marketingSource,
        marketingSubsource,
        qaSummaryLines: qaSummary,
        currentChildName: (numChildren > 1) ? currentChildName : null,
        gender: gender // Pass gender to AI
      });
      if(comms){
        emailBody = comms.email;
        smsOptions = comms.sms;
      }
    } catch(e) {
      console.warn("Error while generating AI comms:", e);
    }

    // Fallback if Gemini fails
    if(!emailBody || smsOptions.length === 0){
      const fallback = buildFallbackComms(programDisplay, (numChildren > 1) ? currentChildName : null);
      emailBody = fallback.email;
      smsOptions = fallback.sms;
    }

    const timestamp = new Date().toLocaleString();

    // Conditional Child line - ONLY if more than one child
    const childLine = (numChildren > 1) ? `Child: ${currentChildName}\n` : '';

    const message =
`Location: Code Ninjas ${centerLocation}
Submitted: ${timestamp}
${childLine}
--------------------
Internal Notes:
Persona Label: ${persona}
Recommended Program: ${programDisplay}
Marketing Source: ${marketingSource || 'N/A'}
${marketingSubsource || 'N/A'}

--------------------
Q&A Summary (question â†’ answer):
${qaSummary.map(l => 'â€¢ ' + l).join('\n')}

--------------------
AI-Generated Parent Email:
${emailBody}

--------------------
AI-Generated SMS Options (choose one to text the parent):
SMS 1 (Send Day After):
${smsOptions[0] || ''}

SMS 2 (Send 3 Days Later):
${smsOptions[1] || ''}`;

    // Submit to both Web3Forms (email) and Monday.com (dashboard - no names)
    submitToWeb3Forms(message);
    
    // Submit to Monday.com (anonymous data only, runs in parallel)
    submitToMonday({
      centerLocation: centerLocation,
      numChildren: numChildren,
      programDisplay: programDisplay,
      persona: persona,
      personaBlurb: personaBlurb,
      qaSummary: qaSummary,
      emailBody: emailBody,
      smsOptions: smsOptions,
      marketingSource: marketingSource || 'N/A',
      marketingSubsource: marketingSubsource || ''
    });

    // Show result to parent after Gemini & submit complete
    stopLoading();
    wizard.classList.add('hidden');
    result.style.display = 'block';
    
    // Logic for Next Child button
    if (numChildren > 1 && currentChildIndex < numChildren - 1) {
       nextChildBtn.style.display = 'block';
       nextChildBtn.textContent = `Start Quiz for ${childNames[currentChildIndex + 1].name} â–¶`;
       retakeBtn.style.display = 'none'; // Hide home button until done
    } else {
       nextChildBtn.style.display = 'none';
       retakeBtn.style.display = 'block'; // Show home button
    }

    window.scrollTo({ top:0, behavior:'smooth' });
  }

  // ---------- BACK TO HOME ----------
  $('#retakeBtn').addEventListener('click', () => { window.location.reload(); });
})();
</script>
<!-- --- SERVICE WORKER REGISTRATION START --- -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then((reg) => console.log('Service Worker registered!', reg))
        .catch((err) => console.log('Service Worker registration failed:', err));
    });
  }
</script>
<!-- --- SERVICE WORKER REGISTRATION END --- -->
<script type="module" src="/index.tsx"></script>
</body>
</html>
