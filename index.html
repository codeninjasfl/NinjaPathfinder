<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Code Ninjas ‚Äì Ninja Path Finder</title>
    <meta name="theme-color" content="#2563eb" />

    <!-- --- PWA SETUP START --- -->
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="mobile-web-app-capable" content="yes">
    <!-- --- PWA SETUP END --- -->

    <link rel="stylesheet" href="./index.css">
    <script src="./translations.js"></script>
</head>

<body>
    <div class="wrap">
        <header>
            <div class="brand" style="position:relative;">
                <img class="logo" src="https://www.codeninjas.com/hubfs/Group%201.svg" alt="Code Ninjas"
                    onerror="this.style.display='none'">
                <select id="langSelect" aria-label="Language"
                    style="position:absolute; right:0; top:0; padding:4px 8px; border-radius:12px; border:1px solid #cbd5e1; font-size:14px; background:#fff; cursor:pointer;">
                    <option value="en">üá∫üá∏ English</option>
                    <option value="es">üá™üá∏ Espa√±ol</option>
                    <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                    <option value="pt">üáßüá∑ Portugu√™s</option>
                    <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                </select>
            </div>
            <h1>Find the Right Path for Your Ninja</h1>
            <p>Answer a few quick questions to match your child with the perfect Code Ninjas program.</p>
        </header>

        <!-- PRE-START -->
        <section id="prestart" class="card" aria-label="Parent details">
            <div class="prestart-label">Start by telling us who you are and which center you're visiting.</div>
            <div class="prestart-grid">
                <input id="parentFirst" placeholder="Parent first name" autocomplete="given-name">
                <input id="parentLast" placeholder="Parent last name" autocomplete="family-name">
                <select id="location" aria-label="Location">
                    <option value="">Select location</option>
                    <option value="Aventura">Aventura</option>
                    <option value="Cooper City">Cooper City</option>
                    <option value="Weston">Weston</option>
                </select>
                <button id="startQuizBtn" class="btn primary" type="button" disabled>Start Quiz ‚ñ∂</button>
            </div>
            <div class="hint" style="text-align:center; margin-top:12px;">We'll use this to share your child's
                personalized program match with your chosen center.</div>
        </section>

        <!-- CHILD SETUP (NEW) -->
        <section id="child-setup" class="card hidden" aria-live="polite">
            <h2 class="center" style="color:var(--brand); margin:0 0 20px; font-size: 20px;">Just one more thing...</h2>
            <fieldset>
                <legend style="text-align:center; margin-bottom:20px;">How many children are joining us today?</legend>
                <div class="opts grid-4">
                    <label class="opt"><input type="radio" name="numChildrenChoice" value="1" checked> 1 Child</label>
                    <label class="opt"><input type="radio" name="numChildrenChoice" value="2"> 2 Children</label>
                    <label class="opt"><input type="radio" name="numChildrenChoice" value="3"> 3 Children</label>
                    <label class="opt"><input type="radio" name="numChildrenChoice" value="4"> 4 Children</label>
                </div>
            </fieldset>

            <div id="child-names-area" class="hidden" style="margin-top:24px;">
                <p class="hint" style="text-align:center; margin-bottom:12px;">Please provide details for each child:
                </p>
                <div id="child-names-inputs" style="display:flex; flex-direction:column; gap:16px;">
                    <!-- Inputs generated here -->
                </div>
            </div>

            <div class="actions center" style="margin-top:32px; justify-content:center;">
                <button id="confirmChildrenBtn" class="btn primary" type="button"
                    style="width:100%; max-width:320px;">Begin Questionnaire ‚ñ∂</button>
            </div>
        </section>


        <!-- WIZARD -->
        <section id="wizard" class="card hidden" aria-live="polite">
            <!-- Banner for multi-child context -->
            <div id="childContextBanner" class="current-child-banner hidden"></div>

            <div class="topbar" aria-hidden="true">
                <div class="progress">
                    <div id="bar" class="bar"></div>
                </div>
                <div class="count"><span id="qnum">1</span> / <span id="qtotal">1</span> questions</div>
            </div>

            <!-- Q0: Gender (NEW) -->
            <div class="step" data-step-id="q0">
                <fieldset>
                    <legend id="genderLegend">My child is a...</legend>
                    <div class="opts">
                        <label class="opt"><input type="radio" name="gender" value="Boy"> Boy</label>
                        <label class="opt"><input type="radio" name="gender" value="Girl"> Girl</label>
                    </div>
                </fieldset>
            </div>

            <!-- NOTE: Age step removed from wizard flow because it is now captured in setup -->
            <!-- The active age value is stored in currentChildAge variable in JS -->

            <!-- PATH 1: JR (5‚Äì7) -->
            <div class="step" data-step-id="q2A" data-show-if="age=5-7">
                <fieldset>
                    <legend>Which of these best describe your child? <span class="hint">Choose 2 responses</span>
                    </legend>
                    <div class="opts">
                        <label class="opt"><input type="checkbox" name="traits5" value="Curious"> Curious</label>
                        <label class="opt"><input type="checkbox" name="traits5" value="Creative"> Creative</label>
                        <label class="opt"><input type="checkbox" name="traits5" value="Shy"> Shy</label>
                        <label class="opt"><input type="checkbox" name="traits5" value="Energetic"> Energetic</label>
                        <label class="opt"><input type="checkbox" name="traits5" value="Observant"> Observant</label>
                        <label class="opt"><input type="checkbox" name="traits5" value="Imaginative">
                            Imaginative</label>
                    </div>
                </fieldset>
            </div>

            <div class="step" data-step-id="q3A" data-show-if="age=5-7">
                <fieldset>
                    <legend>What kind of play do they enjoy most? <span class="hint">Select all that apply</span>
                    </legend>
                    <div class="opts">
                        <label class="opt"><input type="checkbox" name="play5" value="Building"> Building (blocks,
                            Legos, etc.)</label>
                        <label class="opt"><input type="checkbox" name="play5" value="Imaginative"> Imaginative or
                            pretend play</label>
                        <label class="opt"><input type="checkbox" name="play5" value="Games"> Games on a tablet or
                            device</label>
                        <label class="opt"><input type="checkbox" name="play5" value="Arts"> Arts & crafts</label>
                        <label class="opt"><input type="checkbox" name="play5" value="Outdoor"> Outdoor or active
                            play</label>
                    </div>
                </fieldset>
            </div>

            <div class="step" data-step-id="q4A" data-show-if="age=5-7">
                <fieldset>
                    <legend>When something doesn‚Äôt work right away, they usually‚Ä¶</legend>
                    <div class="opts grid-4">
                        <label class="opt"><input type="radio" name="grit5" value="Keeps trying"> Keep trying</label>
                        <label class="opt"><input type="radio" name="grit5" value="Asks for help"> Ask for help</label>
                        <label class="opt"><input type="radio" name="grit5" value="Frustrated"> Get frustrated</label>
                        <label class="opt"><input type="radio" name="grit5" value="Move on"> Move on quickly</label>
                    </div>
                </fieldset>
            </div>

            <!-- PATH 2: 8‚Äì10 -->
            <div class="step" data-step-id="q2B" data-show-if="age=8-10">
                <fieldset>
                    <legend>Which traits best describe your child? <span class="hint">Choose up to 2</span></legend>
                    <div class="opts">
                        <label class="opt"><input type="checkbox" name="traits8" value="Curious"> Curious</label>
                        <label class="opt"><input type="checkbox" name="traits8" value="Creative"> Creative</label>
                        <label class="opt"><input type="checkbox" name="traits8" value="Competitive">
                            Competitive</label>
                        <label class="opt"><input type="checkbox" name="traits8" value="Social"> Social</label>
                        <label class="opt"><input type="checkbox" name="traits8" value="Focused"> Focused</label>
                        <label class="opt"><input type="checkbox" name="traits8" value="Distracted"> Easily
                            distracted</label>
                    </div>
                </fieldset>
            </div>

            <div class="step" data-step-id="q3B" data-show-if="age=8-10">
                <fieldset>
                    <legend>How does your child learn best? <span class="hint">Select all that apply</span></legend>
                    <div class="opts">
                        <label class="opt"><input type="checkbox" name="learn8" value="Hands-on"> Hands-on</label>
                        <label class="opt"><input type="checkbox" name="learn8" value="Visual"> Visual examples</label>
                        <label class="opt"><input type="checkbox" name="learn8" value="Listening"> Listening</label>
                        <label class="opt"><input type="checkbox" name="learn8" value="With friends"> With
                            friends</label>
                        <label class="opt"><input type="checkbox" name="learn8" value="Step-by-step"> Step-by-step
                            instructions</label>
                    </div>
                </fieldset>
            </div>

            <div class="step" data-step-id="q4B" data-show-if="age=8-10">
                <fieldset>
                    <legend>How do they feel about school and learning? <span class="hint">Select all that apply</span>
                    </legend>
                    <div class="opts grid-4">
                        <label class="opt"><input type="checkbox" name="school8" value="Loves learning"> Loves
                            learning</label>
                        <label class="opt"><input type="checkbox" name="school8" value="Likes when fun"> Likes it when
                            it‚Äôs fun</label>
                        <label class="opt"><input type="checkbox" name="school8" value="Bored"> Gets bored
                            easily</label>
                        <label class="opt"><input type="checkbox" name="school8" value="Struggles focus"> Struggles to
                            stay focused</label>
                    </div>
                </fieldset>
            </div>

            <div class="step" data-step-id="q4B-1" data-show-if="school8=Bored,Struggles focus | traits8=Distracted">
                <fieldset>
                    <legend>What usually helps them re-engage?</legend>
                    <div class="opts grid-4">
                        <label class="opt"><input type="radio" name="reengage8" value="Encouragement"> Encouragement
                            from adults</label>
                        <label class="opt"><input type="radio" name="reengage8" value="Competition"> Friendly
                            competition</label>
                        <label class="opt"><input type="radio" name="reengage8" value="Rewards"> Rewards or
                            milestones</label>
                        <label class="opt"><input type="radio" name="reengage8" value="Freedom"> Freedom to do it their
                            way</label>
                    </div>
                </fieldset>
            </div>

            <div class="step" data-step-id="q5B" data-show-if="age=8-10">
                <fieldset>
                    <legend>How confident are they with technology?</legend>
                    <div class="opts">
                        <label class="opt"><input type="radio" name="tech8" value="Beginner"> Beginner</label>
                        <label class="opt"><input type="radio" name="tech8" value="Comfortable"> Comfortable</label>
                        <label class="opt"><input type="radio" name="tech8" value="Advanced"> Advanced</label>
                    </div>
                </fieldset>
            </div>

            <div class="step" data-step-id="q5B-1" data-show-if="tech8=Advanced">
                <fieldset>
                    <legend>What have they tried so far? <span class="hint">Select all that apply</span></legend>
                    <div class="opts grid-4">
                        <label class="opt"><input type="checkbox" name="tried8" value="Roblox/Minecraft"> Minecraft mods
                            or Roblox Studio</label>
                        <label class="opt"><input type="checkbox" name="tried8" value="Scratch"> Scratch / block
                            coding</label>
                        <label class="opt"><input type="checkbox" name="tried8" value="Robotics"> Robotics kits</label>
                        <label class="opt"><input type="checkbox" name="tried8" value="Interested"> Not yet, but very
                            interested</label>
                    </div>
                </fieldset>
            </div>

            <!-- PATH 3: 11‚Äì13 -->
            <div class="step" data-step-id="q2C" data-show-if="age=11-13">
                <fieldset>
                    <legend>Which traits best describe your child? <span class="hint">Choose up to 2</span></legend>
                    <div class="opts">
                        <label class="opt"><input type="checkbox" name="traits11" value="Creative"> Creative</label>
                        <label class="opt"><input type="checkbox" name="traits11" value="Analytical"> Analytical</label>
                        <label class="opt"><input type="checkbox" name="traits11" value="Competitive">
                            Competitive</label>
                        <label class="opt"><input type="checkbox" name="traits11" value="Independent">
                            Independent</label>
                        <label class="opt"><input type="checkbox" name="traits11" value="Team-player">
                            Team-player</label>
                        <label class="opt"><input type="checkbox" name="traits11" value="Curious"> Curious</label>
                    </div>
                </fieldset>
            </div>

            <div class="step" data-step-id="q3C" data-show-if="age=11-13">
                <fieldset>
                    <legend>When faced with a challenge, they usually‚Ä¶</legend>
                    <div class="opts grid-4">
                        <label class="opt"><input type="radio" name="challenge11" value="Persist"> Keep trying</label>
                        <label class="opt"><input type="radio" name="challenge11" value="Research"> Research /
                            experiment</label>
                        <label class="opt"><input type="radio" name="challenge11" value="Frustrated"> Get frustrated
                            easily</label>
                        <label class="opt"><input type="radio" name="challenge11" value="Avoid"> Avoid difficult
                            tasks</label>
                    </div>
                </fieldset>
            </div>

            <div class="step" data-step-id="q4C" data-show-if="age=11-13">
                <fieldset>
                    <legend>How do they feel about school? <span class="hint">Select all that apply</span></legend>
                    <div class="opts grid-4">
                        <label class="opt"><input type="checkbox" name="school11" value="Motivated"> Motivated and
                            focused</label>
                        <label class="opt"><input type="checkbox" name="school11" value="Bored"> Does fine but gets
                            bored</label>
                        <label class="opt"><input type="checkbox" name="school11" value="Struggles"> Struggles to stay
                            focused</label>
                        <label class="opt"><input type="checkbox" name="school11" value="Disengaged"> Disengaged from
                            classes</label>
                    </div>
                </fieldset>
            </div>

            <div class="step" data-step-id="q4C-1" data-show-if="school11=Bored,Disengaged,Struggles">
                <fieldset>
                    <legend>What would help them enjoy learning more? <span class="hint">Select all that apply</span>
                    </legend>
                    <div class="opts grid-4">
                        <label class="opt"><input type="checkbox" name="enjoy11" value="Projects"> Real-world
                            projects</label>
                        <label class="opt"><input type="checkbox" name="enjoy11" value="Freedom"> Freedom to
                            create</label>
                        <label class="opt"><input type="checkbox" name="enjoy11" value="Tech/Games"> Using tech and
                            games</label>
                        <label class="opt"><input type="checkbox" name="enjoy11" value="Peers"> Working with
                            peers</label>
                    </div>
                </fieldset>
            </div>

            <div class="step" data-step-id="q5C" data-show-if="age=11-13">
                <fieldset>
                    <legend>How comfortable are they with technology?</legend>
                    <div class="opts">
                        <label class="opt"><input type="radio" name="tech11" value="Beginner"> Beginner</label>
                        <label class="opt"><input type="radio" name="tech11" value="Skilled"> Fairly skilled</label>
                        <label class="opt"><input type="radio" name="tech11" value="Advanced"> Advanced
                            (self-driven)</label>
                    </div>
                </fieldset>
            </div>

            <div class="step" data-step-id="q5C-1" data-show-if="tech11=Advanced">
                <fieldset>
                    <legend>Would they enjoy helping others or leading projects?</legend>
                    <div class="opts">
                        <label class="opt"><input type="radio" name="leader11" value="Yes"> Yes</label>
                        <label class="opt"><input type="radio" name="leader11" value="Maybe"> Maybe</label>
                        <label class="opt"><input type="radio" name="leader11" value="No"> Not right now</label>
                    </div>
                </fieldset>
            </div>

            <!-- PATH 4: 14+ -->
            <div class="step" data-step-id="q2D" data-show-if="age=14+">
                <fieldset>
                    <legend>What best describes what motivates your teen?</legend>
                    <div class="opts grid-4">
                        <label class="opt"><input type="radio" name="motivate14" value="Competition"> Competition &
                            clear goals</label>
                        <label class="opt"><input type="radio" name="motivate14" value="Recognition"> Recognition &
                            achievements</label>
                        <label class="opt"><input type="radio" name="motivate14" value="Curiosity"> Curiosity &
                            learning</label>
                        <label class="opt"><input type="radio" name="motivate14" value="Careers"> Preparing for
                            careers</label>
                    </div>
                </fieldset>
            </div>

            <div class="step" data-step-id="q3D" data-show-if="age=14+,tech8=Advanced,tech11=Advanced">
                <fieldset>
                    <legend>Which areas are they most interested in? <span class="hint">Choose up to 2</span></legend>
                    <div class="opts">
                        <label class="opt"><input type="checkbox" name="interest14" value="Game dev"> Game
                            development</label>
                        <label class="opt"><input type="checkbox" name="interest14" value="Robotics"> Robotics /
                            engineering</label>
                        <label class="opt"><input type="checkbox" name="interest14" value="AI"> AI & automation</label>
                        <label class="opt"><input type="checkbox" name="interest14" value="Content"> Content creation /
                            design</label>
                        <label class="opt"><input type="checkbox" name="interest14" value="Mentor"> Tutoring / mentoring
                            younger students</label>
                    </div>
                </fieldset>
            </div>

            <div class="step" data-step-id="q4D" data-show-if="age=14+">
                <fieldset>
                    <legend>How confident are they with technology?</legend>
                    <div class="opts">
                        <label class="opt"><input type="radio" name="tech14" value="Beginner"> Beginner</label>
                        <label class="opt"><input type="radio" name="tech14" value="Intermediate"> Intermediate</label>
                        <label class="opt"><input type="radio" name="tech14" value="Advanced"> Advanced</label>
                    </div>
                </fieldset>
            </div>

            <div class="step" data-step-id="q4D-1" data-show-if="tech14=Advanced,tech8=Advanced,tech11=Advanced">
                <fieldset>
                    <legend>Are they interested in tech certifications or careers?</legend>
                    <div class="opts">
                        <label class="opt"><input type="radio" name="career14" value="Yes"> Yes</label>
                        <label class="opt"><input type="radio" name="career14" value="Somewhat"> Somewhat</label>
                        <label class="opt"><input type="radio" name="career14" value="Not yet"> Not yet</label>
                    </div>
                </fieldset>
            </div>

            <div class="step" data-step-id="q5D" data-show-if="age=14+">
                <fieldset>
                    <legend>Which growth area is most important this year?</legend>
                    <div class="opts grid-4">
                        <label class="opt"><input type="radio" name="growth14" value="Leadership"> Leadership</label>
                        <label class="opt"><input type="radio" name="growth14" value="Time management"> Time
                            management</label>
                        <label class="opt"><input type="radio" name="growth14" value="Collaboration">
                            Collaboration</label>
                        <label class="opt"><input type="radio" name="growth14" value="Creativity"> Creativity</label>
                    </div>
                </fieldset>
            </div>

            <!-- SHARED GOALS -->
            <div class="step" data-step-id="q13">
                <fieldset>
                    <legend>What are you hoping your child gains from Code Ninjas? <span class="hint">Select all that
                            apply</span></legend>
                    <div class="opts">
                        <label class="opt"><input type="checkbox" name="goals" value="Confidence"> Confidence &
                            self-belief</label>
                        <label class="opt"><input type="checkbox" name="goals" value="Focus"> Focus & discipline</label>
                        <label class="opt"><input type="checkbox" name="goals" value="Teamwork"> Teamwork &
                            communication</label>
                        <label class="opt"><input type="checkbox" name="goals" value="Academic"> Academic
                            advantage</label>
                        <label class="opt"><input type="checkbox" name="goals" value="Creativity"> Creativity &
                            innovation</label>
                        <label class="opt"><input type="checkbox" name="goals" value="Future skills"> Future skills
                            (coding, AI, robotics)</label>
                    </div>
                </fieldset>
            </div>

            <div class="step" data-step-id="qFuture" data-show-if="age=8-10,11-13">
                <fieldset>
                    <legend>What future skill matters most to you for your child right now?</legend>
                    <div class="opts">
                        <label class="opt">
                            <input type="radio" name="futurefocus" value="Coding core">
                            A strong foundation in coding
                        </label>
                        <label class="opt">
                            <input type="radio" name="futurefocus" value="Coding + AI">
                            Coding plus early exposure to AI.
                        </label>
                        <label class="opt">
                            <input type="radio" name="futurefocus" value="Coding + Robotics">
                            Coding plus hands-on robotics
                        </label>
                        <label class="opt">
                            <input type="radio" name="futurefocus" value="All three">
                            Coding, AI, and robotics
                        </label>
                    </div>
                </fieldset>
            </div>

            <!-- Q15 DELETED AS REQUESTED -->

            <div class="step" data-step-id="q16">
                <fieldset>
                    <legend>How important is it for kids to understand AI & emerging technology?</legend>
                    <div class="opts grid-4">
                        <label class="opt"><input type="radio" name="ai" value="Essential"> Essential</label>
                        <label class="opt"><input type="radio" name="ai" value="Very"> Very important</label>
                        <label class="opt"><input type="radio" name="ai" value="Somewhat"> Somewhat important</label>
                        <label class="opt"><input type="radio" name="ai" value="Not sure"> Not sure yet</label>
                    </div>
                </fieldset>
            </div>

            <!-- Q17 REMOVED AS REQUESTED -->

            <!-- MARKETING ATTRIBUTION SECTION - Tagged as 'marketing-step' to be skipped for subsequent children -->
            <div class="step marketing-step" data-step-id="q18">
                <p style="font-size:15px; margin:0 0 10px; line-height: 1.5; color: var(--ink);">
                    <strong style="color: var(--brand);">You‚Äôre almost done!</strong><br>
                    Thanks for sharing about your Ninja ‚Äî just one last quick question before we wrap up.<br>
                    As a thank-you for your time, you‚Äôll receive a temporary code to waive the $99 enrollment fee once
                    you submit your answers below.
                </p>
                <fieldset>
                    <legend>How did you first hear about Code Ninjas?</legend>
                    <div class="hint">Choose one that best fits</div>
                    <div class="opts">
                        <label class="opt"><input type="radio" name="hearAbout" value="Friend"> Friend</label>
                        <label class="opt"><input type="radio" name="hearAbout" value="School"> School</label>
                        <label class="opt"><input type="radio" name="hearAbout" value="Social"> Social media</label>
                        <label class="opt"><input type="radio" name="hearAbout" value="Search"> Google</label>
                        <label class="opt"><input type="radio" name="hearAbout" value="Event"> Local event</label>
                        <label class="opt"><input type="radio" name="hearAbout" value="Returning"> Returning
                            family</label>
                        <label class="opt"><input type="radio" name="hearAbout" value="Other"> Other (please
                            specify)</label>
                    </div>
                </fieldset>
            </div>

            <!-- Friend / another parent follow-up -->
            <div class="step marketing-step" data-step-id="q18A" data-show-if="hearAbout=Friend">
                <fieldset>
                    <legend>What did they share that made you want to check us out?</legend>
                    <div class="opts grid-4">
                        <label class="opt"><input type="checkbox" name="hearFriendShare" value="Their child loved us">
                            Their child loved us</label>
                        <label class="opt"><input type="checkbox" name="hearFriendShare"
                                value="Improved focus and confidence"> Improved focus and confidence</label>
                        <label class="opt"><input type="checkbox" name="hearFriendShare"
                                value="Better performance in school"> Better performance in school</label>
                        <label class="opt"><input type="checkbox" name="hearFriendShare"
                                value="Something their child built"> Something their child built</label>
                    </div>
                </fieldset>
            </div>

            <!-- School / teacher follow-up -->
            <div class="step marketing-step" data-step-id="q18B" data-show-if="hearAbout=School">
                <fieldset>
                    <legend>How did the school share Code Ninjas?</legend>
                    <div class="prestart-grid" style="margin-bottom:10px; display:block;">
                        <input type="text" id="schoolNameInput" name="schoolNameInput" placeholder="School Name"
                            class="step-input">
                    </div>
                    <div class="opts">
                        <label class="opt"><input type="checkbox" name="schoolShare" value="Printed Flyer"> Printed
                            Flyer</label>
                        <label class="opt"><input type="checkbox" name="schoolShare" value="School newsletter/email">
                            School newsletter/email</label>
                        <label class="opt"><input type="checkbox" name="schoolShare" value="In-school visit"> In-school
                            visit</label>
                        <label class="opt"><input type="checkbox" name="schoolShare" value="Teacher recommendation">
                            Teacher recommendation</label>
                    </div>
                </fieldset>
            </div>

            <!-- Social media follow-up -->
            <div class="step marketing-step" data-step-id="q18C" data-show-if="hearAbout=Social">
                <fieldset>
                    <legend>Which platform?</legend>
                    <div class="opts grid-4">
                        <label class="opt"><input type="radio" name="socialPlatform" value="Facebook"> Facebook</label>
                        <label class="opt"><input type="radio" name="socialPlatform" value="Instagram">
                            Instagram</label>
                        <label class="opt"><input type="radio" name="socialPlatform" value="TikTok"> TikTok</label>
                        <label class="opt"><input type="radio" name="socialPlatform" value="Not sure"> Not sure</label>
                    </div>
                </fieldset>
            </div>

            <!-- Google / online search follow-up -->
            <div class="step marketing-step" data-step-id="q18D" data-show-if="hearAbout=Search">
                <fieldset>
                    <legend>What were you searching for when you found us?</legend>
                    <div class="opts">
                        <label class="opt"><input type="checkbox" name="searchTopics" value="Coding classes"> Coding
                            classes</label>
                        <label class="opt"><input type="checkbox" name="searchTopics" value="Robotics classes"> Robotics
                            classes</label>
                        <label class="opt"><input type="checkbox" name="searchTopics" value="AI programs"> AI
                            programs</label>
                        <label class="opt"><input type="checkbox" name="searchTopics" value="STEM classes or camps">
                            STEM classes or camps</label>
                        <label class="opt"><input type="checkbox" name="searchTopics" value="After-school programs">
                            After-school programs</label>
                        <label class="opt"><input type="checkbox" name="searchTopics" value="Summer camps"> Summer
                            camps</label>
                        <label class="opt"><input type="checkbox" name="searchTopics" value="Other"> Other</label>
                    </div>
                    <input type="text" name="searchOtherDetails" placeholder="If Other, please specify"
                        class="step-input" style="margin-top:8px;">
                </fieldset>

                <fieldset style="margin-top:12px;">
                    <legend>What made you click on Code Ninjas?</legend>
                    <div class="opts">
                        <label class="opt"><input type="checkbox" name="searchClickWhy" value="Program description">
                            Program description</label>
                        <label class="opt"><input type="checkbox" name="searchClickWhy" value="Positive reviews">
                            Positive reviews</label>
                        <label class="opt"><input type="checkbox" name="searchClickWhy" value="Convenient location">
                            Convenient location</label>
                        <label class="opt"><input type="checkbox" name="searchClickWhy" value="Special offer"> Special
                            offer</label>
                        <label class="opt"><input type="checkbox" name="searchClickWhy" value="Free session"> Free
                            session</label>
                        <label class="opt"><input type="checkbox" name="searchClickWhy" value="Other"> Other</label>
                    </div>
                    <input type="text" name="clickOtherDetails" placeholder="If Other, please specify"
                        class="step-input" style="margin-top:8px;">
                </fieldset>
            </div>

            <!-- Event follow-up -->
            <div class="step marketing-step" data-step-id="q18E" data-show-if="hearAbout=Event">
                <fieldset>
                    <legend>Which event or location?</legend>
                    <input type="text" name="eventDetails" placeholder="Event or Location Name" class="step-input">
                </fieldset>
            </div>

            <!-- Other follow-up -->
            <div class="step marketing-step" data-step-id="q18F" data-show-if="hearAbout=Other">
                <fieldset>
                    <legend>Please tell us how you heard about us:</legend>
                    <input type="text" name="otherDetails" placeholder="Details" class="step-input">
                </fieldset>
            </div>

            <div class="actions sticky">
                <button class="btn" id="backBtn" type="button">‚óÄ Back</button>
                <button class="btn primary" id="nextBtn" type="button">Next ‚ñ∂</button>
            </div>
        </section>

        <!-- LOADING / WAITING SCREEN -->
        <section id="loading" class="card hidden" aria-live="polite">
            <h2 id="loadingTitle">Analyzing results‚Ä¶</h2>
            <p id="loadingSub">Finding the best program for your Ninja‚Ä¶</p>
            <div class="spinner" aria-hidden="true"></div>
        </section>

        <!-- RESULT VIEW -->
        <section id="result" class="card" aria-live="polite">
            <h2 id="personaTitle"></h2>
            <p id="personaBlurb"></p>
            <h2 id="recTitle"></h2>
            <p id="recBlurb"></p>
            <ul id="recPoints"></ul>

            <div id="funFact" class="hidden">
                <strong>Fun Fact for Your Ninja!</strong>
                <div id="funFactText"></div>
            </div>

            <h3 class="center" style="margin:24px 0 12px; color: var(--brand);">At-a-glance match</h3>
            <div id="stats"></div>

            <p class="center" id="centerNote" style="font-weight:bold; margin-bottom:24px;"></p>
            <div class="actions center" style="justify-content:center; margin-top:32px; flex-wrap:wrap;">
                <!-- If multi-child, this button will say "Next Child" -->
                <button class="btn primary" id="nextChildBtn" type="button"
                    style="display:none; margin-bottom:12px;">Start Next Child ‚ñ∂</button>
                <button class="btn" id="retakeBtn" type="button">Back To Home</button>
            </div>
        </section>
    </div>

    <!-- Web3Forms form (hidden; includes required fields) -->
    <!-- Target a hidden iframe to avoid redirection/reload on file:// -->
    <iframe name="hidden_iframe" style="display:none;"></iframe>
    <form id="web3Form" class="hidden" action="https://api.web3forms.com/submit" method="POST" target="hidden_iframe">
        <input type="hidden" name="access_key" value="fa23863b-372c-4f44-b8e4-dd8f0ec3b087">
        <input type="hidden" name="name" id="wf_name" required>
        <!-- Email removed as requested -->
        <textarea name="message" id="wf_message" style="display:none;" required></textarea>
        <input type="hidden" name="subject" id="wf_subject" value="New Ninja Path Finder Lead">
        <input type="hidden" name="from_name" value="Code Ninjas Program Finder">
    </form>

    <script>
        (function () {
            const $ = (s, root = document) => root.querySelector(s);
            const $$ = (s, root = document) => Array.from(root.querySelectorAll(s));
            window.API_Access = true; // set to false to skip Web3Forms submit

            // ---------- PRESTART ----------
            const prestart = $('#prestart');
            const startBtn = $('#startQuizBtn');
            const childSetup = $('#child-setup');
            const confirmChildrenBtn = $('#confirmChildrenBtn');
            const childNamesArea = $('#child-names-area');
            const childNamesContainer = $('#child-names-inputs');
            // --- TRANSLATION LOGIC ---
            const langSelect = $('#langSelect');
            let currentLang = 'en';

            function normalize(str) {
                return str.replace(/\s+/g, ' ').trim();
            }

            function t(text) {
                if (currentLang === 'en' || !window.ALL_TRANSLATIONS) return text;
                const dict = ALL_TRANSLATIONS[currentLang];
                if (!dict) return text;
                const norm = normalize(text);
                return dict[norm] || text;
            }

            function translatePage() {
                console.log('Translating page to:', currentLang);
                console.log('ALL_TRANSLATIONS available:', !!window.ALL_TRANSLATIONS);

                // Translate all translatable elements
                const selector = 'h1, h2, h3, h4, p, legend, button, strong, .prestart-label';
                $$(selector).forEach(el => {
                    if (el.closest('#langSelect')) return;
                    if (el.querySelector('input, select, textarea')) return; // Skip if has form elements

                    // Store original if not already stored
                    if (!el.dataset.originalText) {
                        el.dataset.originalText = el.textContent.trim();
                    }

                    const original = el.dataset.originalText;
                    if (original) {
                        el.textContent = t(original);
                    }
                });

                // Translate hints and options (text inside labels with checkboxes)
                $$('span.hint, div.hint').forEach(el => {
                    if (!el.dataset.originalText) {
                        el.dataset.originalText = el.textContent.trim();
                    }
                    const original = el.dataset.originalText;
                    if (original) {
                        el.textContent = t(original);
                    }
                });

                // Translate label text nodes (keep checkboxes/radios intact)
                $$('label.opt').forEach(label => {
                    label.childNodes.forEach(node => {
                        if (node.nodeType === 3) { // Text node
                            const text = node.nodeValue.trim();
                            if (text.length > 0) {
                                if (!node._original) node._original = text;
                                node.nodeValue = ' ' + t(node._original) + ' ';
                            }
                        }
                    });
                });

                // Translate options
                $$('select option').forEach(opt => {
                    if (opt.closest('#langSelect')) return;
                    if (!opt.dataset.originalText) {
                        opt.dataset.originalText = opt.textContent.trim();
                    }
                    const original = opt.dataset.originalText;
                    if (original) {
                        opt.textContent = t(original);
                    }
                });

                // Handle Placeholders
                $$('input, textarea').forEach(el => {
                    if (el.placeholder) {
                        if (!el.dataset.originalPlaceholder) {
                            el.dataset.originalPlaceholder = el.placeholder;
                        }
                        el.placeholder = t(el.dataset.originalPlaceholder);
                    }
                });

                // Update dynamic wizard elements
                if (!$('#wizard').classList.contains('hidden') && typeof childNames !== 'undefined' && childNames[currentChildIndex]) {
                    const activeChild = childNames[currentChildIndex];
                    if (numChildren > 1) {
                        $('#childContextBanner').textContent = t("Questionnaire for") + ` ${activeChild.name}`;
                        const genderLegend = $('#genderLegend');
                        if (genderLegend) genderLegend.textContent = `${activeChild.name} ` + t("is a...");
                    } else {
                        const genderLegend = $('#genderLegend');
                        if (genderLegend) genderLegend.textContent = t("My child is a...");
                    }
                }

                // Update button text
                const backBtn = $('#backBtn');
                if (backBtn) backBtn.textContent = t("‚óÄ Back");

                console.log('Translation complete');
            }

            langSelect.addEventListener('change', function () {
                currentLang = this.value;
                console.log('Language changed to:', currentLang);
                translatePage();
            });

            // -------------------------

            const inputsPre = {
                parentFirst: $('#parentFirst'),
                parentLast: $('#parentLast'),
                location: $('#location')
            };

            let parentFirst = '', parentLast = '', centerLocation = '';
            let numChildren = 1;
            let childNames = []; // Array of {name, age} objects
            let currentChildIndex = 0; // 0-based index for flow
            let currentChildAge = ''; // Store current age for logic

            // ---------- CHILD SETUP LOGIC ----------
            // Listen for radio changes
            const childRadios = $$('input[name="numChildrenChoice"]', childSetup);
            childRadios.forEach(r => {
                r.addEventListener('change', updateChildInputs);
            });

            function updateChildInputs() {
                const selected = $('input[name="numChildrenChoice"]:checked', childSetup);
                const n = parseInt(selected ? selected.value : 1, 10);
                numChildren = n;

                childNamesContainer.innerHTML = '';

                if (n > 1) {
                    childNamesArea.classList.remove('hidden');
                } else {
                    // Even for 1 child, show input now to capture age and name
                    childNamesArea.classList.remove('hidden');
                }

                for (let i = 0; i < n; i++) {
                    const group = document.createElement('div');
                    group.className = 'child-info-group';

                    const label = document.createElement('h4');
                    label.textContent = t("Child") + ` ${i + 1}`;
                    group.appendChild(label);

                    const nameInp = document.createElement('input');
                    nameInp.placeholder = t("Name");
                    nameInp.className = 'step-input';
                    nameInp.dataset.type = 'name';
                    nameInp.dataset.index = i;
                    nameInp.style.margin = '0'; // override step-input margin
                    nameInp.addEventListener('input', validateChildSetup);
                    group.appendChild(nameInp);

                    const ageSelect = document.createElement('select');
                    ageSelect.className = 'step-input';
                    ageSelect.dataset.type = 'age';
                    ageSelect.dataset.index = i;
                    ageSelect.style.margin = '0';
                    ageSelect.innerHTML = `
        <option value="">${t("Select Age")}</option>
        <option value="5-7">5-7</option>
        <option value="8-10">8-10</option>
        <option value="11-13">11-13</option>
        <option value="14+">14+</option>
      `;
                    ageSelect.addEventListener('change', validateChildSetup);
                    group.appendChild(ageSelect);

                    childNamesContainer.appendChild(group);
                }

                validateChildSetup();
            }

            function validateChildSetup() {
                const nameInputs = $$('input[data-type="name"]', childNamesContainer);
                const ageSelects = $$('select[data-type="age"]', childNamesContainer);

                const allFilled = nameInputs.every(i => i.value.trim().length > 0) &&
                    ageSelects.every(s => s.value !== "");

                confirmChildrenBtn.disabled = !allFilled;

                if (allFilled) {
                    childNames = nameInputs.map((inp, i) => ({
                        name: inp.value.trim(),
                        age: ageSelects[i].value
                    }));
                }
            }

            function syncStartState() {
                parentFirst = (inputsPre.parentFirst.value || '').trim();
                parentLast = (inputsPre.parentLast.value || '').trim();
                centerLocation = (inputsPre.location.value || '').trim();
                startBtn.disabled = !(parentFirst && parentLast && centerLocation);
            }

            Object.values(inputsPre).forEach(el => {
                el.addEventListener('input', syncStartState);
                el.addEventListener('change', syncStartState);
            });

            // Auto-advance from first name to last name on space
            inputsPre.parentFirst.addEventListener('keydown', (e) => {
                if (e.key === ' ' || e.keyCode === 32) {
                    e.preventDefault(); // Prevent space from being added
                    inputsPre.parentLast.focus(); // Move focus to last name
                }
            });

            // ---------- GEMINI CONFIG (Pathfinder) ----------
            // API key is now stored securely on the backend
            // Configure your backend endpoint URL here:
            // Use full Vercel URL for GitHub Pages compatibility
            const BACKEND_API_URL = "https://pathfinder-nz0w16v5e-brennan-sheas-projects.vercel.app/api/gemini-proxy";
            const GEMINI_MODEL_CANDIDATES = [
                "gemini-3-flash-preview",
                "gemini-2.0-flash-lite"
            ];

            // ---------- MONDAY.COM CONFIG ----------
            const MONDAY_API_KEY = "eyJhbGciOiJIUzI1NiJ9.eyJ0aWQiOjU4OTAyOTQzOSwiYWFpIjoxMSwidWlkIjo3NTMwMjU1MiwiaWFkIjoiMjAyNS0xMS0yMFQyMToxMjozNy41ODNaIiwicGVyIjoibWU6d3JpdGUiLCJhY3RpZCI6NDUyNzc2MiwicmduIjoidXNlMSJ9.a2Red9Ww-10aTnajvTYSY3L_wam9QXjymTnDPQilVvU";
            const MONDAY_BOARD_ID = "18386836956";
            const MONDAY_ENABLED = true;

            // Column ID mapping from Monday.com board
            const MONDAY_COLUMN_MAP = {
                "Location": "text_mkxwt53n",
                "Submitted Date": "date_mkxwqv92",
                "Number of Children": "numeric_mkxw3mg8",
                "Recommended Program": "text_mkxwqhx7",
                "Persona": "text_mkxwqt3c",
                "Persona Description": "long_text_mkxwrjmw",
                "Child Age Group": "text_mkxw4cpe",
                "Child Gender": "text_mkxw20nb",
                "Traits (5-7)": "long_text_mkxwdttr",
                "Play Preferences (5-7)": "long_text_mkxwa2pn",
                "Persistence (5-7)": "text_mkxwext4",
                "Traits (8-10)": "long_text_mkxwef2r",
                "Learning Style (8-10)": "text_mkxwf41x",
                "School Attitude (8-10)": "text_mkxwtjbj",
                "Re-engagement Method (8-10)": "text_mkxwwe8d",
                "Tech Confidence (8-10)": "text_mkxwg9ne",
                "Tech Experience (8-10)": "long_text_mkxwss9r",
                "Traits (11-13)": "long_text_mkxwd119",
                "Challenge Response (11-13)": "text_mkxwhsx0",
                "School Attitude (11-13)": "text_mkxwj8gy",
                "Enjoyment Factors (11-13)": "long_text_mkxwk6f7",
                "Tech Confidence (11-13)": "text_mkxwkkh4",
                "Leadership Interest (11-13)": "text_mkxwv77q",
                "Motivation (14+)": "text_mkxwwy4v",
                "Interests (14+)": "long_text_mkxwj3h3",
                "Tech Confidence (14+)": "text_mkxwajd",
                "Career Interest (14+)": "text_mkxw8m0e",
                "Growth Area (14+)": "text_mkxwdw5w",
                "Parent Goals": "long_text_mkxwxw14",
                "Future Focus": "text_mkxw5aqv",
                "AI Interest": "text_mkxwx5jj",
                "Marketing Source": "text_mkxwqcte",
                "Marketing Details": "long_text_mkxwztj1",
                "AI Email": "long_text_mkxwvzvf",
                "SMS Option 1": "long_text_mkxw2k76",
                "SMS Option 2": "long_text_mkxwmp0h",
                "Full Q&A Summary": "long_text_mkxwk1d6"
            };

            async function callGemini(promptText) {
                if (!BACKEND_API_URL) {
                    console.error("Backend API URL is not configured.");
                    return null;
                }

                try {
                    const res = await fetch(BACKEND_API_URL, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            prompt: promptText,
                            models: GEMINI_MODEL_CANDIDATES
                        })
                    });

                    if (!res.ok) {
                        const errorText = await res.text();
                        console.error("Backend API error:", res.status, errorText);
                        return null;
                    }

                    const data = await res.json();

                    // Backend should return { success: true, text: "..." } or { success: false, error: "..." }
                    if (data.success && data.text) {
                        return data.text;
                    } else {
                        console.error("Backend returned error:", data.error || "Unknown error");
                        return null;
                    }
                } catch (e) {
                    console.error("Failed to call backend API:", e);
                    return null;
                }
            }

            // Parse EMAIL + 3 SMS options from Gemini
            function extractSection(text, label) {
                const re = new RegExp(`---${label}---([\\s\\S]*?)(?=---[A-Z0-9]+---|$)`, 'i');
                const m = text.match(re);
                return m ? m[1].trim() : '';
            }

            async function generateAiComms(options) {
                const {
                    programDisplay,
                    apiProgramName,
                    personaLabel,
                    funFact,
                    bundleType,
                    academyBundleType, // AI or Robotics for Academy paths
                    marketingSource,
                    marketingSubsource,
                    qaSummaryLines,
                    currentChildName // Added context
                } = options;

                // Get Gender from Q0
                const gender = options.gender || '';

                let bundleInstruction = "";
                if (bundleType === '1+1_AI') {
                    bundleInstruction = `
üî• SPECIAL BUNDLE INSTRUCTION:
The recommended program is the "CREATE 1+1 Bundle".
You must refer to it specifically as "CREATE 1+1 Bundle" in both the Email and SMS.
This bundle combines "Code Ninjas CREATE" (their core belt progression) with "AI Academy" (their specific interest).
When explaining the fit, mention that this bundle gives them the best of both worlds: steady coding progress + exciting AI skills.
`;
                }

                const greetingName = parentFirst || "there";
                const centerName = centerLocation || "your local center";
                // Incorporate specific child name if multi-child
                const childRef = currentChildName ? currentChildName : "your child";

                // Construct pronoun hint based on gender
                let pronounHint = "";
                if (gender === 'Boy') pronounHint = `IMPORTANT: The child is a Boy. Use he/him/his pronouns when referring to ${childRef} after the first mention. Do NOT overuse the name.`;
                else if (gender === 'Girl') pronounHint = `IMPORTANT: The child is a Girl. Use she/her/her pronouns when referring to ${childRef} after the first mention. Do NOT overuse the name.`;
                else pronounHint = `Use they/them pronouns or the child's name when referring to ${childRef}.`;

                // BUNDLE / ACADEMY INSTRUCTIONS
                // Force AI to recommend either a Bundle or CREATE, never *just* Academy
                let programInstruction = "";

                // Determine the specific bundle type for Academy paths
                let specificBundleType = academyBundleType || '';
                if (!specificBundleType) {
                    if (bundleType === '1+1_Robotics') specificBundleType = 'Robotics';
                    else if (bundleType === '1+1_AI') specificBundleType = 'AI';
                    else if (apiProgramName === 'Code Ninjas Academy') specificBundleType = 'AI'; // Default
                }

                if (apiProgramName === 'Code Ninjas Academy') {
                    // Even if they hit the Academy logic, we sell it as a 1+1 Bundle
                    programInstruction = `
üî• PROGRAM INSTRUCTION:
The system recommended "CREATE 1+1 (${specificBundleType}) Bundle" (because they are Academy-ready).
You must refer to it specifically as "CREATE 1+1 (${specificBundleType}) Bundle" in both the Email and SMS.
This bundle combines "Code Ninjas CREATE" (their core belt progression) with "${specificBundleType} Academy" (their specific interest).
When explaining the fit, mention that this bundle gives them the best of both worlds: steady coding progress + ${specificBundleType === 'AI' ? 'exciting AI skills' : 'hands-on engineering skills'}.
Do NOT offer Academy as a standalone option. It is a bundle.
`;
                } else if (bundleType === '1+1_AI') {
                    programInstruction = `
üî• SPECIAL BUNDLE INSTRUCTION:
The recommended program is the "CREATE 1+1 (AI) Bundle".
You must refer to it specifically as "CREATE 1+1 (AI) Bundle" in both the Email and SMS.
This bundle combines "Code Ninjas CREATE" (their core belt progression) with "AI Academy" (their specific interest).
When explaining the fit, mention that this bundle gives them the best of both worlds: steady coding progress + exciting AI skills.
`;
                } else if (bundleType === '1+1_Robotics') {
                    programInstruction = `
üî• SPECIAL BUNDLE INSTRUCTION:
The recommended program is the "CREATE 1+1 (Robotics) Bundle".
You must refer to it specifically as "CREATE 1+1 (Robotics) Bundle" in both the Email and SMS.
This bundle combines "Code Ninjas CREATE" (their core belt progression) with "Robotics Academy" (their specific interest).
When explaining the fit, mention that this bundle gives them the best of both worlds: steady coding progress + hands-on engineering skills.
`;
                } else if (bundleType === '1+1+1') {
                    programInstruction = `
üî• SPECIAL BUNDLE INSTRUCTION:
The recommended program is the "CREATE 1+1+1 Bundle".
You must refer to it specifically as "CREATE 1+1+1 Bundle" in both the Email and SMS.
This bundle combines "Code Ninjas CREATE", "Academy", and "Clubs".
When explaining the fit, mention that this bundle gives them the ultimate experience: coding, advanced skills (AI/Robotics), and social clubs.
`;
                }


                const prompt =
                    `YOU ARE AN ENROLLMENT ADVISOR AT CODE NINJAS.

üö® CRITICAL LANGUAGE INSTRUCTION: All generated content (Email, SMS, CD Tools) MUST be written in ENGLISH. Do not translate the generated content even if the input or child's name suggests a non-English background.

${pronounHint}

${programInstruction}

üö® CRITICAL: The child's name is "${childRef}". You MUST use "${childRef}" throughout ALL communications (email, SMS, and CD Tools). NEVER use "your child" or "the child" - ALWAYS use the name "${childRef}".

A parent has just completed an in-center game-building visit and filled out the Pathfinder questionnaire.
You must generate ALL of the following in one response:
---CD_TOOLS---
(A) Primary Closing Script
(B) Backup Closing Script
(C) Tone Instruction
(D) Sales Tips for This Family
(E) Post-Sale Retention Speech
(F) Follow-Up Timing Rules
¬†
---EMAIL---
(parent email)
¬†
---SMS1---
(next-day text)
¬†
---SMS2---
(three-days-later text with 48-hour urgency)
Your messaging MUST be emotionally persuasive, human, and deeply tailored to:
* the child‚Äôs¬†age path¬†(JR 5‚Äì7, CREATE 8‚Äì13, ACADEMY 14+)
* the child‚Äôs¬†trait patterns¬†(creative, analytical, imaginative, shy, competitive, intellectual, etc.)
* the child‚Äôs¬†learning/engagement patterns
* the parent‚Äôs¬†top goals¬†(confidence, academic advantage, creativity, future skills, focus, social connection, leadership, etc.)
* the parent‚Äôs¬†future-skills / AI importance level
* the¬†recommended program and bundle
* the¬†marketing source
* the emotional weight of the parent‚Äôs stated priorities
You must NEVER reference the questionnaire.You must NEVER repeat traits literally.You must ALWAYS translate insights into believable human observations.
Tone =¬†Warm Mentor + High Conversion¬†unless otherwise indicated by the logic below.

üî•¬†SECTION 1 ‚Äî TRAIT TRANSLATION DICTIONARY (EMOTIONAL OBSERVATION ENGINE)
You must NEVER say:‚Äúyou selected,‚Äù ‚Äúyou said,‚Äù ‚Äúyour answers showed,‚Äù ‚Äúthey are curious,‚Äù etc.
Instead translate traits into natural observations:
Creative ‚Üí ‚Äú${childRef} quickly added their own spin once they understood the tools.‚Äù
Curious ‚Üí ‚Äú${childRef} asked thoughtful questions as soon as something clicked.‚Äù
Analytical ‚Üí ‚Äú${childRef} likes to understand how things work before moving to the next step.‚Äù
Intellectual ‚Üí ‚Äú${childRef} thinks deeply about how pieces fit together and enjoys making sense of complexity.‚Äù
Competitive ‚Üí ‚Äú${childRef} leaned in once they realized they could get something working.‚Äù
Shy ‚Üí ‚Äú${childRef} opened up nicely once they felt comfortable with the flow of things.‚Äù
Energetic ‚Üí ‚Äú${childRef} was happiest when they could move between steps and keep momentum.‚Äù
Social ‚Üí ‚Äú${childRef} enjoyed checking in with others and sharing what they built.‚Äù
Focused ‚Üí ‚Äú${childRef} settled in and concentrated once they understood the goal.‚Äù
Easily Distracted ‚Üí ‚Äú${childRef} stayed engaged once they had something hands-on to build.‚Äù
Gets Bored ‚Üí ‚Äú${childRef} lit up when learning felt fast-paced and interactive.‚Äù
Use 1‚Äì2 per message.

üî•¬†SECTION 2 ‚Äî SESSION CONTEXT PHRASES (MANDATORY)
Always reference the child‚Äôs¬†actual session:
JR 5‚Äì7
* ‚Äútheir hands-on STEM activity‚Äù
* ‚Äútheir little engineering challenge‚Äù
* ‚Äúcreative building time‚Äù
CREATE 8‚Äì13
* ‚Äútheir game-building session‚Äù
* ‚Äúexperimenting with game logic‚Äù
* ‚Äúgetting something to move on screen‚Äù
* ‚Äúbuilding their first playable element‚Äù
ACADEMY 14+
* ‚Äútheir advanced game-building/tech session‚Äù
* ‚Äúdiving into more complex tools‚Äù
* ‚Äúapproaching the work with real maturity‚Äù
Use micro-observations:
* ‚Äú${childRef} really locked in once they saw they could make something move.‚Äù
* ‚Äú${childRef} was proud when that first piece worked.‚Äù

üî•¬†SECTION 3 ‚Äî PROGRAM PERSUASION ENGINE
(This determines how you justify the recommended program.)
JR (5‚Äì7)
Emphasize:
* confidence
* early problem-solving
* fun + structure
* creative exploration
* independence at their pace
CREATE (8‚Äì13)
Emphasize:
* engagement
* instant results
* creativity + logic
* belt progression
* consistency
* problem-solving
ACADEMY (14+)
Emphasize:
* future skills
* responsibility
* portfolio-building
* leadership
* AI / robotics readiness
* real-world relevance

üî•¬†SECTION 4 ‚Äî PARENT GOAL MAPPING
(Used to choose scripts, tone, and persuasion angle.)
CONFIDENCE
Focus on: small wins, structure, steady progress, encouragement.
FOCUS / DISCIPLINE
Focus on: routine, productive challenge, consistent momentum.
CREATIVITY
Focus on: expression, building things that feel personal, exploration.
FUTURE SKILLS (Coding/AI/Robotics)
Focus on: preparing for tomorrow, lifelong value, shaping technology.
ACADEMIC ADVANTAGE
Focus on: comprehension, critical thinking, memory, problem-solving.
TEAMWORK / SOCIAL
Focus on: belonging, shared building, communication, peer motivation.
LEADERSHIP
Focus on: project ownership, mentoring moments, responsibility.

üî•¬†SECTION 5 ‚Äî SKILLS-OVER-JOBS LOGIC
Include ‚Äúfuture impact‚Äù messaging ONLY IF:
* parent selected¬†future skillsAND
* parent selected¬†AI importance = Essential or Very important
Then you may include lines like:
* ‚ÄúKids who understand how technology¬†works¬†will have an advantage in anything they pursue.‚Äù
* ‚ÄúWe focus on skills that never expire ‚Äî creativity, problem-solving, resilience.‚Äù
* ‚ÄúThese are the literacy skills of the modern world.‚Äù
Never mention the phrase ‚Äúskills over jobs.‚ÄùOnly express the concept emotionally.
üî•¬†SECTION 6 ‚Äî TONE ENGINE
Choose tone based on¬†child traits,¬†parent goals,¬†program, and¬†AI importance.
A. Soft / Nurturing Tone
Use when:
* Child is shy, easily frustrated, very young
* Parent prioritizes confidence or comfort
Use phrases like:
* ‚Äúat their own pace‚Äù
* ‚Äúwhere they feel supported‚Äù
* ‚Äúbuild confidence gently‚Äù

B. High-Conversion / Confident Tone (DEFAULT)
Use when:
* Parent wants future skills
* Child is advanced / analytical / competitive
* Parent selected academic advantage
* Parent selected AI importance Essential/Very Important
* Child showed strong engagement during the session
Use phrases like:
* ‚ÄúThis is the ideal next step.‚Äù
* ‚ÄúThey‚Äôre ready for something more challenging.‚Äù
* ‚ÄúThis will move them forward quickly.‚Äù

C. Warm Mentor Tone
Use when:
* Parent wants confidence + creativity
* Child is mixed traits (creative + shy, curious + energetic)
Use phrases like:
* ‚Äú${childRef} really came alive once they got to create.‚Äù
* ‚ÄúThis gives them a place to grow in a way that feels good.‚Äù

D. Calm Guide Tone
Use when:
* Parent is cautious or analytical
* Teen showing career interest
* Parent emphasizes structure
Use:
* ‚Äúclear pathway,‚Äù
* ‚Äúreal-world relevance,‚Äù
* ‚Äúconsistent growth.‚Äù

üî• SECTION 7 ‚Äî SCRIPT SELECTION ENGINE
Use the following mapping to choose one Primary Script and one Backup Script.
You must choose based on a combination of:
‚úî Parent Goal
‚úî Age Path
‚úî Child Traits
‚úî Future Skills Weighting
‚úî AI Importance
‚úî Program Recommended
NEVER choose scripts randomly. ALWAYS use this mapping.
CRITICAL: Primary scripts must ONLY reference questionnaire answers. NEVER reference specific events from the session or dojo.

‚≠ê PRIMARY CLOSING SCRIPTS (VALUE-ONLY) ‚Äî 20 TOTAL
Choose based on mapping below. Rewrite slightly to match tone and specificity of child.

1. Confidence Builder
‚Äú${childRef} already showed they can push through challenges ‚Äî this is the kind of environment where that confidence grows fast.‚Äù
2. Small Wins Path
‚ÄúYou saw how proud ${childRef} was when something worked ‚Äî this program gives them those kinds of wins every week.‚Äù
3. Creative Momentum
‚Äú${childRef} lights up when they get to make something their own ‚Äî this path really fuels that creativity.‚Äù
4. Deep Thinker Fit
‚Äú${childRef} loves understanding how things work ‚Äî this gives them meaningful problems to solve, not busywork.‚Äù
5. Focus & Structure
‚ÄúOnce ${childRef} had a clear goal, they locked in ‚Äî this program gives them that structure every time they come.‚Äù
6. Future-Skills Path
‚ÄúThese skills are becoming foundational ‚Äî this is the perfect place to begin building them now.‚Äù
7. Academic Advantage
‚ÄúThis strengthens the exact thinking skills that help in school ‚Äî problem-solving, logic, and persistence.‚Äù
8. Resilient Learner
‚Äú${childRef} didn‚Äôt quit when things got tricky ‚Äî here, that resilience becomes one of their superpowers.‚Äù
9. JR ‚Äì Early Builder
‚Äú${childRef} loves hands-on building ‚Äî JR gives them the perfect mix of structure and play to grow.‚Äù
10. JR ‚Äì Young Explorer
‚ÄúAt this age, learning through discovery is everything ‚Äî JR gives ${childRef} that space in a guided way.‚Äù
11. CREATE ‚Äì Game Maker Identity
‚Äú${childRef} connected so fast with game-building ‚Äî CREATE turns that curiosity into real skills.‚Äù
12. CREATE ‚Äì Challenge Response
‚ÄúWhen the challenge went up, their engagement went up ‚Äî CREATE gives them exactly that level of challenge.‚Äù
13. CREATE ‚Äì Belt Progress Track
‚Äú${childRef} will thrive with the steady progress and accomplishment built into the CREATE belt path.‚Äù
14. ACADEMY ‚Äì Ownership & Independence
‚Äú${childRef} is ready for something with more responsibility ‚Äî ACADEMY gives them room to own real projects.‚Äù
15. ACADEMY ‚Äì Future-Focused
‚Äú${childRef} is thinking about the future already ‚Äî ACADEMY gives them skills they can actually use.‚Äù
16. Social Growth
‚Äú${childRef} opened up really nicely in this space ‚Äî they‚Äôll find peers here who learn the same way.‚Äù
17. Leadership Path
‚Äú${childRef} naturally steps into leadership moments ‚Äî this program helps develop that in a structured way.‚Äù
18. Highly Analytical Fit
‚Äú${childRef} thinks three steps ahead ‚Äî this path challenges them in exactly the right way.‚Äù
19. Creative Problem Solver
‚Äú${childRef} is most alive when solving problems creatively ‚Äî this program leans into that strength.‚Äù
20. Momentum Builder
‚ÄúYou saw how quickly ${childRef} found their rhythm ‚Äî this is where they can build real momentum.‚Äù

‚≠ê BACKUP CLOSING SCRIPTS (VALUE + DISCOUNT) ‚Äî 20 TOTAL
Used ONLY after hesitation. Must feel warm, helpful, and never pushy.
(Always include the $99 waiver as needed.)

1. Confidence Boost
‚ÄúIf it helps, I can waive the $99 enrollment fee today ‚Äî I really think ${childRef} will thrive here.‚Äù
2. Creative Spark
‚Äú${childRef} clearly loved creating ‚Äî I can waive the $99 fee to help you get them started.‚Äù
3. Future-Skills Support
‚ÄúThese skills matter long-term ‚Äî if it helps, I can remove the $99 fee today.‚Äù
4. AI + Robotics Motivator
‚Äú${childRef} is ready for deeper tech ‚Äî I‚Äôm happy to waive the $99 fee if you want to move forward.‚Äù
5. Focus & Structure
‚Äú${childRef} responds so well to structured challenge ‚Äî I can waive the fee if that helps your decision.‚Äù
6. Academic Alignment
‚ÄúThis strengthens how ${childRef} thinks ‚Äî I can waive the $99 fee to make it easier to start.‚Äù
7. Social Confidence
‚Äú${childRef} really opened up here ‚Äî I can remove the fee if that helps you.‚Äù
8. Leadership Path
‚Äú${childRef} is ready for more responsibility ‚Äî I can waive the enrollment fee today.‚Äù
9. Analytical Fit
‚Äú${childRef} loves meaningful challenge ‚Äî I‚Äôm happy to waive the $99 fee if you‚Äôd like to begin.‚Äù
10. Engagement Momentum
‚Äú${childRef} was so engaged ‚Äî I can waive the fee if you want to build on that.‚Äù
11. JR ‚Äì Early Builder
‚Äú${childRef} had such a good time ‚Äî I can waive the $99 fee to help you start today.‚Äù
12. JR ‚Äì Young Explorer
‚ÄúWe can build on that excitement ‚Äî I can remove the enrollment fee.‚Äù
13. CREATE ‚Äì Ready for Belts
‚Äú${childRef} is ready to start earning belts ‚Äî I can waive the fee to help you get going.‚Äù
14. CREATE ‚Äì Game Builder
‚Äú${childRef} connected with game-building ‚Äî I can waive the fee if it helps.‚Äù
15. ACADEMY ‚Äì Future Skills
‚ÄúThese skills matter ‚Äî happy to remove the fee today.‚Äù
16. ACADEMY ‚Äì Independence Ready
‚Äú${childRef} is ready for bigger projects ‚Äî I can waive the fee.‚Äù
17. Momentum Support
‚ÄúYou saw the spark ‚Äî I can help by removing the fee.‚Äù
18. Engagement Proof
‚Äú${childRef} was fully locked in ‚Äî I can waive the $99 fee.‚Äù
19. Parent Uncertain
‚ÄúI understand ‚Äî and if it helps, I‚Äôm happy to waive the fee.‚Äù
20. Mild Hesitation
‚ÄúI get it ‚Äî if it makes the decision easier, I can remove the enrollment fee today.‚Äù

üî• SECTION 8 ‚Äî POST-SALE RETENTION SPEECH
This speech must appear in the CD Tools section so CDs know to say it only AFTER the parent hands over the credit card.
Do NOT output a verbatim script. Instead, generate a natural, conversational speech (approx. 100-150 words) that covers these key points in your own words, tailored to the child (${childRef}):

1.  **Skills are valuable but hard:** Acknowledge that coding, robotics, and AI are powerful skills for ${childRef}'s future, but they are challenging to learn.
2.  **Struggle is normal:** Explain that there will be days when code doesn't work or things get frustrating. This is a normal part of the process for every Ninja.
3.  **We don't fix, we guide:** Clarify that Senseis won't just "fix" the problem for ${childRef}, but will guide them to solve it themselves. This builds real confidence and problem-solving resilience.
4.  **Parent's role:** Ask the parent to help by encouraging ${childRef} to stick with it during those tough moments, rather than letting them quit.
5.  **Partnership:** Reiterate that this is a partnership to help ${childRef} grow into a thinker and leader.

Make it sound warm, professional, and encouraging. Use ${childRef}'s name naturally.

üî• SECTION 9 ‚Äî SALES TIP ENGINE
Generate 2‚Äì3 tailored sales tips inside the CD Tools section.
They must be:
* highly specific to the child
* emotionally aligned with the parent‚Äôs deepest goals
* easy for a CD to remember
* persuasive but natural
* tied to future-skills, confidence, or the child's behavior in the session
Examples of styles:
* ‚ÄúEmphasize that they learn best through hands-on building ‚Äî CREATE is perfect for that.‚Äù
* ‚ÄúHighlight how they stayed engaged once challenged ‚Äî parent cares about focus and consistency.‚Äù
* ‚ÄúReinforce future-skills language; parent is thinking long-term.‚Äù
* ‚ÄúMention belt progression ‚Äî this family wants structure.‚Äù

üî•¬†SECTION 11 ‚Äî MARKETING SOURCE INFLUENCE
Use the marketing question to subtly shape your persuasion angle.
If¬†Friend Referral
‚Üí emphasize community, belonging, kids loving it.
If¬†School
‚Üí emphasize academic advantage, focus, comprehension, problem-solving.
If¬†Google / Searching
‚Üí emphasize clarity, trust, structure, and quality.
If¬†Social Media
‚Üí emphasize creativity, excitement, fun, modern skills.
If¬†Event
‚Üí emphasize momentum and positive first impression.
NEVER mention the marketing source in the parent email.Use the angle only in tone and positioning.

üî•¬†SECTION 12 ‚Äî FOLLOW-UP TIMING RULES
The CD Tools section must include these EXACT bullets:
‚Ä¢ Send parent email today between 4‚Äì8 PM.
‚Ä¢ Send SMS #1 tomorrow at 4 PM.
‚Ä¢ Send SMS #2 three days later (48-hour reminder).
Never mention specific times in the messages themselves.

üî•¬†SECTION 13 ‚Äî DISCOUNT LOGIC
Discount logic must follow these rules strictly:
Email
Use the exact required sentence:‚ÄúAs a thank-you for taking the time to complete this questionnaire, you can enroll using this link: [ENROLLMENT_LINK]. Use code C9J5 at checkout to waive the enrollment fee if you enroll in the next few days.‚Äù
SMS #1
Mention ‚Äúoffer expires in the next few days.‚Äù
SMS #2
Mention ‚Äúexpires in 48 hours.‚Äù
Backup Script
May include: ‚ÄúI can waive the $99 enrollment fee today if it helps you decide.‚Äù
NEVER mention multiple different discounts.NEVER offer more than one code.NEVER imply price changes.

üî•¬†SECTION 15 ‚Äî PARENT EMAIL RULES
After the CD Tools section, generate a¬†parent-facing email.
The email must follow ALL of these rules:
Structure
---EMAIL---
<email content>
Tone
* Warm
* Human
* Encouraging
* Future-focused
* Confident
* Never robotic
* Never corporate
* Never salesy
* Never mention questionnaire
* Never mention ‚Äúyour answers‚Äù, ‚Äúyou selected‚Äù, ‚Äúbased on your form‚Äù, etc.
* Never use "your child" or "the child" - ALWAYS use ${childRef} or appropriate pronouns (he/she/they).
Content Requirements
REMINDER: Use "${childRef}" (the child's actual name) in the first reference, then switch to pronouns (he/she/they) to avoid repetition. Never write "your child".
The email MUST:
1. Begin with:‚ÄúDear ${greetingName},‚Äù
2. Start the first paragraph with:
    * 1 translated child observation
    * A reference to their session type (JR, CREATE, ACADEMY)
    * A warm emotional insight
    * CRITICAL: The very first sentence of the email body MUST start with the child's name (e.g., "It was great seeing [Child Name]..."). Do NOT start with "It was great seeing him" or "It was great seeing her".
3. Explain why the recommended program${programDisplay}fits ${childRef} emotionally and logically.
4. Include one subtle future-skills line if triggered by logic.
5. Include the EXACT required discount sentence:"As a thank-you for taking the time to complete this questionnaire, you can enroll using this link: [ENROLLMENT_LINK]. Use code C9J5 at checkout to waive the enrollment fee if you enroll in the next few days."
6. Close with:
Warmly,
[Center Director Name]
Code Ninjas ${centerName}
Email Length Rules
* Max 3 short paragraphs
* Max 160 words
* No emojis
* No bullet lists
* No asterisks (*) anywhere in the email body
* Do NOT include the Q&A summary
* No references to CD Tools
* No references to scripts
* No references to discount logic rules

üî•¬†SECTION 16 ‚Äî SMS #1 (Next Day at 4 PM)
Structure
---SMS1---
<text>
Tone
* Warm
* Light, encouraging
* Not overly formal
* Not overly excited
* No emojis
* No pressure
REMINDER: Use "${childRef}" (the child's actual name) once, then use pronouns. Do not use "your child".
Content Requirements
* 1 translated observation
* 1 reference to activity (‚Äúgame-building‚Äù, ‚Äútheir session yesterday‚Äù)
* Tie to one parent goal
* Include the [ENROLLMENT_LINK]
* Mention the offer expires ‚Äúin the next few days‚Äù
* 1 sentence or 2 short sentences max
Example style:
‚ÄúYesterday ${childRef} really lit up once they started building their game. If you'd like to keep that momentum going, you can save their spot here: [ENROLLMENT_LINK] (offer expires in the next few days).‚Äù

üî•¬†SECTION 17 ‚Äî SMS #2 (Three Days Later ‚Äî 48-Hour Urgency)
Structure
---SMS2---
<text>
Tone
* Respectful urgency
* Still warm and human
* No pushing
* No guilt
* No emojis
REMINDER: Use "${childRef}" (the child's actual name), not "your child".
Content Requirements
* 1 positive observation
* Mention code¬†C9J5
* Say it ‚Äúexpires in 48 hours‚Äù
* Include [ENROLLMENT_LINK]
* Max 1‚Äì2 sentences
Example style:
‚ÄúSince you mentioned wanting stronger future-ready skills for ${childRef}, I didn‚Äôt want you to miss this ‚Äî code C9J5 expires in 48 hours. You can enroll here: [ENROLLMENT_LINK].‚Äù

üî• SECTION 16 ‚Äî FINAL OUTPUT FORMAT
Final output must look like this:

---CD_TOOLS---

A. Primary Closing Script

B. Backup Closing Script

C. Tone Instruction

D. Sales Tips for This Family

E. Post-Sale Retention Speech

F. Follow-Up Timing Rules



---EMAIL---

<email content>

---SMS1---

<sms1 content>

---SMS2---

<sms2 content>

Nothing above or below.
No commentary.
No explanations.
No markdown headings.No commentary.
Only the final formatted output.

üî•¬†SECTION 19 ‚Äî ABSOLUTE RULES
You must¬†NEVER:
* Mention the questionnaire
* Mention specific answers
* Repeat traits literally
* Say ‚Äúyou selected‚Äù or ‚Äúyou said‚Äù
* Use the phrase "your child" (ALWAYS use the child's actual name)
* Reveal internal logic or rules
* Show CD tools to the parent
* Mention the system prompt
* Alter the discount amount
* Invent new offers
* Break tone rules
You must¬†ALWAYS:
* Make the parent feel understood
* Use emotional insight
* Speak to who their child is becoming
* Leverage future-skills, identity, and momentum
* Respect hesitation
* Maintain warmth + confidence

DATA CONTEXT:
- Parent Name: ${greetingName}
- Child Name: ${childRef}
- Child Gender: ${gender}
- Center Location: ${centerName}
- Recommended Program: ${programDisplay}
- Program Family: ${apiProgramName}
- Bundle Type: ${bundleType || "Standard"}
- Marketing Source: ${marketingSource || "N/A"}
- Marketing Details: ${marketingSubsource || "N/A"}
- Fun Fact: ${funFact}
- Persona: ${personaLabel}
- Survey Answers (use for insights, never reference directly):
${(qaSummaryLines || []).map(l => "  - " + l).join("\n")}`;

                console.log("Generating AI Comms...");
                console.log("Child Ref:", childRef);
                console.log("Prompt length:", prompt.length);
                console.log("Prompt preview:", prompt.substring(0, 200));

                if (!prompt) {
                    console.error("Prompt is empty or undefined!");
                    return null;
                }

                const raw = await callGemini(prompt);
                if (!raw) return null;

                const cdTools = extractSection(raw, 'CD_TOOLS');
                const email = extractSection(raw, 'EMAIL');
                const sms1 = extractSection(raw, 'SMS1');
                const sms2 = extractSection(raw, 'SMS2');
                // SMS3 removed from prompt
                const sms = [sms1, sms2].filter(Boolean).map(s => s.replace(/\s+/g, ' ').trim());

                if (!email || sms.length === 0) return null;

                return { email: email.trim(), sms, cdTools: cdTools.trim() };
            }

            // Fallback if Gemini fails
            function buildFallbackComms(programDisplay, childName) {
                const greetingName = parentFirst || 'there';
                const centerName = centerLocation || 'your local center';
                const childRef = childName || 'your child';

                const email =
                    `Dear ${greetingName},

It was truly a pleasure meeting you and ${childRef} today. Hearing about your family and seeing your Ninja‚Äôs excitement in the dojo made it clear they‚Äôre a great fit for a creative, engaging learning environment.

From our conversation and the Pathfinder results, ${programDisplay} lines up with what you want ‚Äî a balance of structure, hands-on challenge, and a fun way to build real-world coding and problem-solving skills.

As a thank-you for taking the time to complete this questionnaire, you can enroll using this link: [ENROLLMENT_LINK]. Use code C9J5 at checkout to waive the enrollment fee if you enroll in the next few days.

Warmly,
[Center Director Name]
Code Ninjas ${centerName}`;

                const sms = [
                    `Code Ninjas ${centerName}: It was great meeting you and ${childRef} yesterday. From what you shared, ${programDisplay} gives them a fun way to build confidence, focus, and real tech skills. Sign up here: [ENROLLMENT_LINK] (offer ends in a few days).`,
                    `We loved having you and ${childRef} at Code Ninjas ${centerName}. ${programDisplay} is a great fit for the mix of creativity and structure you‚Äôre looking for. You can enroll at [ENROLLMENT_LINK] and use code C9J5 at checkout to waive the enrollment fee within 48 hours.`
                ];

                const cdTools = "CD Tools generation unavailable in fallback mode.";

                return { email, sms, cdTools };
            }

            // ---------- WIZARD STATE ----------
            const wizard = $('#wizard');
            const bar = $('#bar');
            const qnum = $('#qnum');
            const qtotalSpan = $('#qtotal');
            const backBtn = $('#backBtn');
            const nextBtn = $('#nextBtn');
            const result = $('#result');
            const loadingSection = $('#loading');
            const loadingTitle = $('#loadingTitle');
            const loadingSub = $('#loadingSub');
            const allSteps = $$('.step');
            const childContextBanner = $('#childContextBanner');
            const nextChildBtn = $('#nextChildBtn');
            const retakeBtn = $('#retakeBtn'); // Now "Back To Home"

            let visibleSteps = [];
            let idx = 0;
            let isSubmitting = false;
            let loadingIntervalId = null;
            const loadingPhrases = [
                'Finding the best program for your Ninja‚Ä¶',
                'Matching your Ninja‚Äôs strengths and goals‚Ä¶',
                'Reviewing your answers with our AI assistant‚Ä¶',
                'Preparing your personalized recommendation‚Ä¶'
            ];

            function startLoading() {
                wizard.classList.add('hidden');
                result.style.display = 'none';
                loadingSection.classList.remove('hidden');
                loadingTitle.textContent = t('Analyzing results‚Ä¶');
                loadingSub.textContent = t(loadingPhrases[0]);
                let i = 0;
                if (loadingIntervalId) clearInterval(loadingIntervalId);
                loadingIntervalId = setInterval(() => {
                    i = (i + 1) % loadingPhrases.length;
                    loadingSub.textContent = t(loadingPhrases[i]);
                }, 2200);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function stopLoading() {
                if (loadingIntervalId) {
                    clearInterval(loadingIntervalId);
                    loadingIntervalId = null;
                }
                loadingSection.classList.add('hidden');
            }

            function parseCondition(cond) {
                if (!cond) return null;
                const [name, values] = cond.split('=');
                if (!name || !values) return null;
                const allowed = values.split(',').map(v => v.trim());
                return { name: name.trim(), values: allowed };
            }

            function getValue(name) {
                if (name === 'age') return currentChildAge; // Use dynamic age

                const radios = $$('input[type=radio][name="' + name + '"]');
                if (radios.length) {
                    const checked = radios.find(r => r.checked);
                    return checked ? checked.value : '';
                }
                const checks = $$('input[type=checkbox][name="' + name + '"]:checked');
                if (checks.length) {
                    return checks.map(c => c.value);
                }
                return '';
            }

            // Helper to clear values for next child
            function clearFormValues() {
                // Select inputs inside wizard only
                const allInputs = $$('input, textarea, select', wizard);
                allInputs.forEach(inp => {
                    // SKIP marketing inputs so we persist attribution across children
                    if (inp.closest('.marketing-step')) return;

                    if (inp.type === 'radio' || inp.type === 'checkbox') inp.checked = false;
                    else inp.value = '';
                });
            }

            function conditionMatches(condStr) {
                if (!condStr) return true;
                // Support OR logic with '|'
                const subConditions = condStr.split('|').map(s => s.trim());
                return subConditions.some(sub => {
                    const c = parseCondition(sub);
                    if (!c) return true;
                    const val = getValue(c.name);
                    if (Array.isArray(val)) {
                        return val.some(v => c.values.includes(v));
                    }
                    return c.values.includes(val);
                });
            }

            function recomputeVisibleSteps() {
                visibleSteps = allSteps.filter(step => {
                    // Skip Q1 (Age) as it's pre-selected now
                    if (step.dataset.stepId === 'q1') return false;

                    // Logic to hide marketing questions for 2nd+ child
                    if (currentChildIndex > 0 && step.classList.contains('marketing-step')) return false;

                    const cond = step.getAttribute('data-show-if');
                    if (!cond) return true;

                    // Advanced logic override: If child is 8-13 but Advanced...
                    const t8 = getValue('tech8');
                    const t11 = getValue('tech11');
                    const isAdvancedChild = (t8 === 'Advanced' || t11 === 'Advanced');
                    const isActually14Plus = (currentChildAge === '14+');

                    // 1. HIDE standard path questions if they are now on the Advanced track
                    // These are questions specific to 8-10 or 11-13 that come AFTER the tech confidence question
                    // standard questions: q5B-1 (tried8), q5C-1 (leader11)
                    // note: q5B and q5C are where they select 'Advanced', so we must keep those visible.
                    if (isAdvancedChild && !isActually14Plus) {
                        if (['q5B-1', 'q5C-1'].includes(step.dataset.stepId)) return false;
                    }

                    // 2. For Advanced 8-13 year olds, ONLY show age-appropriate Academy questions
                    // Skip questions that say "teen" or are redundant
                    if (isAdvancedChild && !isActually14Plus) {
                        // q2D says "motivates your teen" - SKIP for younger kids
                        if (step.dataset.stepId === 'q2D') return false;
                        // q4D asks tech confidence again - SKIP (redundant, they already answered)
                        if (step.dataset.stepId === 'q4D') return false;
                        // q5D (growth area) - could work but let's skip to keep it simple
                        if (step.dataset.stepId === 'q5D') return false;
                        // q3D (interests) and q4D-1 (certifications) - SHOW these (age-appropriate)
                        if (['q3D', 'q4D-1'].includes(step.dataset.stepId)) {
                            return true;
                        }
                    }

                    return conditionMatches(cond);
                });
                allSteps.forEach(s => s.classList.remove('active'));
                if (idx >= visibleSteps.length) idx = visibleSteps.length - 1;
                if (idx < 0) idx = 0;
                updateUI();
            }

            function updateUI() {
                visibleSteps.forEach((s, i) => s.classList.toggle('active', i === idx));
                const total = visibleSteps.length || 1;
                qtotalSpan.textContent = total;
                qnum.textContent = idx + 1;
                bar.style.width = (idx / Math.max(total - 1, 1)) * 100 + '%';
                backBtn.disabled = idx === 0;

                const active = visibleSteps[idx];
                let disableNext = false;

                if (active) {
                    // Require at least one radio per group on this step
                    const radios = $$('input[type=radio]', active);
                    if (radios.length) {
                        const names = [...new Set(radios.map(r => r.name))];
                        names.forEach(name => {
                            const group = $$('input[type=radio][name="' + name + '"]', active);
                            if (group.length && !group.some(r => r.checked)) {
                                disableNext = true;
                            }
                        });
                    }

                    // NEW: Require at least one checkbox checked on any step that has checkboxes
                    const checkboxes = $$('input[type=checkbox]', active);
                    if (checkboxes.length) {
                        const checkedCount = checkboxes.filter(c => c.checked).length;
                        if (checkedCount === 0) {
                            disableNext = true;
                        }

                        // Strict check for q2A (Age 5-7 traits): Must choose exactly 2 responses
                        // "User cannot choose 1 response, but also cannot choose anything more than 3. In this case, they have to choose 2."
                        if (active.dataset.stepId === 'q2A') {
                            if (checkedCount !== 2) {
                                disableNext = true;
                            }
                        }
                    }
                }

                const currentName = (numChildren > 1 && childNames[currentChildIndex]) ? childNames[currentChildIndex].name : '';
                if (idx === visibleSteps.length - 1) {
                    nextBtn.textContent = currentName ? t("See Results for") + ` ${currentName} ‚ñ∂` : t('See Results ‚ñ∂');
                } else {
                    nextBtn.textContent = t('Next ‚ñ∂');
                }

                nextBtn.disabled = disableNext;
            }

            wizard.addEventListener('change', recomputeVisibleSteps);
            visibleSteps = allSteps; updateUI();

            // ---------- START QUIZ ----------
            startBtn.addEventListener('click', () => {
                syncStartState();
                if (!(parentFirst && parentLast && centerLocation)) return;

                prestart.classList.add('hidden');
                childSetup.classList.remove('hidden'); // Show child setup first
                // Force update incase default radio is checked
                updateChildInputs();
            });

            confirmChildrenBtn.addEventListener('click', () => {
                // This is the real start of the wizard
                childSetup.classList.add('hidden');
                wizard.classList.remove('hidden');

                currentChildIndex = 0;
                startChildQuiz();
            });

            function startChildQuiz() {
                idx = 0;
                clearFormValues();

                // Set current child data context
                const activeChild = childNames[currentChildIndex];
                currentChildAge = activeChild.age;

                // Show context banner if multi-child
                if (numChildren > 1) {
                    childContextBanner.textContent = `Questionnaire for ${activeChild.name}`;
                    childContextBanner.classList.remove('hidden');
                    $('#genderLegend').textContent = `${activeChild.name} is a...`;
                } else {
                    childContextBanner.classList.add('hidden');
                    $('#genderLegend').textContent = `My child is a...`;
                }

                recomputeVisibleSteps();
                updateUI();
            }

            // ---------- NAV ----------
            backBtn.addEventListener('click', () => {
                if (isSubmitting) return;
                if (idx > 0) { idx--; updateUI(); }
            });

            nextBtn.addEventListener('click', async () => {
                if (isSubmitting) return;

                if (idx < visibleSteps.length - 1) {
                    idx++;
                    updateUI();
                } else {
                    isSubmitting = true;
                    startLoading();
                    try {
                        await computeResultsAndSubmit();
                    } finally {
                        isSubmitting = false;
                    }
                }
            });

            // ---------- MULTI-CHILD LOGIC ----------
            nextChildBtn.addEventListener('click', () => {
                // Go to next child
                currentChildIndex++;
                if (currentChildIndex < numChildren) {
                    result.style.display = 'none';
                    wizard.classList.remove('hidden');
                    startChildQuiz();
                }
            });

            // ---------- LABEL HELPERS ----------
            function radioLabel(name) {
                const el = document.querySelector('input[name="' + name + '"]:checked');
                if (!el) return '';
                const lab = el.closest('label');
                return lab ? lab.textContent.trim() : el.value;
            }
            function checkboxLabels(name) {
                return Array.from(document.querySelectorAll('input[name="' + name + '"]:checked')).map(el => {
                    const lab = el.closest('label');
                    return lab ? lab.textContent.trim() : el.value;
                });
            }
            function textValue(name) {
                const input = document.querySelector('[name="' + name + '"]');
                if (!input) return '';
                return (input.value || '').trim();
            }
            function getLegendForInputName(name) {
                const input = document.querySelector('[name="' + name + '"]');
                if (!input) return '';
                const fs = input.closest('fieldset');
                if (!fs) return '';
                const legend = fs.querySelector('legend');
                if (!legend) return '';
                const clone = legend.cloneNode(true);
                clone.querySelectorAll('span').forEach(s => s.remove());
                return clone.textContent.trim();
            }

            // ---------- PROGRAM SELECTION ----------
            function baseProgramKey(age) {
                // NEW: Check for advanced status to recommend ACADEMY even for 8-13
                const tech8 = getValue('tech8');
                const tech11 = getValue('tech11');

                if (age === '5-7') return 'JR';
                if (age === '14+') return 'ACADEMY';

                // If 8-13 but Advanced, push to ACADEMY logic (which may offer bundles or academy track)
                if ((age === '8-10' && tech8 === 'Advanced') || (age === '11-13' && tech11 === 'Advanced')) {
                    return 'ACADEMY';
                }

                if (age === '8-10' || age === '11-13') return 'CREATE';
                return 'CREATE';
            }

            function chooseCreateBundle() {
                const future = getValue('futurefocus');
                const goals = checkboxLabels('goals');
                const tech8 = getValue('tech8');
                const tech11 = getValue('tech11');

                if (future === 'All three') {
                    return { label: '1+1+1 Bundle', type: '1+1+1' };
                }
                if (future === 'Coding + AI') {
                    return { label: '1+1 Bundle (CREATE + AI Academy)', type: '1+1_AI' };
                }
                if (future === 'Coding + Robotics') {
                    return { label: '1+1 Bundle (CREATE + Robotics Academy)', type: '1+1_Robotics' };
                }
                if (future === 'Coding core') {
                    return { label: '2x/Week', type: '2x' };
                }
                if (future === 'Not sure') {
                    if (goals.includes('Future skills') || tech8 === 'Advanced' || tech11 === 'Advanced') {
                        return { label: '1+1 Bundle (CREATE + AI Academy)', type: '1+1_AI' };
                    }
                    return { label: '2x/Week', type: '2x' };
                }
                if (goals.includes('Future skills') || tech8 === 'Advanced' || tech11 === 'Advanced') {
                    return { label: '1+1 Bundle (CREATE + AI Academy)', type: '1+1_AI' };
                }
                return { label: '2x/Week', type: '2x' };
            }

            // Persona determination logic based on updated requirements
            function determinePersona() {
                const age = getValue('age');
                const tech8 = getValue('tech8');
                const tech11 = getValue('tech11');
                const tech14 = getValue('tech14');
                const learn8 = getValue('learn8');
                const school11 = getValue('school11');
                const interest14 = checkboxLabels('interest14');
                const traits8 = checkboxLabels('traits8');
                const traits11 = checkboxLabels('traits11');
                const traits5 = checkboxLabels('traits5');
                const play5 = checkboxLabels('play5'); // Changed to checkboxes in prev step
                const grit5 = getValue('grit5');
                const challenge11 = getValue('challenge11');
                const tried8 = checkboxLabels('tried8'); // Changed to checkboxes
                const goals = checkboxLabels('goals');
                const interestMentor = interest14.includes('Mentor');

                const matches = [];

                // 1. Digital Explorer
                if (tech8 === 'Advanced' || tech11 === 'Advanced' || tech14 === 'Advanced') {
                    // Add logic to show 14+ questions if they haven't been seen yet
                    // NOTE: The UI logic (recomputeVisibleSteps) handles showing the questions.
                    // This logic is just for Persona selection.

                    matches.push({
                        title: t("The Digital Explorer"),
                        blurb: t("Your child is self-driven and needs accelerated, complex content. The CREATE belt system allows them to progress at their pace, and our Academies offer the advanced topics (like AI and real code) they crave.")
                    });
                }

                // 2. Structured Learner
                if (learn8.includes('Step-by-step') || school11.includes('Motivated')) {
                    matches.push({
                        title: t("The Structured Learner"),
                        blurb: t("They excel with clear goals and defined milestones. The CREATE belt system, with its clear curriculum path and defined Belts, perfectly matches their need for order and measurable progress.")
                    });
                }

                // 3. Hands-On Engineer
                if (interest14.includes('Robotics') || traits11.includes('Analytical') || (age === '8-10' && learn8.includes('Hands-on'))) {
                    matches.push({
                        title: t("The Hands-On Engineer"),
                        blurb: t("This child connects best with physical outcomes. They're an excellent candidate for the Robotics Academy bundle, blending coding logic with tangible engineering projects.")
                    });
                }

                // 4. Game Designer
                if (interest14.includes('Game dev') || tried8.includes('Roblox/Minecraft')) {
                    matches.push({
                        title: t("The Game Designer"),
                        blurb: t("Their passion is creation through play. The CREATE belt system, which is fundamentally structured around building and publishing video games, harnesses this core interest immediately.")
                    });
                }

                // 5. Debugging Master
                if (grit5 === 'Keeps trying' || challenge11 === 'Persist' || challenge11 === 'Research') {
                    matches.push({
                        title: t("The Debugging Master"),
                        blurb: t("This child has the grit and resilience necessary to overcome complex coding challenges. They will thrive in the self-paced CREATE dojo, where errors are viewed as learning opportunities.")
                    });
                }

                // 6. Collaborative Coder
                if (traits8.includes('Social') || traits11.includes('Team-player') || interestMentor) {
                    matches.push({
                        title: t("The Collaborative Coder"),
                        blurb: t("They're motivated by peer interaction. The open dojo setting and group collaboration opportunities (Clubs, ACADEMY) fuel their desire to work with others while learning to code.")
                    });
                }

                // 7. Digital Innovator
                if (goals.includes('Future skills') || tech8 === 'Advanced' || tech11 === 'Advanced' || tech14 === 'Advanced') {
                    matches.push({
                        title: t("The Digital Innovator"),
                        blurb: t("This profile is seeking cutting-edge knowledge. They are a prime fit for CREATE Bundles (AI Academy) or the ACADEMY track, focusing on modern tools and career readiness.")
                    });
                }

                // 8. The Storyteller
                if (age === '5-7' && play5.includes('Imaginative')) {
                    matches.push({
                        title: t("The Storyteller"),
                        blurb: t("This child responds best to narrative learning. The JR program uses story-driven, hands-on activities to introduce the logic and sequencing required for early coding concepts.")
                    });
                }

                // 9. Hands-On Architect
                if (age === '5-7' && play5.includes('Building')) {
                    matches.push({
                        title: t("The Hands-On Architect"),
                        blurb: t("This child understands physical structure and assembly. The JR program uses tactile, hands-on materials to build sequences, leveraging their existing strength in 3D construction to teach abstract logic.")
                    });
                }

                // 10. Curious Novice
                if (age === '5-7' || tech8 === 'Beginner' || tech11 === 'Beginner' || tech14 === 'Beginner') {
                    matches.push({
                        title: t("The Curious Novice"),
                        blurb: t("This profile needs a gentle, low-pressure introduction to technology. The program must prioritize confidence-building and foundational concepts over complex skills initially.")
                    });
                }

                if (matches.length > 0) {
                    return matches[0]; // Return the first match found (priority order)
                }

                // Defaults (Randomized if no match)
                const defaults = [
                    {
                        title: t("The Code Ninja in Training"),
                        blurb: t("Your child shows a balanced mix of curiosity and potential. Our program adapts to their pace, helping them discover their specific passions‚Äîwhether that‚Äôs building games, controlling robots, or writing code.")
                    },
                    {
                        title: t("The Future Tech Leader"),
                        blurb: t("With a solid foundation and the right guidance, your child is ready to step into the world of technology. We focus on building not just coding skills, but the confidence and logic they need for the future.")
                    },
                    {
                        title: t("The Creative Thinker"),
                        blurb: t("Your child approaches problems with a unique perspective. Our creative curriculum allows them to express that imagination through digital building, turning their ideas into playable reality.")
                    }
                ];

                return defaults[Math.floor(Math.random() * defaults.length)];
            }

            function buildProgramUI(age) {
                const key = baseProgramKey(age);

                if (key === 'JR') {
                    return {
                        uiTitle: t('Recommended Program') + ': Code Ninjas JR',
                        uiBlurb: t('Playful, story-driven sessions where young Ninjas (5‚Äì7) explore early coding, logic, and creativity with tons of encouragement.'),
                        bullets: [
                            t('Gentle, game-based introduction to core concepts'),
                            t('Hands-on projects that feel like play, not like school'),
                            t('Builds early confidence, focus, and curiosity')
                        ],
                        stats: [
                            ['5‚Äì7', t('Ideal ages')],
                            [t('Play-based'), t('Learning style')],
                            [t('2‚Äì3 hrs / week'), t('Recommended time')],
                            [t('Small groups'), t('Mentor support')],
                            [t('Early logic'), t('Patterns & sequencing')],
                            [t('Fun & safe'), t('Dojo environment')]
                        ],
                        apiProgram: 'Code Ninjas JR',
                        bundleType: null
                    };
                }

                if (key === 'ACADEMY') {
                    return {
                        uiTitle: t('Recommended Program') + ': ' + t('CREATE 1+1 Bundle'),
                        uiBlurb: t('A deeper track for motivated ninjas ready for real-world coding + AI or Engineering projects. Combines Code Ninjas CREATE (core coding) with an Academy of their choice.'),
                        bullets: [
                            t('Project-based learning in coding, AI, or robotics'),
                            t('Core belt progression + specialized Academy track'),
                            t('A community of like-minded, driven Ninjas')
                        ],
                        stats: [
                            [t('Advanced'), t('Challenge level')],
                            [t('2‚Äì3 hrs / week'), t('Recommended time')],
                            [t('Real projects'), t('Portfolio-ready')],
                            [t('Mentorship'), t('Guided growth')],
                            [t('Future-focused'), t('College & career skills')]
                        ],
                        apiProgram: 'Code Ninjas Academy',
                        bundleType: '1+1_Academy' // Mark as generic bundle for AI prompt
                    };
                }

                // CREATE with bundles
                const bundle = chooseCreateBundle();

                let stats = [
                    ['8‚Äì13', t('Ideal ages')],
                    [t('Belt system'), t('Built-in motivation')],
                    [t('3‚Äì4 hrs / week'), t('Recommended time')],
                    [t('Game creation'), t('High engagement')],
                    [t('Future skills'), t('Coding & logic')],
                    [t('Mentor support'), t('Guided progress')]
                ];

                let variantLine = '';
                let bulletsExtra = [];

                if (bundle.type === '2x') {
                    variantLine = ' ' + t('Code Ninjas CREATE') + ' (' + t('2x/Week') + ')';
                    stats[2] = [t('3‚Äì4 hrs / week'), t('Recommended time')];
                    bulletsExtra = [
                        t('Two focused CREATE sessions each week for consistent progress'),
                        t('Locked in on coding fundamentals‚Äîno additional academies or clubs'),
                        t('Perfect when you want depth and mastery in one powerful track')
                    ];
                } else if (bundle.type === '1+1_AI') {
                    variantLine = ' ' + t('CREATE 1+1 Bundle');
                    stats[2] = [t('2‚Äì3 hrs / week'), t('Recommended time')];
                    bulletsExtra = [
                        t('One CREATE session + one AI Academy session each week'),
                        t('Blend core coding with age-appropriate AI concepts and tools'),
                        t('Great for future-facing Ninjas curious about smart technology')
                    ];
                } else if (bundle.type === '1+1_Robotics') {
                    variantLine = ' ' + t('Code Ninjas CREATE') + ' (' + t('1+1 Bundle: CREATE + Robotics Academy') + ')';
                    stats[2] = [t('2‚Äì3 hrs / week'), t('Recommended time')];
                    bulletsExtra = [
                        t('One CREATE session + one Robotics Academy session each week'),
                        t('Turn code into motion with engineering challenges and builds'),
                        t('Ideal for hands-on builders who love to see things move')
                    ];
                } else if (bundle.type === '1+1+1') {
                    variantLine = ' ' + t('Code Ninjas CREATE') + ' (' + t('1+1+1 Bundle: Coding + Academies + Clubs') + ')';
                    stats[2] = [t('3‚Äì4 hrs / week'), t('Recommended time')];
                    const baseThree = [
                        t('Structured path from block coding into real languages'),
                        t('Mentor-led dojo that feels fun, not like more school'),
                        t('Builds confidence, focus, and perseverance through challenges')
                    ];
                    const extraForTriple = [
                        t('Coding'),
                        t('Rotating AI and Robotics Academy experiences across the year'),
                        t('Clubs/community add variety and momentum for hungry learners')
                    ];
                    return {
                        uiTitle: t('Recommended Program') + ':' + variantLine,
                        uiBlurb: t('Your Ninja is ready for our CREATE Dojo‚Äîwhere they build real games, sharpen problem-solving, and level up through our belt system in a space that feels like home.'),
                        bullets: [...baseThree, ...extraForTriple],
                        stats,
                        apiProgram: 'Code Ninjas CREATE',
                        bundleType: bundle.type
                    };
                }

                return {
                    uiTitle: t('Recommended Program') + ':' + variantLine,
                    uiBlurb: t('Your Ninja is ready for our CREATE Dojo‚Äîwhere they build real games, sharpen problem-solving, and level up through our belt system in a space that feels like home.'),
                    bullets: [
                        t('Structured path from block coding into real languages'),
                        t('Mentor-led dojo that feels fun, not like more school'),
                        t('Builds confidence, focus, and perseverance through challenges'),
                        ...bulletsExtra
                    ],
                    stats,
                    apiProgram: 'Code Ninjas CREATE',
                    bundleType: bundle.type
                };
            }

            // ---------- FUN FACT ----------
            function funFactText(programKey, signals, bundleType) {
                // Prioritize bundle type for fun fact consistency
                if (bundleType === '1+1_AI') {
                    return t('Students who engage early with coding and AI concepts gain confidence navigating technologies that are shaping the fastest-growing careers.');
                }
                if (bundleType === '1+1_Robotics') {
                    return t('Building and programming robots helps kids connect coding to the real world, which research links to higher engagement in STEM over time.');
                }

                const txt = signals.join(' ').toLowerCase();
                if (/game|roblox|minecraft/.test(txt)) {
                    return t('Designing and coding their own games strengthens logic, creativity, and persistence‚Äîthe same problem-solving muscles used by professional developers.');
                }
                if (/robot/.test(txt)) {
                    return t('Building and programming robots helps kids connect coding to the real world, which research links to higher engagement in STEM over time.');
                }
                if (programKey === 'ACADEMY' || /ai\b/.test(txt)) {
                    return t('Students who engage early with coding and AI concepts gain confidence navigating technologies that are shaping the fastest-growing careers.');
                }
                return t('Learning to code builds problem-solving, creativity, and resilience‚Äîskills that support success in math, science, writing, and beyond.');
            }

            // ---------- Q&A SUMMARY ----------
            function buildQASummary() {
                const fields = [
                    ['gender', 'radio'], // Add Gender to summary
                    ['age', 'radio'], // This will now fetch pre-set age
                    ['traits5', 'checkbox'], ['play5', 'checkbox'], ['grit5', 'radio'],
                    ['traits8', 'checkbox'], ['learn8', 'checkbox'], ['school8', 'checkbox'], ['reengage8', 'radio'], ['tech8', 'radio'], ['tried8', 'checkbox'],
                    ['traits11', 'checkbox'], ['challenge11', 'radio'], ['school11', 'checkbox'], ['enjoy11', 'checkbox'], ['tech11', 'radio'], ['leader11', 'radio'],
                    ['motivate14', 'radio'], ['interest14', 'checkbox'], ['tech14', 'radio'], ['career14', 'radio'], ['growth14', 'radio'],
                    ['goals', 'checkbox'], ['futurefocus', 'radio'], ['ai', 'radio'],
                    ['hearAbout', 'radio'],
                    ['hearFriendShare', 'checkbox'],
                    ['friendName', 'text'],
                    ['schoolShare', 'checkbox'],
                    ['schoolNameInput', 'text'],
                    ['teacherNameInput', 'text'],
                    ['socialPlatform', 'radio'],
                    ['searchTopics', 'checkbox'],
                    ['searchClickWhy', 'checkbox'],
                    ['searchOtherDetails', 'text'],
                    ['clickOtherDetails', 'text'],
                    ['eventDetails', 'text'],
                    ['otherDetails', 'text']
                ];
                const lines = [];
                fields.forEach(([name, type]) => {
                    // Special handling for text inputs without legends, or custom label display
                    if (type === 'text') {
                        const val = textValue(name);
                        if (val) {
                            // Map ID to readable label
                            let label = name;
                            if (name === 'friendName') label = 'Friend/Parent Name';
                            else if (name === 'schoolNameInput') label = 'School Name';
                            else if (name === 'teacherNameInput') label = 'Teacher Name';
                            else if (name === 'eventDetails') label = 'Event/Location';
                            else if (name === 'otherDetails') label = 'Other Details';
                            else if (name === 'searchOtherDetails') label = 'Search Other Details';
                            else if (name === 'clickOtherDetails') label = 'Click Reason Other Details';
                            lines.push(`${label} ‚Üí ${val}`);
                        }
                        return;
                    }

                    // AGE SPECIAL HANDLING: If age question was skipped in wizard, we still need to log it
                    if (name === 'age') {
                        if (currentChildAge) {
                            lines.push(`Age Group ‚Üí ${currentChildAge}`);
                        }
                        return;
                    }

                    const legend = getLegendForInputName(name);
                    if (!legend) return;
                    let ans = '';
                    if (type === 'radio') {
                        ans = radioLabel(name);
                    } else if (type === 'checkbox') {
                        ans = checkboxLabels(name).join(', ');
                    }
                    if (ans) lines.push(legend + ' ‚Üí ' + ans);
                });
                return lines;
            }

            // ---------- API SUBMIT ----------
            function submitToWeb3Forms(message) {
                if (window.API_Access === false) { console.log('API submission skipped'); return; }

                const form = $('#web3Form');
                const msgField = $('#wf_message');
                const subjField = $('#wf_subject');
                const nameField = $('#wf_name');
                // wf_email is set in HTML with a dummy value since user removed input

                if (!form || !msgField || !subjField || !nameField) return;

                subjField.value = `New Ninja Path Finder Lead - ${centerLocation}`;
                nameField.value = `${parentFirst} ${parentLast}`.trim();
                msgField.value = message;

                // Submit via standard form POST to hidden iframe to bypass CORS on file://
                form.submit();
                console.log('Web3Forms submission triggered via hidden frame');
            }

            // ---------- MONDAY.COM SUBMIT (No Names) ----------
            async function submitToMonday(data) {
                if (!MONDAY_ENABLED || window.API_Access === false) {
                    console.log('Monday.com submission skipped');
                    return;
                }

                if (!MONDAY_API_KEY || !MONDAY_BOARD_ID) {
                    console.warn('Monday.com credentials not configured');
                    return;
                }

                try {
                    // Parse Q&A summary to extract individual answers
                    const parseQA = (qaSummary) => {
                        const parsed = {};
                        qaSummary.forEach(line => {
                            const parts = line.split(' ‚Üí ');
                            if (parts.length >= 2) {
                                const question = parts[0].trim();
                                const answer = parts.slice(1).join(' ‚Üí ').trim();
                                parsed[question] = answer;
                            }
                        });
                        return parsed;
                    };

                    const qaData = parseQA(data.qaSummary);

                    // Build column values object for Monday.com
                    const columnValues = {};

                    // Basic Info
                    columnValues[MONDAY_COLUMN_MAP['Location']] = data.centerLocation || '';

                    // Date format for Monday.com: JSON object { date: "YYYY-MM-DD" }
                    const dateValue = new Date().toISOString().split('T')[0];
                    columnValues[MONDAY_COLUMN_MAP['Submitted Date']] = { date: dateValue };

                    // FIXED: Numeric columns in Monday.com expect a simple string value, NOT an object
                    columnValues[MONDAY_COLUMN_MAP['Number of Children']] = String(data.numChildren || 1);

                    // Program & Persona
                    columnValues[MONDAY_COLUMN_MAP['Recommended Program']] = data.programDisplay || '';
                    columnValues[MONDAY_COLUMN_MAP['Persona']] = data.persona || '';
                    columnValues[MONDAY_COLUMN_MAP['Persona Description']] = data.personaBlurb || '';

                    // Child Demographics (no names)
                    columnValues[MONDAY_COLUMN_MAP['Child Age Group']] = qaData['Age Group'] || '';
                    columnValues[MONDAY_COLUMN_MAP['Child Gender']] = qaData['My child is a...'] || '';

                    // Age-specific answers (5-7)
                    columnValues[MONDAY_COLUMN_MAP['Traits (5-7)']] = qaData['Which of these best describe your child?'] || '';
                    columnValues[MONDAY_COLUMN_MAP['Play Preferences (5-7)']] = qaData['What kind of play do they enjoy most?'] || '';
                    columnValues[MONDAY_COLUMN_MAP['Persistence (5-7)']] = qaData['When something doesn\'t work right away, they usually‚Ä¶'] || '';

                    // Age-specific answers (8-10)
                    columnValues[MONDAY_COLUMN_MAP['Traits (8-10)']] = qaData['Which traits best describe your child?'] || '';
                    columnValues[MONDAY_COLUMN_MAP['Learning Style (8-10)']] = qaData['How does your child learn best?'] || '';
                    columnValues[MONDAY_COLUMN_MAP['School Attitude (8-10)']] = qaData['How do they feel about school and learning?'] || '';
                    columnValues[MONDAY_COLUMN_MAP['Re-engagement Method (8-10)']] = qaData['What usually helps them re-engage?'] || '';
                    columnValues[MONDAY_COLUMN_MAP['Tech Confidence (8-10)']] = qaData['How confident are they with technology?'] || '';
                    columnValues[MONDAY_COLUMN_MAP['Tech Experience (8-10)']] = qaData['What have they tried so far?'] || '';

                    // Age-specific answers (11-13)
                    columnValues[MONDAY_COLUMN_MAP['Traits (11-13)']] = qaData['Which traits best describe your child?'] || '';
                    columnValues[MONDAY_COLUMN_MAP['Challenge Response (11-13)']] = qaData['When faced with a challenge, they usually‚Ä¶'] || '';
                    columnValues[MONDAY_COLUMN_MAP['School Attitude (11-13)']] = qaData['How do they feel about school?'] || '';
                    columnValues[MONDAY_COLUMN_MAP['Enjoyment Factors (11-13)']] = qaData['What would help them enjoy learning more?'] || '';
                    columnValues[MONDAY_COLUMN_MAP['Tech Confidence (11-13)']] = qaData['How comfortable are they with technology?'] || '';
                    columnValues[MONDAY_COLUMN_MAP['Leadership Interest (11-13)']] = qaData['Would they enjoy helping others or leading projects?'] || '';

                    // Age-specific answers (14+)
                    columnValues[MONDAY_COLUMN_MAP['Motivation (14+)']] = qaData['What best describes what motivates your teen?'] || '';
                    columnValues[MONDAY_COLUMN_MAP['Interests (14+)']] = qaData['Which areas are they most interested in?'] || '';
                    columnValues[MONDAY_COLUMN_MAP['Tech Confidence (14+)']] = qaData['How confident are they with technology?'] || '';
                    columnValues[MONDAY_COLUMN_MAP['Career Interest (14+)']] = qaData['Are they interested in tech certifications or careers?'] || '';
                    columnValues[MONDAY_COLUMN_MAP['Growth Area (14+)']] = qaData['Which growth area is most important this year?'] || '';

                    // Goals & Future
                    columnValues[MONDAY_COLUMN_MAP['Parent Goals']] = qaData['What are you hoping your child gains from Code Ninjas?'] || '';
                    columnValues[MONDAY_COLUMN_MAP['Future Focus']] = qaData['What future skill matters most to you for your child right now?'] || '';
                    columnValues[MONDAY_COLUMN_MAP['AI Interest']] = qaData['AI Interest'] || '';

                    // Marketing
                    columnValues[MONDAY_COLUMN_MAP['Marketing Source']] = data.marketingSource || 'N/A';
                    columnValues[MONDAY_COLUMN_MAP['Marketing Details']] = data.marketingSubsource || '';

                    // Full Summary (email and SMS columns removed as requested)
                    columnValues[MONDAY_COLUMN_MAP['Full Q&A Summary']] = data.qaSummary.join('\n') || '';

                    // Convert to Monday.com format
                    const columnValuesString = JSON.stringify(columnValues);

                    // Create item with anonymous identifier (no names)
                    const itemName = `Lead - ${data.centerLocation} - ${new Date().toLocaleDateString()}`;

                    // Build mutation - escape properly for GraphQL string
                    const escapedItemName = itemName.replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/\n/g, '\\n');
                    const escapedColumnValues = columnValuesString.replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/\n/g, '\\n');

                    const mutation = `mutation {
        create_item(
          board_id: ${MONDAY_BOARD_ID},
          item_name: "${escapedItemName}",
          column_values: "${escapedColumnValues}"
        ) {
          id
        }
      }`;

                    const response = await fetch('https://api.monday.com/v2', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': MONDAY_API_KEY
                        },
                        body: JSON.stringify({ query: mutation })
                    });

                    const result = await response.json();

                    if (result.errors) {
                        console.error('‚ùå Monday.com API errors:', result.errors);
                        result.errors.forEach((error, idx) => {
                            console.error(`Error ${idx + 1}:`, error.message || error);
                        });
                    } else if (result.data && result.data.create_item) {
                        console.log('‚úÖ Monday.com submission successful!');
                    } else {
                        console.warn('‚ö†Ô∏è Unexpected Monday.com response:', JSON.stringify(result, null, 2));
                    }
                } catch (e) {
                    console.error('Monday.com submission error:', e);
                }
            }

            // Helper to determine Academy bundle type (AI vs Robotics) based on interests
            function determineAcademyBundleType() {
                const interest14 = checkboxLabels('interest14');
                const future = getValue('futurefocus');

                // Check explicit interests
                if (interest14.includes('Robotics')) return 'Robotics';
                if (interest14.includes('AI')) return 'AI';

                // Check future focus preference
                if (future === 'Coding + Robotics') return 'Robotics';
                if (future === 'Coding + AI') return 'AI';

                // Default to AI if no clear preference
                return 'AI';
            }

            // ---------- MAIN RESULTS ----------
            async function computeResultsAndSubmit() {
                const ageVal = getValue('age') || '';
                const gender = getValue('gender') || '';
                const baseKey = baseProgramKey(ageVal);
                const programUI = buildProgramUI(ageVal);
                let bundleType = programUI.bundleType || (baseKey === 'CREATE' ? (chooseCreateBundle().type) : null);

                // If Academy path, determine if it should be AI or Robotics bundle
                let academyBundleType = null;
                if (baseKey === 'ACADEMY') {
                    if (bundleType === '1+1_Academy' || !bundleType) {
                        // Determine specific type (AI or Robotics) based on interests
                        academyBundleType = determineAcademyBundleType();
                        bundleType = academyBundleType === 'Robotics' ? '1+1_Robotics' : '1+1_AI';
                    } else if (bundleType === '1+1_AI') {
                        academyBundleType = 'AI';
                    } else if (bundleType === '1+1_Robotics') {
                        academyBundleType = 'Robotics';
                    }
                }

                // Use new Persona Logic
                const personaData = determinePersona();
                const persona = personaData.title;
                const personaBlurb = personaData.blurb;

                const allTraits = []
                    .concat(checkboxLabels('traits5'))
                    .concat(checkboxLabels('traits8'))
                    .concat(checkboxLabels('traits11'))
                    .concat(checkboxLabels('interest14'));

                const goals = checkboxLabels('goals');

                // Marketing attribution
                const hearCode = getValue('hearAbout');
                let marketingSource = '';
                let marketingSubsource = '';
                const hearLabel = radioLabel('hearAbout');

                if (hearCode) {
                    switch (hearCode) {
                        case 'Friend': {
                            marketingSource = 'Friend / Parent Referral';
                            const fName = textValue('friendName');
                            marketingSubsource = [
                                `Primary source: ${hearLabel}`,
                                fName ? `Referred by: ${fName}` : ''
                            ].filter(Boolean).join('\n');
                            break;
                        }
                        case 'School': {
                            marketingSource = 'School / Teacher';
                            const schoolShare = checkboxLabels('schoolShare');
                            const sName = textValue('schoolNameInput');
                            const tName = textValue('teacherNameInput');
                            marketingSubsource = [
                                `Primary source: ${hearLabel}`,
                                sName ? `School: ${sName}` : '',
                                tName ? `Teacher: ${tName}` : '',
                                schoolShare.length ? `How school shared: ${schoolShare.join(', ')}` : ''
                            ].filter(Boolean).join('\n');
                            break;
                        }
                        case 'Social': {
                            marketingSource = 'Social Media';
                            const socialPlatform = radioLabel('socialPlatform');
                            marketingSubsource = [
                                `Primary source: ${hearLabel}`,
                                socialPlatform ? `Platform: ${socialPlatform}` : ''
                            ].filter(Boolean).join('\n');
                            break;
                        }
                        case 'Search': {
                            marketingSource = 'Google / Online Search';
                            const searchTopics = checkboxLabels('searchTopics');
                            const clickReasons = checkboxLabels('searchClickWhy');
                            const searchOther = textValue('searchOtherDetails');
                            const clickOther = textValue('clickOtherDetails');

                            marketingSubsource = [
                                `Primary source: ${hearLabel}`,
                                searchTopics.length ? `What they were searching for: ${searchTopics.join(', ')}` : '',
                                searchOther ? `Search Other: ${searchOther}` : '',
                                clickReasons.length ? `What made them click: ${clickReasons.join(', ')}` : '',
                                clickOther ? `Click Other: ${clickOther}` : ''
                            ].filter(Boolean).join('\n');
                            break;
                        }
                        case 'Event': {
                            marketingSource = 'Event / Fair / Camp';
                            const evt = textValue('eventDetails');
                            marketingSubsource = [
                                `Primary source: ${hearLabel}`,
                                evt ? `Event/Loc: ${evt}` : ''
                            ].filter(Boolean).join('\n');
                            break;
                        }
                        case 'Returning': {
                            marketingSource = 'Returning Family';
                            marketingSubsource = `Primary source: ${hearLabel}`;
                            break;
                        }
                        case 'Other': {
                            marketingSource = 'Other';
                            const oth = textValue('otherDetails');
                            marketingSubsource = [
                                `Primary source: ${hearLabel}`,
                                oth ? `Details: ${oth}` : ''
                            ].filter(Boolean).join('\n');
                            break;
                        }
                    }
                }

                // UI
                // For single child, we need to grab the name from the input if it wasn't captured in childNames array yet
                let currentChildName = "Your Child";
                if (numChildren > 1 && childNames[currentChildIndex]) {
                    currentChildName = childNames[currentChildIndex].name;
                } else if (numChildren === 1) {
                    // Try to get from childNames first
                    if (childNames[0] && childNames[0].name) {
                        currentChildName = childNames[0].name;
                    } else {
                        // Fallback to reading the input directly if childNames wasn't populated (should be by validateChildSetup)
                        const nameInput = document.querySelector('input[data-type="name"][data-index="0"]');
                        if (nameInput && nameInput.value.trim()) {
                            currentChildName = nameInput.value.trim();
                        }
                    }
                }


                let titlePattern = t("{name}'s Profile: {persona}");
                $('#personaTitle').textContent = titlePattern.replace("{name}", currentChildName).replace("{persona}", persona);
                $('#personaBlurb').textContent = personaBlurb;

                // Bundle-aware program display - determine types first
                const apiProgramName = programUI.apiProgram;
                let finalAcademyType = academyBundleType;
                if (apiProgramName === 'Code Ninjas Academy') {
                    // Use the determined type, or default to AI
                    finalAcademyType = academyBundleType || 'AI';
                } else if (apiProgramName === 'Code Ninjas CREATE') {
                    if (bundleType === '1+1_AI') {
                        finalAcademyType = 'AI';
                    } else if (bundleType === '1+1_Robotics') {
                        finalAcademyType = 'Robotics';
                    }
                }

                // Update program title to include bundle type if applicable
                let displayTitle = programUI.uiTitle;
                if (apiProgramName === 'Code Ninjas Academy') {
                    displayTitle = finalAcademyType === 'Robotics' ? t('Recommended Program') + ': ' + t('CREATE 1+1 Bundle') + ' (' + t('Robotics') + ')' : t('Recommended Program') + ': ' + t('CREATE 1+1 Bundle') + ' (' + t('AI') + ')';
                } else if (apiProgramName === 'Code Ninjas CREATE' && (bundleType === '1+1_AI' || bundleType === '1+1_Robotics')) {
                    displayTitle = bundleType === '1+1_Robotics' ? t('Recommended Program') + ': ' + t('CREATE 1+1 Bundle') + ' (' + t('Robotics') + ')' : t('Recommended Program') + ': ' + t('CREATE 1+1 Bundle') + ' (' + t('AI') + ')';
                }

                $('#recTitle').textContent = displayTitle;
                $('#recBlurb').textContent = programUI.uiBlurb;
                $('#recPoints').innerHTML = programUI.bullets.map(b => `<li>${b}</li>`).join('');

                $('#stats').innerHTML = programUI.stats.map(([v, l]) => `<div class="stat"><h3>${v}</h3><p>${l}</p></div>`).join('');

                // Fun fact (only for on-screen)
                const signals = [].concat(allTraits, goals, [
                    checkboxLabels('play5').join(' '), checkboxLabels('tried8').join(' '), radioLabel('futurefocus'), radioLabel('ai')
                ].filter(Boolean));
                const funFact = funFactText(baseKey, signals, bundleType);

                if (funFact) {
                    $('#funFactText').textContent = funFact;
                    $('#funFact').classList.remove('hidden');
                } else {
                    $('#funFact').classList.add('hidden');
                }

                // Center note - updated text and styling
                $('#centerNote').textContent = t('Before you head out today, stop by the front desk so we can walk you through this path and help you enroll.');
                $('#centerNote').style.fontWeight = 'bold';
                $('#centerNote').classList.remove('hint'); // Remove hint styling

                // Bundle-aware program display for email/SMS
                let programDisplay = apiProgramName;
                if (apiProgramName === 'Code Ninjas Academy') {
                    programDisplay = finalAcademyType === 'Robotics' ? 'CREATE 1+1 (Robotics) Bundle' : 'CREATE 1+1 (AI) Bundle';
                } else if (apiProgramName === 'Code Ninjas CREATE') {
                    if (bundleType === '1+1_AI') {
                        programDisplay = 'CREATE 1+1 (AI) Bundle';
                    } else if (bundleType === '1+1_Robotics') {
                        programDisplay = 'CREATE 1+1 (Robotics) Bundle';
                    } else if (bundleType === '1+1+1') programDisplay += ' (1+1+1 Bundle: Coding + Academies + Clubs)';
                    else if (bundleType === '2x') programDisplay += ' (2x/Week)';
                }

                // Build Q&A summary once
                const qaSummary = buildQASummary();

                // Prepare AI-generated email + SMS (short, child-first)
                let emailBody = '';
                let smsOptions = [];
                let cdTools = '';
                try {
                    const comms = await generateAiComms({
                        programDisplay,
                        apiProgramName,
                        personaLabel: persona,
                        funFact,
                        bundleType,
                        academyBundleType: finalAcademyType, // Pass the specific type (AI or Robotics)
                        marketingSource,
                        marketingSubsource,
                        qaSummaryLines: qaSummary,
                        currentChildName: currentChildName, // Always pass the name
                        gender: gender // Pass gender to AI
                    });
                    if (comms) {
                        emailBody = comms.email;
                        smsOptions = comms.sms;
                        cdTools = comms.cdTools;
                    }
                } catch (e) {
                    console.warn("Error while generating AI comms:", e);
                }

                // Fallback if Gemini fails
                if (!emailBody || smsOptions.length === 0) {
                    const fallback = buildFallbackComms(programDisplay, currentChildName);
                    emailBody = fallback.email;
                    smsOptions = fallback.sms;
                    cdTools = fallback.cdTools;
                }

                const timestamp = new Date().toLocaleString();

                // Conditional Child line - ONLY if more than one child
                const childLine = (numChildren > 1) ? `Child: ${currentChildName}\n` : '';

                const message =
                    `Location: Code Ninjas ${centerLocation}
Submitted: ${timestamp}
${childLine}
--------------------
Internal Notes:
Persona Label: ${persona}
Recommended Program: ${programDisplay}
Marketing Source: ${marketingSource || 'N/A'}
${marketingSubsource || 'N/A'}

--------------------
INTERNAL SALES GUIDANCE (CD TOOLS):
${cdTools}

--------------------
AI-Generated Parent Email:
${emailBody}

--------------------
AI-Generated SMS Options (choose one to text the parent):
SMS 1 (Send Day After):
${smsOptions[0] || ''}

SMS 2 (Send 3 Days Later):
${smsOptions[1] || ''}`;

                // Submit to both Web3Forms (email) and Monday.com (dashboard - no names)
                submitToWeb3Forms(message);

                // Submit to Monday.com (anonymous data only, runs in parallel)
                submitToMonday({
                    centerLocation: centerLocation,
                    numChildren: numChildren,
                    programDisplay: programDisplay,
                    persona: persona,
                    personaBlurb: personaBlurb,
                    qaSummary: qaSummary,
                    emailBody: emailBody,
                    smsOptions: smsOptions,
                    marketingSource: marketingSource || 'N/A',
                    marketingSubsource: marketingSubsource || ''
                });

                // Show result to parent after Gemini & submit complete
                stopLoading();
                wizard.classList.add('hidden');
                result.style.display = 'block';

                // Logic for Next Child button
                if (numChildren > 1 && currentChildIndex < numChildren - 1) {
                    nextChildBtn.style.display = 'block';
                    nextChildBtn.textContent = t("Start Quiz for") + ` ${childNames[currentChildIndex + 1].name} ‚ñ∂`;
                    retakeBtn.style.display = 'none'; // Hide home button until done
                } else {
                    nextChildBtn.style.display = 'none';
                    retakeBtn.style.display = 'block'; // Show home button
                }

                // Re-translate page to catch new dynamic content (Persona, Recs, etc. if we had them in dict)
                // and static text in the result view
                translatePage();

                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            // ---------- BACK TO HOME ----------
            $('#retakeBtn').addEventListener('click', () => { window.location.reload(); });
        })();
    </script>
    <!-- --- SERVICE WORKER REGISTRATION START --- -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((reg) => console.log('Service Worker registered!', reg))
                    .catch((err) => console.log('Service Worker registration failed:', err));
            });
        }
    </script>
    <!-- --- SERVICE WORKER REGISTRATION END --- -->
</body>

</html>